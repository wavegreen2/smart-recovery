<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Recovery Simulator (Custom Data)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .card { border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .log-container { height: 400px; overflow-y: auto; background: #212529; color: #00ff00; font-family: monospace; padding: 15px; font-size: 13px; }
        .stat-card { text-align: center; padding: 15px; border-radius: 10px; color: white; }
        textarea { font-family: monospace; font-size: 12px; height: 150px !important; }
    </style>
</head>
<body>

<div class="container py-5">
    <h2 class="text-center mb-4">üé∞ Smart Recovery (Manual Data Mode)</h2>
    
    <div class="row g-4">
        <div class="col-md-4">
            <div class="card p-4">
                <h5 class="mb-3">Config & Data</h5>
                <div class="mb-3">
                    <label class="form-label">Paste Shoe Data (CSV format)</label>
                    <textarea id="raw_data" class="form-control" placeholder="1,P,B,T,P...&#10;2,B,B,P,P...">1,B,T,P,B,B,B,P,P,P,T,P,P,P,P,T,B,P,P,B,P,P,B,B,P,P,B,P,B,P,T,B,T,B,P,P,T,B,P,P,B,P,P,T,P,P,P,P,P,B,P,B,B,P,B,B,P,B,B,P,B,B,B,B,P,B,P,B,P,T,P,B,B,B,P,B,B,P,P,P
2,T,P,B,P,B,B,P,P,B,B,T,P,B,B,T,P,P,B,B,B,B,P,T,B,T,B,B,B,P,P,B,P,P,P,B,P,B,P,T,B,P,B,P,B,B,B,B,P,B,B,B,P,P,P,B,T,B,P,B,B,P,B,B,P,B,P,P,B,B,P,P,P,B,B,P,B,P,P,P,P,T</textarea>
                </div>
                <div class="row">
                    <div class="col-6 mb-2">
                        <label class="form-label">Unit Size</label>
                        <input type="number" id="unit_size" class="form-control" value="10">
                    </div>
                    <div class="col-6 mb-2">
                        <label class="form-label">Virtual Trigger</label>
                        <input type="number" id="virtual_trigger" class="form-control" value="2">
                    </div>
                </div>
                <button onclick="startSimulation()" class="btn btn-primary w-100 mt-3" id="runBtn">Run Data Simulation</button>
            </div>
        </div>

        <div class="col-md-8">
            <div class="row g-3 mb-4">
                <div class="col-4">
                    <div class="stat-card bg-dark">
                        <small>Total Hands Played</small>
                        <h4 id="stat_total_hands">0</h4>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-card bg-danger">
                        <small>Max Consecutive Busts</small>
                        <h4 id="stat_busts">0</h4>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-card bg-success">
                        <small>Final Profit</small>
                        <h4 id="stat_profit">0</h4>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span>Live Simulation Log</span>
                    <small id="current_state_label" class="text-muted">Idle</small>
                </div>
                <div id="log" class="log-container">
                    Waiting for data...
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let globalResults = [];

function parseInputData() {
    const text = document.getElementById('raw_data').value;
    const lines = text.split('\n');
    let results = [];
    lines.forEach(line => {
        const parts = line.split(',');
        // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç Shoe ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
        for(let i = 1; i < parts.length; i++) {
            let res = parts[i].trim().toUpperCase();
            if (res === 'P' || res === 'B' || res === 'T') {
                results.push(res);
            }
        }
    });
    return results;
}

function getFibo(n) {
    if (n <= 0) return 1;
    if (n === 1) return 1;
    let a = 1, b = 1;
    for (let i = 2; i <= n; i++) {
        let temp = a + b; a = b; b = temp;
    }
    return b;
}

async function startSimulation() {
    const logEl = document.getElementById('log');
    const runBtn = document.getElementById('runBtn');
    const data = parseInputData();
    
    if (data.length === 0) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        return;
    }

    logEl.innerHTML = `Loaded ${data.length} hands. Starting simulation...<br>---<br>`;
    runBtn.disabled = true;

    // Config
    let config = {
        virtual_trigger: parseInt(document.getElementById('virtual_trigger').value),
        unit_size: parseFloat(document.getElementById('unit_size').value),
        marty_mult: 2,
        initial_bankroll: 5000, // ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏¢‡∏≠‡∏∞‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
        target_per_win: 10
    };

    let bankroll = 0; // Cumulative Profit
    let virtual_losses = 0;
    let state = "FLAT";
    let marty_step = 0;
    let fibo_idx = 0;
    let current_session_loss = 0;
    let max_busts = 0;
    let current_consecutive_busts = 0;
    
    for (let i = 0; i < data.length; i++) {
        let handResult = data[i];
        let is_virtual = virtual_losses < config.virtual_trigger;
        
        // ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Tie (‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏∏‡∏ô)
        if (handResult === 'T') {
            logEl.innerHTML += `<span style="color:yellow">Hand ${i+1}: [TIE] - Skip</span><br>`;
            continue;
        }

        // Betting Logic
        let bet = config.unit_size;
        if (state === "MARTY") {
            bet = config.unit_size * Math.pow(config.marty_mult, marty_step);
        } else if (state === "FIBO") {
            bet = getFibo(fibo_idx) * config.unit_size;
        }

        // Simulation result
        // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÅ‡∏ó‡∏á Player ‡πÄ‡∏™‡∏°‡∏≠ (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏™‡∏•‡∏±‡∏ö‡∏ù‡∏±‡πà‡∏á‡∏ï‡∏≤‡∏°‡πÉ‡∏à‡∏ä‡∏≠‡∏ö ‡πÅ‡∏ï‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÄ‡∏ô‡πâ‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏á‡∏¥‡∏ô)
        let is_win = (handResult === 'P'); 
        
        let prefix = is_virtual ? `<span style="color:gray">[VIRT]</span>` : `<span style="color:white">[REAL]</span>`;
        
        if (is_win) {
            if (!is_virtual) bankroll += bet;
            
            logEl.innerHTML += `${prefix} Hand ${i+1}: WIN (Bet: ${bet})<br>`;
            
            // Success Recovery
            state = "FLAT";
            marty_step = 0;
            fibo_idx = 0;
            virtual_losses = 0; // Reset virtual count
            current_consecutive_busts = 0;
        } else {
            if (!is_virtual) bankroll -= bet;
            
            logEl.innerHTML += `${prefix} Hand ${i+1}: <span style="color:#ff4444">LOSS</span> (Bet: ${bet})<br>`;
            
            if (is_virtual) {
                virtual_losses++;
            } else {
                // Real Logic Recovery
                if (state === "FLAT") {
                    state = "MARTY";
                    marty_step = 1;
                } else if (state === "MARTY") {
                    marty_step++;
                    if (marty_step > 8) { // ‡πÅ‡∏ï‡∏Å‡∏ó‡∏µ‡πà 8 ‡πÑ‡∏°‡πâ
                        state = "FIBO";
                        fibo_idx = 0;
                        current_consecutive_busts++;
                        max_busts = Math.max(max_busts, current_consecutive_busts);
                    }
                } else {
                    fibo_idx++;
                }
            }
        }

        // Update UI
        document.getElementById('stat_total_hands').innerText = i + 1;
        document.getElementById('stat_profit').innerText = bankroll.toLocaleString();
        document.getElementById('stat_busts').innerText = max_busts;
        
        logEl.scrollTop = logEl.scrollHeight;
        if (i % 20 === 0) await new Promise(r => setTimeout(r, 10));
    }

    logEl.innerHTML += "--- END OF DATA ---<br>";
    runBtn.disabled = false;
}
</script>
</body>
</html>
