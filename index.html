<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baccarat Recovery Dashboard v2</title>
    <style>
        :root { --p-color: #007bff; --b-color: #dc3545; --t-color: #28a745; --bg-dark: #121212; --card-bg: #1e1e1e; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg-dark); color: #fff; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .header-stats { display: flex; gap: 10px; padding: 10px; background: #000; border-bottom: 1px solid #333; }
        .stat-item { flex: 1; background: var(--card-bg); padding: 8px; border-radius: 5px; text-align: center; border: 1px solid #444; }
        .stat-label { font-size: 0.7rem; color: #888; display: block; }
        .stat-value { font-size: 1.1rem; font-weight: bold; }

        .main-content { display: grid; grid-template-columns: 280px 1fr; flex: 1; overflow: hidden; }
        
        .sidebar { background: #181818; padding: 15px; border-right: 1px solid #333; overflow-y: auto; }
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; color: #bbb; margin-bottom: 3px; }
        input, select, textarea { width: 100%; padding: 8px; background: #2a2a2a; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; margin-bottom: 8px; }
        textarea { height: 60px; font-size: 10px; font-family: monospace; resize: none; }
        
        .btn { width: 100%; padding: 10px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-bottom: 5px; }
        .btn-start { background: #28a745; color: white; }
        .btn-undo { background: #6c757d; color: white; font-size: 0.8rem; }
        .btn-manual { flex: 1; height: 45px; color: white; border-radius: 4px; font-size: 1.1rem; }

        .road-section { background: #000; border-bottom: 1px solid #333; padding: 10px; overflow-x: auto; }
        .road-container { display: grid; grid-template-columns: repeat(120, 22px); grid-template-rows: repeat(6, 22px); gap: 1px; background: #333; width: fit-content; }
        .road-cell { background: #fff; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
        .cell-P { color: var(--p-color); } .cell-B { color: var(--b-color); } 
        .cell-T { color: var(--t-color); border: 1px solid var(--t-color); border-radius: 50%; width: 16px; height: 16px; }

        .table-area { flex: 1; overflow-y: auto; padding: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background: #252525; position: sticky; top: 0; padding: 8px; text-align: left; color: #888; border-bottom: 2px solid #333; }
        td { padding: 8px; border-bottom: 1px solid #2a2a2a; }
        .win-row { background: rgba(46, 204, 113, 0.05); color: #2ecc71; }
        .loss-row { background: rgba(231, 76, 60, 0.05); color: #e74c3c; }
        .profit-plus { color: #2ecc71; } .profit-minus { color: #ff4444; }
    </style>
</head>
<body>

<div class="header-stats">
    <div class="stat-item"><span class="stat-label">REAL NET PROFIT</span><span id="stat_profit" class="stat-value">0.00</span></div>
    <div class="stat-item"><span class="stat-label">COMMISSION (1%)</span><span id="stat_comm" class="stat-value">0.00</span></div>
    <div class="stat-item"><span class="stat-label">MAX BET</span><span id="stat_max_bet" class="stat-value">0</span></div>
    <div class="stat-item"><span class="stat-label">SESSION</span><span id="stat_session" class="stat-value">1</span></div>
</div>

<div class="main-content">
    <div class="sidebar">
        <div class="control-group">
            <label>โหมด (Mode)</label>
            <select id="mode" onchange="toggleMode()">
                <option value="m">Manual Input (กดมือ)</option>
                <option value="r">Random (สุ่ม)</option>
                <option value="s">Data String (ข้อมูลดิบ)</option>
            </select>
        </div>
        
        <div id="string_box" class="control-group" style="display:none;">
            <label>Data String (P,B,T...)</label>
            <textarea id="data_string" placeholder="P,B,B,P,T,P..."></textarea>
        </div>

        <div class="control-group">
            <label>เดิมพันขั้นต่ำ (Min Bet)</label>
            <input type="number" id="unit_size" value="5.0">
            <label>ชิปขั้นต่ำ (Min Chip)</label>
            <input type="number" id="chip_size" value="5.0">
            <label>Stop Loss Threshold</label>
            <input type="number" id="stop_loss" value="75000">
        </div>

        <button class="btn btn-start" onclick="startSystem()">START SYSTEM</button>
        <button class="btn btn-undo" onclick="undoLastHand()">↩ ย้อนกลับ (Undo)</button>

        <div id="manual_ctrl" style="margin-top: 15px;">
            <label>บันทึกผลมือต่อมือ</label>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-manual" style="background:var(--p-color)" onclick="inputResult('P')">P</button>
                <button class="btn btn-manual" style="background:var(--b-color)" onclick="inputResult('B')">B</button>
                <button class="btn btn-manual" style="background:var(--t-color)" onclick="inputResult('T')">T</button>
            </div>
        </div>
    </div>

    <div style="display: flex; flex-direction: column; overflow: hidden;">
        <div class="road-section" id="road_wrapper">
            <div class="road-container" id="big_road"></div>
        </div>

        <div class="table-area">
            <table>
                <thead>
                    <tr>
                        <th>Hand #</th>
                        <th>Type</th>
                        <th>Result</th>
                        <th>Bet Amount</th>
                        <th>Outcome</th>
                        <th>Balance</th>
                        <th>Net Profit</th>
                    </tr>
                </thead>
                <tbody id="history_body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let app = {
        active: false,
        br: 500000.0,
        initialBr: 500000.0,
        netProfit: 0,
        totalComm: 0,
        maxBet: 0,
        handCount: 0,
        sessionIdx: 1,
        fullHistory: [], // Full log for Undo
        roadHistory: [], // Result history for Road
        
        state: "FLAT",
        martyStep: 0,
        peak: 500000.0,
        lossSincePeak: false,
        vLossCount: 0,
        accumulatedLoss: 0,
        targetProfit: 0.01
    };

    function startSystem() {
        app.active = true;
        app.netProfit = 0;
        app.totalComm = 0;
        app.fullHistory = [];
        app.roadHistory = [];
        app.handCount = 0;
        app.sessionIdx = 1;
        document.getElementById('history_body').innerHTML = "";
        resetSession();
        
        if (document.getElementById('mode').value === 's') {
            processDataString();
        } else if (document.getElementById('mode').value === 'r') {
            runRandomLoop();
        }
        updateUI();
    }

    function resetSession() {
        app.br = 500000.0;
        app.peak = 500000.0;
        app.state = "FLAT";
        app.martyStep = 0;
        app.lossSincePeak = false;
    }

    function calculateBet() {
        const minBet = parseFloat(document.getElementById('unit_size').value);
        const minChip = parseFloat(document.getElementById('chip_size').value);
        const stopLoss = parseFloat(document.getElementById('stop_loss').value);
        
        let drawdown = app.peak - app.br;
        let bet = minBet;

        if (app.state === "FLAT") {
            bet = (drawdown > 0 && app.lossSincePeak) ? Math.max(Math.ceil(drawdown / 4), minBet) : minBet;
        } else if (app.state === "MARTY") {
            bet = minBet * Math.pow(2, app.martyStep);
        }

        let needed = drawdown + minBet;
        if (app.state !== "FLAT") bet = Math.min(bet, needed);
        if (bet > stopLoss) bet = stopLoss;

        return Math.ceil(bet / minChip) * minChip;
    }

    function inputResult(res) {
        if (!app.active) return;
        
        const bet = calculateBet();
        const sidePref = "PLAYER"; // Fixed side
        const win = (res === 'P' && sidePref === 'PLAYER') || (res === 'B' && sidePref === 'BANKER');
        const comm = bet * 0.01;
        const vTrigger = 5; 
        const isVirtual = app.vLossCount < vTrigger;

        // Store snapshot for Undo
        const snapshot = JSON.parse(JSON.stringify({
            br: app.br, netProfit: app.netProfit, totalComm: app.totalComm,
            handCount: app.handCount, state: app.state, martyStep: app.martyStep,
            peak: app.peak, lossSincePeak: app.lossSincePeak, vLossCount: app.vLossCount,
            accumulatedLoss: app.accumulatedLoss, targetProfit: app.targetProfit,
            sessionIdx: app.sessionIdx
        }));

        app.handCount++;
        app.totalComm += comm;
        app.br += comm;
        if(!isVirtual) app.netProfit += comm;

        let outcome = 0;
        if (res !== 'T') {
            if (win) {
                outcome = (sidePref === 'BANKER' ? bet * 0.95 : bet);
                app.br += outcome;
                if(!isVirtual) app.netProfit += outcome;
                app.state = "FLAT"; app.martyStep = 0;
                if (app.br >= app.peak) app.lossSincePeak = false;
            } else {
                outcome = -bet;
                app.br += outcome;
                if(!isVirtual) app.netProfit += outcome;
                app.lossSincePeak = true;
                if (app.state === "FLAT") { app.state = "MARTY"; app.martyStep = 1; }
                else { app.martyStep++; }
            }
            app.roadHistory.push(res);
        }

        if (app.br > app.peak) app.peak = app.br;
        if (bet > app.maxBet) app.maxBet = bet;

        app.fullHistory.push({ snapshot, res, bet, outcome, isVirtual });
        addTableRow(app.handCount, isVirtual ? "VIRTUAL" : "REAL", res, bet, outcome, app.br, app.netProfit);

        // Session Control
        let sessionP = app.br - 500000.0;
        let stopLossLimit = parseFloat(document.getElementById('stop_loss').value);

        if (app.br <= (500000 - stopLossLimit) || sessionP >= app.targetProfit) {
            if (isVirtual) {
                if (sessionP < 0) app.vLossCount++; else app.vLossCount = 0;
            } else {
                app.sessionIdx++;
                if (sessionP >= app.targetProfit) {
                    app.accumulatedLoss = 0; app.targetProfit = 0.01; app.vLossCount = 0;
                } else {
                    app.accumulatedLoss += Math.abs(sessionP);
                    app.targetProfit = app.accumulatedLoss + 0.01;
                }
            }
            resetSession();
        }

        renderRoad();
        updateUI();
    }

    function undoLastHand() {
        if (app.fullHistory.length === 0) return;
        const last = app.fullHistory.pop();
        
        // Restore snapshot
        Object.assign(app, last.snapshot);
        if (last.res !== 'T') app.roadHistory.pop();
        
        // Update Table
        document.getElementById('history_body').deleteRow(0);
        
        renderRoad();
        updateUI();
    }

    function addTableRow(id, type, res, bet, outcome, balance, net) {
        const body = document.getElementById('history_body');
        const row = body.insertRow(0);
        row.className = outcome > 0 ? "win-row" : (outcome < 0 ? "loss-row" : "");
        row.innerHTML = `
            <td>${id}</td>
            <td>${type}</td>
            <td>${res}</td>
            <td>${bet.toLocaleString()}</td>
            <td>${outcome > 0 ? '+' : ''}${outcome.toLocaleString()}</td>
            <td>${balance.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
            <td class="${net >= 0 ? 'profit-plus' : 'profit-minus'}">${net.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
        `;
    }

    function renderRoad() {
        const container = document.getElementById('big_road');
        container.innerHTML = '';
        let matrix = Array(6).fill().map(() => Array(120).fill(null));
        let col = 0, row = 0, lastRes = '';

        app.roadHistory.forEach(res => {
            if (res !== lastRes && lastRes !== '') {
                col++; row = 0;
                while(matrix[0][col] !== null) col++;
            }
            let tRow = row, tCol = col;
            if (tRow >= 6 || matrix[tRow][tCol] !== null) {
                tRow = row - 1; tCol = col + 1;
                while(matrix[tRow][tCol] !== null) tCol++;
                matrix[tRow][tCol] = res;
                col = tCol;
            } else {
                matrix[tRow][tCol] = res;
                row++;
            }
            lastRes = res;
        });

        for (let r = 0; r < 6; r++) {
            for (let c = 0; c < 120; c++) {
                const cell = document.createElement('div');
                cell.className = 'road-cell';
                if (matrix[r][c]) {
                    cell.innerText = matrix[r][c];
                    cell.className += ' cell-' + matrix[r][c];
                }
                container.appendChild(cell);
            }
        }
        // Auto-scroll only when data exists
        if(app.roadHistory.length > 0) {
            document.getElementById('road_wrapper').scrollLeft = (col - 10) * 22;
        }
    }

    function updateUI() {
        document.getElementById('stat_profit').innerText = app.netProfit.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('stat_profit').className = 'stat-value ' + (app.netProfit >= 0 ? 'profit-plus' : 'profit-minus');
        document.getElementById('stat_comm').innerText = app.totalComm.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('stat_max_bet').innerText = app.maxBet.toLocaleString();
        document.getElementById('stat_session').innerText = app.sessionIdx;
    }

    function toggleMode() {
        const m = document.getElementById('mode').value;
        document.getElementById('manual_ctrl').style.display = (m === 'm' ? 'block' : 'none');
        document.getElementById('string_box').style.display = (m === 's' ? 'block' : 'none');
    }

    function processDataString() {
        const str = document.getElementById('data_string').value;
        const arr = str.split(/[, \n]+/).map(s => s.trim().toUpperCase()).filter(s => ['P','B','T'].includes(s));
        arr.forEach(res => inputResult(res));
    }

    async function runRandomLoop() {
        while(app.active && document.getElementById('mode').value === 'r') {
            inputResult(Math.random() > 0.5 ? 'P' : 'B');
            await new Promise(r => setTimeout(r, 400));
        }
    }
</script>

</body>
</html>
