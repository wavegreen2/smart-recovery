<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baccarat Recovery Simulation</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #1a73e8; border-bottom: 2px solid #e8f0fe; padding-bottom: 10px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .config-group { border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        input, select, textarea { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .controls { text-align: center; margin: 20px 0; }
        button { padding: 12px 30px; font-size: 16px; cursor: pointer; border: none; border-radius: 6px; transition: 0.3s; }
        .btn-start { background: #28a745; color: white; }
        .btn-start:hover { background: #218838; }
        .btn-manual { background: #17a2b8; color: white; margin: 5px; }
        #log { background: #1e1e1e; color: #d4d4d4; padding: 15px; height: 300px; overflow-y: scroll; border-radius: 6px; font-family: monospace; font-size: 12px; line-height: 1.5; }
        .summary { margin-top: 20px; padding: 15px; background: #e8f0fe; border-radius: 8px; }
        .manual-input-area { display: none; margin-top: 15px; padding: 15px; border: 2px dashed #17a2b8; border-radius: 10px; text-align: center; }
        .win { color: #4ade80; }
        .loss { color: #f87171; }
        .info { color: #60a5fa; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ“Š Baccarat Strategy Simulator</h2>
    
    <div class="grid">
        <div class="config-group">
            <label>Mode</label>
            <select id="mode" onchange="toggleModeInput()">
                <option value="a">Auto (Data list)</option>
                <option value="r">Random Simulation</option>
                <option value="m">Manual (Input hand by hand)</option>
            </select>

            <label>Side Preference</label>
            <select id="side_preference">
                <option value="PLAYER">PLAYER</option>
                <option value="BANKER">BANKER</option>
            </select>

            <label>Virtual Loss Trigger (Wait for X Busts)</label>
            <input type="number" id="v_trigger" value="2">
        </div>

        <div class="config-group">
            <label>Initial Unit Size</label>
            <input type="number" id="unit_size" value="10">
            <label>Marty Multiplier</label>
            <input type="number" id="marty_mult" value="2">
            <label>Rebate Rate (%)</label>
            <input type="number" id="rebate_rate" value="1" step="0.1">
        </div>
    </div>

    <div id="auto_data_area">
        <label>Raw Data (CSV Format: ID, Result, Result...)</label>
        <textarea id="raw_data" rows="4">1,B,T,P,B,B,B,P,P,P,T,P,P,P,P,T,B,P,P,B,P,P,B,B,P,P,B,P,B,P,T,B,T,B,P,P,T,B,P,P,B,P,P,T,P,P,P,P,P,B,P,B,B,P,B,B,P,B,B,P,B,B,B,B,P,B,P,B,P,T,P,B,B,B,P,B,B,P,P,P</textarea>
    </div>

    <div class="controls">
        <button class="btn-start" id="startBtn" onclick="startSimulation()">Start Simulation</button>
    </div>

    <div id="manual_controls" class="manual-input-area">
        <h3>Manual Input: Hand <span id="hand_count">1</span></h3>
        <p>Current Bet: <strong id="current_bet_display">0</strong></p>
        <button class="btn-manual" onclick="handleManual('P')">P</button>
        <button class="btn-manual" onclick="handleManual('B')">B</button>
        <button class="btn-manual" onclick="handleManual('T')">T</button>
        <button class="btn-manual" style="background:#6c757d" onclick="stopManual()">Stop / Summary</button>
    </div>

    <div id="log"></div>

    <div class="summary" id="summary_report">
        <strong>Summary:</strong> Waiting for run...
    </div>
</div>

<script>
    // --- Global Logic State ---
    let simulationActive = false;
    let config = {};
    let sessionState = {
        totalRealSessions: 0,
        totalLossAccumulated: 0,
        currentBankroll: 20,
        currentTarget: 0.01,
        maxConsecutiveBusts: 0,
        currentConsecutiveBusts: 0,
        overallMaxBet: 0,
        overallMaxDrawdown: 0,
        consecutiveVirtualLosses: 0,
        currentDataIdx: 0,
        fullResults: []
    };

    function log(msg, className = "") {
        const logDiv = document.getElementById('log');
        logDiv.innerHTML += `<div class="${className}">${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function getFibo(n) {
        if (n <= 0) return 1;
        if (n === 1) return 1;
        let a = 1, b = 1;
        for (let i = 2; i <= n; i++) {
            let temp = b;
            b = a + b;
            a = temp;
        }
        return b;
    }

    function toggleModeInput() {
        const mode = document.getElementById('mode').value;
        document.getElementById('auto_data_area').style.display = (mode === 'a') ? 'block' : 'none';
        document.getElementById('manual_controls').style.display = 'none';
    }

    // --- Simulation Logic ---
    async function runSingleSession(isVirtual) {
        let bankroll = sessionState.currentBankroll;
        let initialBR = bankroll;
        let peakBR = bankroll;
        let maxBet = 0;
        let maxDD = 0;
        
        let state = "FLAT";
        let martyStep = 0;
        let fiboIdx = 0;
        let martyLimit = 12;
        let hasLostSincePeak = false;

        while (true) {
            let currentDD = peakBR - bankroll;
            if (currentDD >= config.stopLoss) {
                state = "FLAT"; martyStep = 0; fiboIdx = 0;
            }

            let rawBet = 0;
            if (state === "FLAT") {
                if (currentDD > 0 && hasLostSincePeak) {
                    rawBet = Math.max(Math.ceil(currentDD / 4), config.unitSize);
                } else {
                    rawBet = config.unitSize;
                }
            } else if (state === "MARTY") {
                rawBet = config.unitSize * Math.pow(config.martyMult, martyStep);
            } else if (state === "FIBO") {
                rawBet = getFibo(fiboIdx) * 1000000000000000; // à¸•à¸²à¸¡à¸„à¹ˆà¸² Python à¹€à¸”à¸´à¸¡à¸—à¸µà¹ˆà¸ªà¸¹à¸‡à¸¡à¸²à¸
            }

            let needed = currentDD + config.unitSize;
            let bet = (state !== "FLAT") ? Math.min(rawBet, needed) : rawBet;

            // Cap at Stop Loss
            let isMaxBetActive = false;
            if (bet >= config.stopLoss) {
                bet = config.stopLoss;
                isMaxBetActive = true;
            }

            // Cap at Target
            let currentProfit = bankroll - initialBR;
            let remaining = sessionState.currentTarget - currentProfit;
            if (bet > remaining && remaining > 0) {
                bet = Math.max(config.unitSize, remaining);
            }

            maxBet = Math.max(maxBet, bet);

            // Get Result
            let result = "";
            if (config.mode === 'a') {
                if (sessionState.currentDataIdx >= sessionState.fullResults.length) return { status: "OUT_OF_DATA", profit: bankroll - initialBR, mdd: maxDD, mBet: maxBet };
                result = sessionState.fullResults[sessionState.currentDataIdx++];
            } else if (config.mode === 'r') {
                if (sessionState.currentDataIdx >= 10000000) return { status: "OUT_OF_DATA", profit: bankroll - initialBR, mdd: maxDD, mBet: maxBet };
                result = (Math.random() * 100 <= 50.68) ? "B" : "P";
                sessionState.currentDataIdx++;
            } else if (config.mode === 'm') {
                // Manual logic is handled via events
                return { bet, state, martyStep, fiboIdx, bankroll, peakBR, initialBR, maxBet, maxDD, hasLostSincePeak };
            }

            if (result === "T") continue;

            // Process Win/Loss
            let isWin = (result === "P" && config.side === "PLAYER") || (result === "B" && config.side === "BANKER");
            let payout = (config.side === "BANKER") ? 0.95 : 1.0;
            bankroll += (bet * config.rebate);

            if (isWin) {
                bankroll += (bet * payout);
                if (state === "FIBO") {
                    fiboIdx = Math.max(-1, fiboIdx - 2);
                    if (fiboIdx < 0) { state = "FLAT"; fiboIdx = 0; }
                } else {
                    if (bankroll >= peakBR) hasLostSincePeak = false;
                    state = "FLAT"; martyStep = 0;
                }
            } else {
                bankroll -= bet;
                hasLostSincePeak = true;
                if (isMaxBetActive) {
                    state = "FLAT"; martyStep = 0; fiboIdx = 0;
                } else {
                    if (state === "FLAT") { state = "MARTY"; martyStep = 1; }
                    else if (state === "MARTY") {
                        martyStep++;
                        if (martyStep > martyLimit) { state = "FIBO"; fiboIdx = 0; }
                    } else if (state === "FIBO") {
                        fiboIdx++;
                    }
                }
            }

            peakBR = Math.max(peakBR, bankroll);
            maxDD = Math.max(maxDD, peakBR - bankroll);

            if (bankroll <= 0) return { status: "BUST", profit: bankroll - initialBR, mdd: maxDD, mBet: maxBet };
            if ((bankroll - initialBR) >= sessionState.currentTarget) return { status: "WIN", profit: bankroll - initialBR, mdd: maxDD, mBet: maxBet };
        }
    }

    // --- Main Controller ---
    async function startSimulation() {
        if (simulationActive) return;
        
        // Setup Config
        config = {
            mode: document.getElementById('mode').value,
            side: document.getElementById('side_preference').value,
            vTrigger: parseInt(document.getElementById('v_trigger').value),
            unitSize: parseFloat(document.getElementById('unit_size').value),
            martyMult: parseFloat(document.getElementById('marty_mult').value),
            rebate: parseFloat(document.getElementById('rebate_rate').value) / 100,
            stopLoss: 1000000000000000 // à¸•à¸²à¸¡ Python
        };

        // Reset Session
        document.getElementById('log').innerHTML = "";
        sessionState = { ...sessionState, totalRealSessions: 0, totalLossAccumulated: 0, currentBankroll: config.unitSize * 2, currentTarget: 0.1, maxConsecutiveBusts: 0, currentConsecutiveBusts: 0, consecutiveVirtualLosses: 0, currentDataIdx: 0, overallMaxBet: 0, overallMaxDrawdown: 0 };

        if (config.mode === 'a') {
            const raw = document.getElementById('raw_data').value;
            sessionState.fullResults = raw.split('\n').flatMap(line => line.split(',').slice(1).map(s => s.trim()));
        }

        if (config.mode === 'm') {
            setupManualMode();
            return;
        }

        simulationActive = true;
        while (sessionState.totalRealSessions < 10) { // à¸ˆà¸³à¸à¸±à¸” 10 real sessions à¸•à¸²à¸¡à¹‚à¸ˆà¸—à¸¢à¹Œà¹‚à¸«à¸¡à¸” random
            let isVirtual = sessionState.consecutiveVirtualLosses < config.vTrigger;
            
            log(isVirtual ? `--- ðŸ§ª VIRTUAL SESSION (${sessionState.consecutiveVirtualLosses}/${config.vTrigger}) ---` : `--- ðŸ’° REAL SESSION ${sessionState.totalRealSessions + 1} ---`, isVirtual ? "info" : "");

            let res = await runSingleSession(isVirtual);
            
            if (res.status === "OUT_OF_DATA") break;

            if (isVirtual) {
                if (res.status === "BUST") {
                    sessionState.consecutiveVirtualLosses++;
                    log(`ðŸ“‰ Virtual Result: BUST`);
                } else {
                    sessionState.consecutiveVirtualLosses = 0;
                    log(`ðŸ”„ Virtual Result: WIN (Reset)`);
                }
            } else {
                sessionState.totalRealSessions++;
                sessionState.overallMaxBet = Math.max(sessionState.overallMaxBet, res.mBet);
                sessionState.overallMaxDrawdown = Math.max(sessionState.overallMaxDrawdown, res.mdd);

                if (res.status === "WIN") {
                    log(`âœ… REAL WIN: Profit +${res.profit.toFixed(2)}`, "win");
                    sessionState.totalLossAccumulated = 0;
                    sessionState.currentTarget = 0.1; // Base target
                    sessionState.currentBankroll = 20;
                    sessionState.consecutiveVirtualLosses = 0;
                    sessionState.currentConsecutiveBusts = 0;
                } else {
                    log(`âŒ REAL BUST: Loss ${res.profit.toFixed(2)}`, "loss");
                    sessionState.totalLossAccumulated += Math.abs(res.profit);
                    sessionState.currentTarget = sessionState.totalLossAccumulated + 0.1;
                    sessionState.currentBankroll = sessionState.currentTarget * 1.5;
                    sessionState.currentConsecutiveBusts++;
                    sessionState.maxConsecutiveBusts = Math.max(sessionState.maxConsecutiveBusts, sessionState.currentConsecutiveBusts);
                    log(`âš ï¸ RECOVERY | Accumulated Loss: ${sessionState.totalLossAccumulated.toFixed(2)}`);
                }
            }
            if (config.mode === 'r' && sessionState.totalRealSessions >= 10) break;
        }
        showSummary();
        simulationActive = false;
    }

    // --- Manual Mode Handling ---
    let manualCtx = {};
    function setupManualMode() {
        document.getElementById('manual_controls').style.display = 'block';
        document.getElementById('startBtn').disabled = true;
        manualCtx = {
            bankroll: 20, initialBR: 20, peakBR: 20,
            state: "FLAT", martyStep: 0, fiboIdx: 0,
            maxBet: 0, maxDD: 0, hasLostSincePeak: false,
            hand: 1
        };
        updateManualUI();
    }

    function updateManualUI() {
        // Calculate bet logic for display
        let currentDD = manualCtx.peakBR - manualCtx.bankroll;
        let rawBet = 0;
        if (manualCtx.state === "FLAT") {
            rawBet = (currentDD > 0 && manualCtx.hasLostSincePeak) ? Math.max(Math.ceil(currentDD / 4), config.unitSize) : config.unitSize;
        } else if (manualCtx.state === "MARTY") {
            rawBet = config.unitSize * Math.pow(config.martyMult, manualCtx.martyStep);
        }
        
        let remaining = sessionState.currentTarget - (manualCtx.bankroll - manualCtx.initialBR);
        let bet = Math.min(rawBet, currentDD + config.unitSize);
        if (bet > remaining && remaining > 0) bet = Math.max(config.unitSize, remaining);

        manualCtx.currentBet = bet;
        document.getElementById('hand_count').innerText = manualCtx.hand;
        document.getElementById('current_bet_display').innerText = bet.toLocaleString(undefined, {minimumFractionDigits: 2});
    }

    function handleManual(result) {
        if (result === 'T') {
            log(`[Hand ${manualCtx.hand}] TIE - Skip`);
            return;
        }

        let isWin = (result === 'P' && config.side === 'PLAYER') || (result === 'B' && config.side === 'BANKER');
        let payout = (config.side === 'BANKER') ? 0.95 : 1.0;
        let bet = manualCtx.currentBet;

        manualCtx.bankroll += (bet * config.rebate);
        if (isWin) {
            manualCtx.bankroll += (bet * payout);
            log(`[Hand ${manualCtx.hand}] Bet: ${bet.toFixed(2)} | âœ… WIN | BR: ${manualCtx.bankroll.toFixed(2)}`, "win");
            manualCtx.state = "FLAT"; manualCtx.martyStep = 0;
            if (manualCtx.bankroll >= manualCtx.peakBR) manualCtx.hasLostSincePeak = false;
        } else {
            manualCtx.bankroll -= bet;
            manualCtx.hasLostSincePeak = true;
            log(`[Hand ${manualCtx.hand}] Bet: ${bet.toFixed(2)} | âŒ LOSS | BR: ${manualCtx.bankroll.toFixed(2)}`, "loss");
            if (manualCtx.state === "FLAT") { manualCtx.state = "MARTY"; manualCtx.martyStep = 1; }
            else { manualCtx.martyStep++; }
        }

        manualCtx.peakBR = Math.max(manualCtx.peakBR, manualCtx.bankroll);
        manualCtx.maxDD = Math.max(manualCtx.maxDD, manualCtx.peakBR - manualCtx.bankroll);
        manualCtx.maxBet = Math.max(manualCtx.maxBet, bet);
        manualCtx.hand++;

        let profit = manualCtx.bankroll - manualCtx.initialBR;
        if (profit >= sessionState.currentTarget || manualCtx.bankroll <= 0) {
            log(`Session Ended. Status: ${profit > 0 ? 'WIN' : 'BUST'}`);
            stopManual();
        } else {
            updateManualUI();
        }
    }

    function stopManual() {
        document.getElementById('manual_controls').style.display = 'none';
        document.getElementById('startBtn').disabled = false;
        showSummary();
    }

    function showSummary() {
        document.getElementById('summary_report').innerHTML = `
            <strong> ðŸ“Š SUMMARY REPORT</strong><br>
            ðŸŽ¯ Total Real Sessions: ${sessionState.totalRealSessions}<br>
            ðŸ”¥ Max Consecutive Busts: ${sessionState.maxConsecutiveBusts}<br>
            ðŸ’¸ Overall Max Bet: ${sessionState.overallMaxBet.toLocaleString()}<br>
            ðŸ“‰ Overall Max Drawdown: ${sessionState.overallMaxDrawdown.toLocaleString()}
        `;
    }
</script>

</body>
</html>
