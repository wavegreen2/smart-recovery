<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baccarat Recovery Simulation</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; color: #333; margin: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #fafafa; }
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9em; }
        input, select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn-group { margin-top: 10px; display: flex; gap: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-p { background: #3498db; color: white; }
        .btn-b { background: #e74c3c; color: white; }
        .btn-t { background: #27ae60; color: white; }
        .btn-reset { background: #95a5a6; color: white; }
        button:hover { opacity: 0.8; }
        #log-area { margin-top: 20px; background: #2c3e50; color: #ecf0f1; padding: 15px; height: 300px; overflow-y: auto; border-radius: 8px; font-family: 'Courier New', Courier, monospace; font-size: 0.85em; }
        .stat-box { display: flex; justify-content: space-between; background: #34495e; color: white; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .next-bet-box { background: #f1c40f; color: #2c3e50; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: center; font-size: 1.2em; font-weight: bold; border: 2px dashed #d35400; }
        .win { color: #2ecc71; }
        .loss { color: #ff7675; }
        .virtual { color: #f1c40f; font-style: italic; }
    </style>
</head>
<body>

<div class="container">
    <h2>üìä Baccarat Strategy Simulator</h2>
    
    <div class="grid">
        <div class="card">
            <h3>Settings (‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)</h3>
            <label>Side Preference:</label>
            <select id="sidePreference">
                <option value="PLAYER">PLAYER</option>
                <option value="BANKER" selected>BANKER</option>
            </select>
            
            <label>Unit Size:</label>
            <input type="number" id="unitSize" value="10.0">
            
            <label>Martingale Multiplier:</label>
            <input type="number" id="martyMult" value="2.0">
            
            <label>Fibonacci Multiplier:</label>
            <input type="number" id="fiboMult" value="1000000.0">
            
            <label>Stop Loss (Threshold):</label>
            <input type="number" id="stopLoss" value="1000000.0">
        </div>

        <div class="card">
            <h3>Advanced Settings</h3>
            <label>Initial Bankroll:</label>
            <input type="number" id="initBR" value="20.0">
            
            <label>Virtual Loss Trigger (‡∏Ñ‡∏£‡∏±‡πâ‡∏á):</label>
            <input type="number" id="vLossTrigger" value="1">
            
            <label>Rebate Rate (0.01 = 1%):</label>
            <input type="number" id="rebateRate" step="0.001" value="0.01">
            
            <label>Base Profit Target:</label>
            <input type="number" id="baseInc" value="0.01">
        </div>
    </div>

    <div class="stat-box">
        <div>Total Profit: <span id="stat-profit">0.00</span></div>
        <div>Max Bet: <span id="stat-maxbet">0.00</span></div>
        <div>Status: <span id="stat-mode" class="virtual">VIRTUAL WAIT</span></div>
    </div>

    <div id="next-bet-display" class="next-bet-box">
        üëâ ‡∏°‡∏±‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ‡∏£‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...
    </div>

    <div class="btn-group">
        <button class="btn-p" onclick="processResult('P')">P (PLAYER)</button>
        <button class="btn-b" onclick="processResult('B')">B (BANKER)</button>
        <button class="btn-t" onclick="processResult('T')">T (TIE)</button>
        <button class="btn-reset" onclick="resetAll()">RESET</button>
    </div>

    <div id="log-area">--- Welcome! Waiting for Manual Input ---</div>
</div>

<script>
/** Logic Functions **/
function getFibo(n) {
    if (n <= 0) return 1;
    if (n === 1) return 1;
    let a = 1, b = 1;
    for (let i = 2; i <= n; i++) {
        let temp = b;
        b = a + b;
        a = temp;
    }
    return b;
}

/** State Management **/
let globalState = {
    totalAccumulatedProfit: 0,
    currentSessionBR: 0,
    currentSessionTarget: 0,
    consecutiveVirtualLosses: 0,
    totalRealSessions: 0,
    overallMaxBet: 0,
    overallMaxDrawdown: 0,
    
    // Internal Session State
    bankroll: 0,
    peakBankroll: 0,
    state: "FLAT", // FLAT, MARTY, FIBO
    martyStep: 0,
    fiboIdx: 0,
    handCount: 0,
    hasLostSincePeak: false,
    initialBRInSession: 0
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Bet ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ (‡∏¢‡πâ‡∏≤‡∏¢ Logic ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÑ‡∏î‡πâ)
function calculateNextBet() {
    initSession();
    const config = getConfig();
    let currentDrawdown = globalState.peakBankroll - globalState.bankroll;
    
    if (currentDrawdown >= config.stopLoss) {
        // Reset state inside calculation for UI accuracy
    }

    let bet = 0;
    if (globalState.state === "FLAT") {
        if (currentDrawdown > 0 && globalState.hasLostSincePeak) {
            bet = Math.max(Math.ceil(currentDrawdown / 4), config.unitSize);
        } else {
            bet = config.unitSize;
        }
    } else if (globalState.state === "MARTY") {
        bet = config.unitSize * Math.pow(config.martyMult, globalState.martyStep);
    } else if (globalState.state === "FIBO") {
        bet = getFibo(globalState.fiboIdx) * config.fiboMult;
    }

    let neededToRecover = currentDrawdown + config.unitSize;
    if (globalState.state !== "FLAT") bet = Math.min(bet, neededToRecover);

    if (bet >= config.stopLoss) bet = config.stopLoss;

    let currentProfitThisSession = globalState.bankroll - globalState.initialBRInSession;
    let remainingToTarget = globalState.currentSessionTarget - currentProfitThisSession;
    if (bet > remainingToTarget && remainingToTarget > 0) {
        bet = Math.max(config.unitSize, remainingToTarget);
    }

    return bet;
}

function initSession() {
    const config = getConfig();
    if (globalState.handCount === 0) {
        if (globalState.totalRealSessions === 0 && globalState.totalAccumulatedProfit === 0) {
            globalState.currentSessionBR = config.initBR;
            globalState.currentSessionTarget = config.baseInc;
        }
        globalState.bankroll = globalState.currentSessionBR;
        globalState.initialBRInSession = globalState.currentSessionBR;
        globalState.peakBankroll = globalState.currentSessionBR;
        globalState.state = "FLAT";
        globalState.martyStep = 0;
        globalState.fiboIdx = 0;
        globalState.hasLostSincePeak = false;
    }
}

function getConfig() {
    return {
        unitSize: parseFloat(document.getElementById('unitSize').value),
        martyMult: parseFloat(document.getElementById('martyMult').value),
        fiboMult: parseFloat(document.getElementById('fiboMult').value),
        stopLoss: parseFloat(document.getElementById('stopLoss').value),
        initBR: parseFloat(document.getElementById('initBR').value),
        vLossTrigger: parseInt(document.getElementById('vLossTrigger').value),
        rebateRate: parseFloat(document.getElementById('rebateRate').value),
        baseInc: parseFloat(document.getElementById('baseInc').value),
        side: document.getElementById('sidePreference').value
    };
}

function processResult(actualResult) {
    initSession();
    const config = getConfig();
    const isVirtual = globalState.consecutiveVirtualLosses < config.vLossTrigger;
    
    if (actualResult === 'T') {
        log(`[Hand ${globalState.handCount+1}] Result: TIE | Skip...`, 'virtual');
        return;
    }

    // --- Calculate Bet (Exact same logic as original) ---
    let currentDrawdown = globalState.peakBankroll - globalState.bankroll;
    if (currentDrawdown >= config.stopLoss) {
        globalState.state = "FLAT"; globalState.martyStep = 0; globalState.fiboIdx = 0;
    }

    let bet = 0;
    if (globalState.state === "FLAT") {
        if (currentDrawdown > 0 && globalState.hasLostSincePeak) {
            bet = Math.max(Math.ceil(currentDrawdown / 4), config.unitSize);
        } else {
            bet = config.unitSize;
        }
    } else if (globalState.state === "MARTY") {
        bet = config.unitSize * Math.pow(config.martyMult, globalState.martyStep);
    } else if (globalState.state === "FIBO") {
        bet = getFibo(globalState.fiboIdx) * config.fiboMult;
    }

    let neededToRecover = currentDrawdown + config.unitSize;
    if (globalState.state !== "FLAT") bet = Math.min(bet, neededToRecover);

    let isMaxBetActive = false;
    if (bet >= config.stopLoss) {
        bet = config.stopLoss;
        isMaxBetActive = true;
    }

    let currentProfitThisSession = globalState.bankroll - globalState.initialBRInSession;
    let remainingToTarget = globalState.currentSessionTarget - currentProfitThisSession;
    if (bet > remainingToTarget && remainingToTarget > 0) {
        bet = Math.max(config.unitSize, remainingToTarget);
    }

    if (bet > globalState.overallMaxBet) globalState.overallMaxBet = bet;

    // --- Process Win/Loss ---
    const isWin = (actualResult === 'P' && config.side === 'PLAYER') || (actualResult === 'B' && config.side === 'BANKER');
    const payout = (config.side === 'BANKER') ? 0.95 : 1.0;
    const rebate = bet * config.rebateRate;
    
    globalState.bankroll += rebate;
    globalState.handCount++;

    let logMsg = `[H:${globalState.handCount}] Bet: ${bet.toFixed(2)} | `;

    if (isWin) {
        globalState.bankroll += (bet * payout);
        logMsg += `<span class="win">‚úÖ WIN</span>`;
        if (globalState.state === "FIBO") {
            globalState.fiboIdx = Math.max(-1, globalState.fiboIdx - 2);
            if (globalState.fiboIdx < 0) { globalState.state = "FLAT"; globalState.fiboIdx = 0; }
        } else {
            if (globalState.bankroll >= globalState.peakBankroll) globalState.hasLostSincePeak = false;
            globalState.state = "FLAT"; globalState.martyStep = 0;
        }
    } else {
        globalState.bankroll -= bet;
        globalState.hasLostSincePeak = true;
        logMsg += `<span class="loss">‚ùå LOSS</span>`;
        if (isMaxBetActive) {
            globalState.state = "FLAT"; globalState.martyStep = 0; globalState.fiboIdx = 0;
        } else {
            if (globalState.state === "FLAT") {
                globalState.state = "MARTY"; globalState.martyStep = 1;
            } else if (globalState.state === "MARTY") {
                globalState.martyStep++;
                if (globalState.martyStep > 12) { globalState.state = "FIBO"; globalState.fiboIdx = 0; }
            } else if (globalState.state === "FIBO") {
                globalState.fiboIdx++;
            }
        }
    }

    if (globalState.bankroll > globalState.peakBankroll) globalState.peakBankroll = globalState.bankroll;
    
    log(logMsg + ` | BR: ${globalState.bankroll.toFixed(2)} (${isVirtual ? 'VIRTUAL' : 'REAL'})`);

    // --- Session End Check ---
    let sessionResult = null;
    if (globalState.bankroll <= 0) sessionResult = "BUST";
    else if ((globalState.bankroll - globalState.initialBRInSession) >= globalState.currentSessionTarget) sessionResult = "WIN";

    if (sessionResult) {
        const sessionProfit = globalState.bankroll - globalState.initialBRInSession;
        if (isVirtual) {
            if (sessionResult === "BUST") globalState.consecutiveVirtualLosses++;
            else globalState.consecutiveVirtualLosses = 0;
            log(`--- üß™ VIRTUAL Session End: ${sessionResult} | Next Wait: ${globalState.consecutiveVirtualLosses}/${config.vLossTrigger} ---`, 'virtual');
        } else {
            globalState.totalAccumulatedProfit += sessionProfit;
            globalState.totalRealSessions++;
            if (sessionResult === "WIN") {
                globalState.currentSessionTarget = config.baseInc;
                globalState.currentSessionBR = config.initBR + globalState.totalAccumulatedProfit;
                log(`‚úÖ REAL SESSION WIN! Total Profit: ${globalState.totalAccumulatedProfit.toFixed(4)}`, 'win');
            } else {
                globalState.currentSessionTarget = Math.abs(globalState.totalAccumulatedProfit) + config.baseInc;
                globalState.currentSessionBR = globalState.currentSessionTarget * 1.5;
                log(`‚ùå REAL SESSION BUST! Recovery Target: ${globalState.currentSessionTarget.toFixed(4)}`, 'loss');
            }
            globalState.consecutiveVirtualLosses = 0;
        }
        globalState.handCount = 0;
    }
    updateUI();
}

function log(msg, className = '') {
    const logArea = document.getElementById('log-area');
    const div = document.createElement('div');
    div.className = className;
    div.innerHTML = msg;
    logArea.prepend(div);
}

function updateUI() {
    const config = getConfig();
    document.getElementById('stat-profit').innerText = globalState.totalAccumulatedProfit.toFixed(4);
    document.getElementById('stat-maxbet').innerText = globalState.overallMaxBet.toLocaleString();
    
    const statusEl = document.getElementById('stat-mode');
    const nextBetEl = document.getElementById('next-bet-display');
    const nextBetAmount = calculateNextBet();

    if (globalState.consecutiveVirtualLosses < config.vLossTrigger) {
        statusEl.innerText = `VIRTUAL WAIT (${globalState.consecutiveVirtualLosses}/${config.vLossTrigger})`;
        statusEl.className = 'virtual';
        nextBetEl.innerHTML = `üî≠ <span class="virtual">VIRTUAL:</span> ‡πÅ‡∏ó‡∏á‡∏ù‡∏±‡πà‡∏á <b style="color:#d35400">${config.side}</b> ‡∏ó‡∏µ‡πà <b style="color:#d35400">${nextBetAmount.toFixed(2)}</b> (‡∏£‡∏≠‡∏Å‡∏¥‡∏ô‡∏•‡∏°)`;
        nextBetEl.style.background = "#f1c40f";
    } else {
        statusEl.innerText = `REAL BETTING (Sess: ${globalState.totalRealSessions + 1})`;
        statusEl.className = 'loss';
        nextBetEl.innerHTML = `üî• <span style="color:white">REAL BET:</span> ‡πÅ‡∏ó‡∏á‡∏ù‡∏±‡πà‡∏á <b style="color:white">${config.side}</b> ‡∏¢‡∏≠‡∏î <b style="color:white">${nextBetAmount.toFixed(2)}</b> (‡∏•‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á!)`;
        nextBetEl.style.background = "#e74c3c";
        nextBetEl.style.color = "white";
    }
}

function resetAll() {
    if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
    globalState = {
        totalAccumulatedProfit: 0, currentSessionBR: 0, currentSessionTarget: 0,
        consecutiveVirtualLosses: 0, totalRealSessions: 0, overallMaxBet: 0,
        overallMaxDrawdown: 0, bankroll: 0, peakBankroll: 0, state: "FLAT",
        martyStep: 0, fiboIdx: 0, handCount: 0, hasLostSincePeak: false, initialBRInSession: 0
    };
    document.getElementById('log-area').innerHTML = "--- Data Reset ---";
    updateUI();
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
updateUI();
</script>

</body>
</html>
