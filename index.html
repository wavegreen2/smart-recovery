<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baccarat Simulation Web App</title>
    <style>
        :root {
            --player-color: #007bff;
            --banker-color: #dc3545;
            --tie-color: #28a745;
            --bg-color: #f4f7f6;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-color); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        
        /* Sidebar Settings */
        .sidebar { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .sidebar h2 { margin-top: 0; color: #333; font-size: 1.2rem; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.85rem; color: #666; margin-bottom: 5px; }
        .input-group input, .input-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        /* Main Content */
        .main-content { display: flex; flex-direction: column; gap: 20px; }
        
        /* Stats Dashboard */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-card .label { font-size: 0.8rem; color: #888; text-transform: uppercase; }
        .stat-card .value { font-size: 1.2rem; font-weight: bold; margin-top: 5px; }
        .profit-plus { color: #28a745; }
        .profit-minus { color: #dc3545; }

        /* Big Road Display */
        .big-road-container { 
            background: white; 
            padding: 10px; 
            border-radius: 8px; 
            overflow-x: auto; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            min-height: 200px;
        }
        .big-road { 
            display: grid; 
            grid-template-rows: repeat(6, 30px); 
            grid-auto-columns: 30px; 
            grid-auto-flow: column; 
            gap: 2px;
            background-image: radial-gradient(#eee 1px, transparent 1px);
            background-size: 32px 32px;
        }
        .cell { 
            width: 28px; height: 28px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 12px; font-weight: bold; color: white;
        }
        .P { background-color: var(--player-color); }
        .B { background-color: var(--banker-color); }
        .T { color: var(--tie-color); border: 2px solid var(--tie-color); background: white; border-radius: 0; }

        /* Controls */
        .controls { display: flex; gap: 10px; justify-content: center; background: white; padding: 20px; border-radius: 12px; }
        button { padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-p { background: var(--player-color); color: white; }
        .btn-b { background: var(--banker-color); color: white; }
        .btn-t { background: var(--tie-color); color: white; }
        .btn-undo { background: #6c757d; color: white; }
        .btn-reset { background: #343a40; color: white; }
        button:hover { opacity: 0.8; transform: translateY(-1px); }
        
        .bet-suggestion { 
            text-align: center; font-size: 1.5rem; font-weight: bold; 
            padding: 15px; background: #fff3cd; color: #856404; border-radius: 8px;
            border: 2px dashed #ffeeba;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <h2>⚙️ Configuration</h2>
        <div class="input-group">
            <label>Initial Bankroll</label>
            <input type="number" id="initial_bankroll" value="1000000">
        </div>
        <div class="input-group">
            <label>Min Bet (Base Unit)</label>
            <input type="number" id="unit_size" value="5">
        </div>
        <div class="input-group">
            <label>Minimum Chip</label>
            <input type="number" id="chip_size" value="5">
        </div>
        <div class="input-group">
            <label>Stop Loss Threshold</label>
            <input type="number" id="stop_loss_threshold" value="75000">
        </div>
        <div class="input-group">
            <label>Rebate Rate (0.01 = 1%)</label>
            <input type="number" id="rebate_rate" step="0.001" value="0.01">
        </div>
        <div class="input-group">
            <label>Side Preference</label>
            <select id="side_preference">
                <option value="PLAYER">PLAYER</option>
                <option value="BANKER">BANKER</option>
            </select>
        </div>
        <hr>
        <div class="input-group">
            <label>Virtual Win Trigger (Wait x Wins)</label>
            <input type="number" id="virtual_win_trigger" value="5">
        </div>
        <button class="btn-reset" style="width: 100%;" onclick="resetAll()">Reset All Data</button>
    </div>

    <div class="main-content">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">Net Profit (Inc. Rebate)</div>
                <div class="value" id="stat_net_profit">0.00</div>
            </div>
            <div class="stat-card">
                <div class="label">Current Bankroll</div>
                <div class="value" id="stat_bankroll">0.00</div>
            </div>
            <div class="stat-card">
                <div class="label">Max Bet Used</div>
                <div class="value" id="stat_max_bet">0.00</div>
            </div>
            <div class="stat-card">
                <div class="label">Max Drawdown</div>
                <div class="value" id="stat_max_dd">0.00</div>
            </div>
        </div>

        <div class="bet-suggestion" id="bet_display">
            NEXT BET: WAIT FOR VIRTUAL WINS
        </div>

        <div class="big-road-container">
            <div class="big-road" id="big_road">
                </div>
        </div>

        <div class="controls">
            <button class="btn-p" onclick="addResult('P')">PLAYER (P)</button>
            <button class="btn-t" onclick="addResult('T')">TIE (T)</button>
            <button class="btn-b" onclick="addResult('B')">BANKER (B)</button>
            <button class="btn-undo" onclick="undoLast()">Undo</button>
        </div>
    </div>
</div>

<script>
    // --- State Management ---
    let history = []; // List of results
    let bankroll = 0;
    let netProfit = 0;
    let totalRebate = 0;
    let peakNetProfit = 0;
    let maxDrawdown = 0;
    let maxBetUsed = 0;
    
    // Betting Logic States
    let state = "FLAT"; // FLAT, MARTY, FIBO
    let martStep = 0;
    let fiboIdx = 0;
    let virtualWins = 0;
    let isRealSession = false;
    let sessionPeakBankroll = 0;

    const fibo = [1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377];

    function init() {
        bankroll = parseFloat(document.getElementById('initial_bankroll').value);
        sessionPeakBankroll = bankroll;
        updateUI();
    }

    function addResult(res) {
        const config = getConfig();
        const side = config.side_preference === "PLAYER" ? "P" : "B";
        const payout = config.side_preference === "BANKER" ? 0.95 : 1.0;
        
        // 1. Logic for Virtual/Real
        if (!isRealSession) {
            if (res !== 'T') {
                const isWin = (res === side);
                virtualWins = isWin ? virtualWins + 1 : 0;
                if (virtualWins >= config.virtual_win_trigger) {
                    isRealSession = true;
                    // Reset session state
                    state = "FLAT";
                    martStep = 0;
                    fiboIdx = 0;
                }
            }
        } else {
            // 2. Real Session Math
            if (res !== 'T') {
                const currentBet = calculateBet();
                const isWin = (res === side);
                
                // Update Bankroll
                let winLoss = isWin ? (currentBet * payout) : -currentBet;
                let rebate = currentBet * config.rebate_rate;
                
                bankroll += winLoss;
                totalRebate += rebate;
                netProfit = (bankroll - config.initial_bankroll) + totalRebate;

                // Track Stats
                if (currentBet > maxBetUsed) maxBetUsed = currentBet;
                if (netProfit > peakNetProfit) peakNetProfit = netProfit;
                let dd = peakNetProfit - netProfit;
                if (dd > maxDrawdown) maxDrawdown = dd;

                // Update Strategy State
                updateStrategy(isWin);

                // Check if session ends (Target met or Stop loss)
                let sessionProfit = bankroll - config.initial_bankroll; 
                // Simple Target: 1 Unit or Back to Peak
                if (isWin && state === "FLAT") {
                    isRealSession = false;
                    virtualWins = 0;
                }
            }
        }

        history.push(res);
        renderBigRoad();
        updateUI();
    }

    function updateStrategy(isWin) {
        if (isWin) {
            if (state === "FIBO") {
                fiboIdx = Math.max(0, fiboIdx - 2);
                if (fiboIdx === 0) state = "FLAT";
            } else {
                state = "FLAT";
                martStep = 0;
            }
        } else {
            if (state === "FLAT") {
                state = "MARTY";
                martStep = 1;
            } else if (state === "MARTY") {
                martStep++;
                if (martStep > 12) { // limit from your config
                    state = "FIBO";
                    fiboIdx = 0;
                }
            } else if (state === "FIBO") {
                fiboIdx++;
            }
        }
    }

    function calculateBet() {
        if (!isRealSession) return 0;
        
        const config = getConfig();
        let rawBet = config.unit_size;

        if (state === "MARTY") {
            rawBet = config.unit_size * Math.pow(2, martStep);
        } else if (state === "FIBO") {
            rawBet = config.unit_size * (fibo[fiboIdx] || 500);
        }

        // Cap by stop loss
        rawBet = Math.min(rawBet, config.stop_loss_threshold);
        // Round to chip size
        return Math.ceil(rawBet / config.chip_size) * config.chip_size;
    }

    function getConfig() {
        return {
            initial_bankroll: parseFloat(document.getElementById('initial_bankroll').value),
            unit_size: parseFloat(document.getElementById('unit_size').value),
            chip_size: parseFloat(document.getElementById('chip_size').value),
            stop_loss_threshold: parseFloat(document.getElementById('stop_loss_threshold').value),
            rebate_rate: parseFloat(document.getElementById('rebate_rate').value),
            side_preference: document.getElementById('side_preference').value,
            virtual_win_trigger: parseInt(document.getElementById('virtual_win_trigger').value)
        };
    }

    function updateUI() {
        document.getElementById('stat_bankroll').innerText = bankroll.toLocaleString();
        document.getElementById('stat_net_profit').innerText = netProfit.toLocaleString();
        document.getElementById('stat_max_bet').innerText = maxBetUsed.toLocaleString();
        document.getElementById('stat_max_dd').innerText = maxDrawdown.toLocaleString();

        const netElem = document.getElementById('stat_net_profit');
        netElem.className = 'value ' + (netProfit >= 0 ? 'profit-plus' : 'profit-minus');

        const betDisplay = document.getElementById('bet_display');
        if (!isRealSession) {
            betDisplay.innerText = `WAITING FOR VIRTUAL WINS (${virtualWins}/${getConfig().virtual_win_trigger})`;
            betDisplay.style.background = "#e9ecef";
        } else {
            betDisplay.innerText = `NEXT BET: ${calculateBet().toLocaleString()} on ${getConfig().side_preference}`;
            betDisplay.style.background = "#fff3cd";
        }
    }

    function renderBigRoad() {
        const road = document.getElementById('big_road');
        road.innerHTML = '';
        
        let cols = [[]];
        let currentCol = 0;
        let lastRes = '';

        history.forEach(res => {
            if (res === 'T') {
                // Ties usually marked on the last cell, for simplicity here we skip or mark
                return; 
            }
            if (lastRes !== '' && res !== lastRes) {
                currentCol++;
                cols[currentCol] = [];
            }
            cols[currentCol].push(res);
            lastRes = res;
        });

        cols.forEach(col => {
            for (let i = 0; i < 6; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell ' + (col[i] || '');
                cell.innerText = col[i] || '';
                road.appendChild(cell);
            }
        });
        // Auto scroll to end
        document.querySelector('.big-road-container').scrollLeft = road.scrollWidth;
    }

    function undoLast() {
        history.pop();
        // For a true undo, we'd need to snapshot states. 
        // For this web version, we suggest a full reset if a mistake is deep.
        alert("Undo is limited in this preview. Please use Reset for accurate backtesting.");
        renderBigRoad();
    }

    function resetAll() {
        if(confirm("Are you sure you want to reset everything?")) {
            history = [];
            virtualWins = 0;
            isRealSession = false;
            maxBetUsed = 0;
            maxDrawdown = 0;
            peakNetProfit = 0;
            totalRebate = 0;
            init();
            renderBigRoad();
        }
    }

    window.onload = init;
</script>

</body>
</html>
