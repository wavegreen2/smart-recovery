<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baccarat Recovery Simulation</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .input-group { display: flex; flex-direction: column; }
        label { font-size: 14px; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, select, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        textarea { height: 80px; grid-column: span 2; }
        button { background: #27ae60; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; }
        button:hover { background: #219150; }
        #log-container { background: #2d3436; color: #dfe6e9; padding: 15px; border-radius: 6px; height: 300px; overflow-y: auto; font-family: 'Courier New', Courier, monospace; font-size: 13px; margin-top: 20px; }
        .summary { background: #e8f4fd; border-left: 5px solid #3498db; padding: 15px; margin-top: 20px; display: none; }
        .win { color: #2ecc71; } .loss { color: #e74c3c; } .virtual { color: #f1c40f; }
    </style>
</head>
<body>

<div class="container">
    <h2>üìä Baccarat Recovery Simulation</h2>
    
    <div class="grid">
        <div class="input-group">
            <label>‡πÇ‡∏´‡∏°‡∏î (Mode)</label>
            <select id="mode">
                <option value="a">Auto (Data)</option>
                <option value="r">Random Simulation</option>
            </select>
        </div>
        <div class="input-group">
            <label>Virtual Loss Trigger (‡∏£‡∏≠‡πÅ‡∏ï‡∏Å‡∏Å‡∏µ‡πà‡∏£‡∏≠‡∏ö‡∏Ñ‡πà‡∏≠‡∏¢‡πÅ‡∏ó‡∏á‡∏à‡∏£‡∏¥‡∏á)</label>
            <input type="number" id="virtual_loss_trigger" value="2">
        </div>
        <div class="input-group">
            <label>Unit Size (‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)</label>
            <input type="number" id="unit_size" value="10">
        </div>
        <div class="input-group">
            <label>Side Preference</label>
            <select id="side_preference">
                <option value="PLAYER">PLAYER</option>
                <option value="BANKER">BANKER</option>
            </select>
        </div>
        <div class="input-group">
            <label>Max Sessions (‡∏£‡∏≠‡∏ö‡πÅ‡∏ó‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)</label>
            <input type="number" id="max_sessions" value="10">
        </div>
        <div class="input-group">
            <label>Rebate Rate (0.01 = 1%)</label>
            <input type="number" id="rebate_rate" step="0.001" value="0.01">
        </div>
        <textarea id="raw_data" placeholder="‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≠‡∏°‡∏°‡∏≤)...">1,B,T,P,B,B,B,P,P,P,T,P,P,P,P,T,B,P,P,B,P,P,B,B,P,P,B,P,B,P,T,B,T,B,P,P,T,B,P,P,B,P,P,T,P,P,P,P,P,B,P,B,B,P,B,B,P,B,B,P,B,B,B,B,P,B,P,B,P,T,P,B,B,B,P,B,B,P,P,P
2,T,P,B,P,B,B,P,P,B,B,T,P,B,B,T,P,P,B,B,B,B,P,T,B,T,B,B,B,P,P,B,P,P,P,B,P,B,P,T,B,P,B,P,B,B,B,B,P,B,B,B,P,P,P,B,T,B,P,B,B,P,B,B,P,B,P,P,B,B,P,P,P,B,B,P,B,P,P,P,P,T</textarea>
    </div>

    <button onclick="startSimulation()">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>

    <div id="summary" class="summary"></div>
    <div id="log-container">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π Log ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...</div>
</div>

<script>
// --- Core Logic Functions ---
function getFibo(n) {
    if (n <= 0) return 1;
    if (n === 1) return 1;
    let a = 1, b = 1;
    for (let i = 2; i <= n; i++) {
        let temp = b;
        b = a + b;
        a = temp;
    }
    return b;
}

const logContainer = document.getElementById('log-container');
function addLog(msg, type = '') {
    const div = document.createElement('div');
    div.className = type;
    div.innerHTML = msg;
    logContainer.appendChild(div);
    logContainer.scrollTop = logContainer.scrollHeight;
}

// --- Simulation Logic ---
async function runSingleSession(config) {
    let { mode, resultList, startIdx, targetProfit, unitSize, initialBankroll, rebateRate, sidePreference, stopLossThreshold } = config;
    
    let bankroll = initialBankroll;
    let peakBankroll = initialBankroll;
    let maxBetEncountered = 0;
    let maxDrawdown = 0;
    let state = "FLAT";
    let martyStep = 0;
    let fiboIdx = 0;
    let martyStepsLimit = 12;
    let hasLostSincePeak = false;
    let currentIdx = startIdx;

    while (true) {
        let currentDrawdown = peakBankroll - bankroll;
        if (currentDrawdown >= stopLossThreshold) {
            state = "FLAT"; martyStep = 0; fiboIdx = 0;
        }

        let rawBet = unitSize;
        if (state === "FLAT") {
            rawBet = (currentDrawdown > 0 && hasLostSincePeak) ? Math.max(Math.ceil(currentDrawdown / 4), unitSize) : unitSize;
        } else if (state === "MARTY") {
            rawBet = unitSize * Math.pow(2, martyStep);
        } else if (state === "FIBO") {
            rawBet = getFibo(fiboIdx) * unitSize;
        }

        let neededToRecover = currentDrawdown + unitSize;
        let bet = (state !== "FLAT") ? Math.min(rawBet, neededToRecover) : rawBet;
        
        let isMaxBetActive = false;
        if (bet >= stopLossThreshold) {
            bet = stopLossThreshold;
            isMaxBetActive = true;
        }

        let currentProfit = bankroll - initialBankroll;
        let remainingToTarget = targetProfit - currentProfit;
        if (bet > remainingToTarget && remainingToTarget > 0) bet = Math.max(unitSize, remainingToTarget);

        if (bet > maxBetEncountered) maxBetEncountered = bet;

        // Get Result
        let actualResult;
        if (mode === 'a') {
            if (currentIdx >= resultList.length) return { status: "OUT_OF_DATA", profit: bankroll - initialBankroll, mdd: maxDrawdown, maxBet: maxBetEncountered, nextIdx: currentIdx };
            actualResult = resultList[currentIdx];
            currentIdx++;
        } else {
            actualResult = Math.random() < 0.5068 ? "B" : "P";
            currentIdx++;
        }

        if (actualResult === "T") continue;

        let isWin = (actualResult === "P" && sidePreference === "PLAYER") || (actualResult === "B" && sidePreference === "BANKER");
        let payout = (sidePreference === "BANKER") ? 0.95 : 1.0;
        
        bankroll += bet * rebateRate;

        if (isWin) {
            bankroll += (bet * payout);
            if (state === "FIBO") {
                fiboIdx = Math.max(-1, fiboIdx - 2);
                if (fiboIdx < 0) { state = "FLAT"; fiboIdx = 0; }
            } else {
                if (bankroll >= peakBankroll) hasLostSincePeak = false;
                state = "FLAT"; martyStep = 0;
            }
        } else {
            bankroll -= bet;
            hasLostSincePeak = true;
            if (isMaxBetActive) {
                state = "FLAT"; martyStep = 0; fiboIdx = 0;
            } else {
                if (state === "FLAT") { state = "MARTY"; martyStep = 1; }
                else if (state === "MARTY") {
                    martyStep++;
                    if (martyStep > martyStepsLimit) { state = "FIBO"; fiboIdx = 0; }
                } else if (state === "FIBO") {
                    fiboIdx++;
                }
            }
        }

        if (bankroll > peakBankroll) peakBankroll = bankroll;
        let drawdown = peakBankroll - bankroll;
        if (drawdown > maxDrawdown) maxDrawdown = drawdown;

        if (bankroll <= 0) return { status: "BUST", profit: bankroll - initialBankroll, mdd: maxDrawdown, maxBet: maxBetEncountered, nextIdx: currentIdx };
        if ((bankroll - initialBankroll) >= targetProfit) return { status: "WIN", profit: bankroll - initialBankroll, mdd: maxDrawdown, maxBet: maxBetEncountered, nextIdx: currentIdx };
        
        // Safety break for random mode
        if (currentIdx > 100000) return { status: "OUT_OF_DATA", profit: bankroll - initialBankroll, mdd: maxDrawdown, maxBet: maxBetEncountered, nextIdx: currentIdx };
    }
}

async function startSimulation() {
    logContainer.innerHTML = "--- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö ---<br>";
    document.getElementById('summary').style.display = "none";

    const config = {
        mode: document.getElementById('mode').value,
        virtual_loss_trigger: parseInt(document.getElementById('virtual_loss_trigger').value),
        unitSize: parseFloat(document.getElementById('unit_size').value),
        sidePreference: document.getElementById('side_preference').value,
        maxSessions: parseInt(document.getElementById('max_sessions').value),
        rebateRate: parseFloat(document.getElementById('rebate_rate').value),
        stopLossThreshold: 10000, // ‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏°‡∏ï‡∏¥
        initialBankroll: 20, // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        targetProfit: 0.01
    };

    let fullResults = [];
    if (config.mode === 'a') {
        let raw = document.getElementById('raw_data').value;
        fullResults = raw.split('\n').flatMap(line => line.split(',').slice(1).map(s => s.trim()));
    }

    let totalLossAccumulated = 0;
    let currentTarget = 0.01;
    let currentBankroll = 20;
    let currentIdx = 0;
    let totalRealSessions = 0;
    let consecutiveVirtualLosses = 0;
    let overallMaxBet = 0;
    let overallMaxDD = 0;
    let maxConsecutiveBusts = 0;
    let currentConsecutiveBusts = 0;

    while (totalRealSessions < config.maxSessions) {
        let isVirtual = consecutiveVirtualLosses < config.virtual_loss_trigger;
        
        addLog(isVirtual ? `üß™ VIRTUAL SESSION (Wait: ${consecutiveVirtualLosses}/${config.virtual_loss_trigger})` : `üí∞ REAL SESSION ${totalRealSessions + 1} (START)`, isVirtual ? 'virtual' : '');

        let result = await runSingleSession({
            ...config,
            startIdx: currentIdx,
            targetProfit: currentTarget,
            initialBankroll: currentBankroll,
            resultList: fullResults
        });

        currentIdx = result.nextIdx;

        if (isVirtual) {
            if (result.status === "BUST") {
                consecutiveVirtualLosses++;
                addLog(`üìâ Virtual Result: BUST`);
            } else if (result.status === "WIN") {
                consecutiveVirtualLosses = 0;
                addLog(`üîÑ Virtual Result: WIN (Reset)`);
            } else break;
            continue;
        }

        // Real Session logic
        totalRealSessions++;
        overallMaxBet = Math.max(overallMaxBet, result.maxBet);
        overallMaxDD = Math.max(overallMaxDD, result.mdd);

        if (result.status === "WIN") {
            addLog(`‚úÖ REAL WIN: Profit +${result.profit.toFixed(2)}`, 'win');
            totalLossAccumulated = 0;
            currentTarget = 0.01;
            currentBankroll = 20;
            currentConsecutiveBusts = 0;
            consecutiveVirtualLosses = 0;
        } else {
            addLog(`‚ùå REAL ${result.status}: Loss ${result.profit.toFixed(2)}`, 'loss');
            totalLossAccumulated += Math.abs(result.profit);
            currentTarget = totalLossAccumulated + 0.01;
            currentBankroll = currentTarget * 1.5;
            currentConsecutiveBusts++;
            maxConsecutiveBusts = Math.max(maxConsecutiveBusts, currentConsecutiveBusts);
        }

        if (result.status === "OUT_OF_DATA") break;
        
        // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ UI ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
        await new Promise(r => setTimeout(r, 10));
    }

    // Show Summary
    const summary = document.getElementById('summary');
    summary.style.display = "block";
    summary.innerHTML = `
        <h3>üìä Summary Report</h3>
        <p>Total Real Sessions: <b>${totalRealSessions}</b></p>
        <p>Max Consecutive Busts: <b>${maxConsecutiveBusts}</b></p>
        <p>Overall Max Bet: <b>${overallMaxBet.toLocaleString()}</b></p>
        <p>Overall Max Drawdown: <b>${overallMaxDD.toLocaleString()}</b></p>
    `;
}
</script>

</body>
</html>
