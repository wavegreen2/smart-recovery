<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Baccarat AI: Ultimate V3.4 (Full + Sessions)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --primary:#2c3e50;--accent:#e74c3c;--player:#2980b9;--banker:#c0392b;--tie:#27ae60;
      --bg:#f4f6f7;--card-bg:#fff;--text:#2c3e50;--success:#27ae60;--warning:#f39c12;--danger:#c0392b;
      --auto:#8e44ad;--gold:#d4ac0d;--chaos:#8e44ad;--dragon:#e67e22;--target:#16a085;--comm:#8e44ad;
    }
    *{box-sizing:border-box}
    body{font-family:'Segoe UI','Sarabun',sans-serif;background:var(--bg);color:var(--text);margin:0;padding:10px;display:flex;justify-content:center;height:100vh;overflow:hidden}
    .container{width:100%;max-width:1200px;display:grid;grid-template-columns:360px 1fr;gap:15px;height:95vh}
    .sidebar{background:var(--card-bg);padding:15px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.05);overflow-y:auto;display:flex;flex-direction:column;gap:10px;height:100%;border-top:5px solid var(--target)}
    .main-content{display:flex;flex-direction:column;gap:15px;overflow-y:auto;padding-right:5px;height:100%}
    .section-title{font-size:.85rem;font-weight:bold;color:var(--primary);margin-top:5px;border-bottom:2px solid #eee;padding-bottom:3px;display:flex;justify-content:space-between;align-items:center}
    .badge-ult{background:var(--primary);color:#fff;padding:2px 6px;border-radius:4px;font-size:.6rem}
    .form-group{margin-bottom:5px}
    .form-group label{display:block;font-size:.8rem;font-weight:600;margin-bottom:2px;color:#555}
    .form-group input,.form-group select{width:100%;padding:8px;border:1px solid #bdc3c7;border-radius:5px;font-size:.95rem}
    .btn-action{width:100%;padding:12px;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;font-size:.9rem;margin-top:5px}
    .btn-sim{background:var(--primary)}
    .btn-auto{background:var(--auto)}
    .btn-stop{background:var(--danger);display:none}
    .btn-reset{background:#ecf0f1;color:#7f8c8d;border:1px solid #bdc3c7;margin-top:10px;width:100%;padding:12px;border-radius:6px;cursor:pointer;font-weight:bold;font-size:.9rem}
    .btn-restore{background:#fff;border:1px dashed var(--target);color:var(--target);font-size:.75rem;width:100%;cursor:pointer;padding:6px;margin-top:5px;border-radius:4px;font-weight:bold}
    .target-box{background:#e8f8f5;border:1px solid #a3e4d7;border-radius:8px;padding:8px;margin-bottom:5px}
    .target-title{font-size:.75rem;font-weight:bold;color:var(--target);margin-bottom:5px}
    .feature-box{background:#fffcf5;border:1px solid #fae5d3;border-radius:8px;padding:8px;margin-bottom:5px}
    .feature-title{font-size:.75rem;font-weight:bold;color:#d35400;margin-bottom:5px;display:flex;justify-content:space-between}
    .dual-input{display:grid;grid-template-columns:1fr 1fr;gap:5px}
    .survival-active{animation:pulse-red 2s infinite;border:2px solid var(--danger)}
    @keyframes pulse-red{0%,100%{box-shadow:0 0 5px rgba(192,57,43,.3)}50%{box-shadow:0 0 15px rgba(192,57,43,.6)}}

    /* Commission */
    .comm-box{background:#f5eef8;border:1px solid #d2b4de;border-radius:8px;padding:8px;margin-bottom:5px}
    .comm-title{font-size:.75rem;font-weight:bold;color:var(--comm);margin-bottom:5px;display:flex;justify-content:space-between;align-items:center}
    .btn-guide{background:var(--comm);color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:.65rem;cursor:pointer;font-weight:800}
    .comm-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px}
    .comm-stat{background:rgba(142,68,173,.08);border-radius:6px;padding:6px;text-align:center}
    .comm-stat .lb{font-size:.6rem;color:#7f8c8d;text-transform:uppercase}
    .comm-stat .vl{font-size:.95rem;font-weight:900;color:var(--comm)}

    .monitor-box{background:#2c3e50;border-radius:8px;padding:12px;margin-bottom:5px;text-align:center;color:#fff}
    .monitor-label{font-size:.7rem;color:#bdc3c7;font-weight:600;display:block;margin-bottom:2px;text-transform:uppercase;letter-spacing:1px}
    .monitor-val{font-size:1.2rem;font-weight:bold;color:var(--gold)}
    .cycle-monitor{display:flex;justify-content:space-between;background:rgba(0,0,0,.2);padding:5px 10px;border-radius:4px;margin-top:5px;font-size:.8rem}

    .brain-monitor{background:#fff;border:1px solid #e0e0e0;border-radius:8px;padding:8px;display:grid;grid-template-columns:1fr 1fr;gap:5px}
    .brain-col{text-align:center}
    .brain-head{font-size:.7rem;font-weight:bold;margin-bottom:2px}
    .brain-val{font-size:1.1rem;font-weight:800}
    .brain-info{font-size:.65rem;color:#7f8c8d}
    .txt-p{color:var(--player)} .txt-b{color:var(--banker)}

    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;flex-shrink:0}
    .stat-card{background:var(--card-bg);padding:10px;border-radius:10px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.03);border-top:4px solid transparent}
    .stat-card.profit{border-top-color:var(--success)}
    .stat-card.loss{border-top-color:var(--danger)}
    .stat-card.pre{border-top-color:var(--gold);background:#fffcf5}
    .stat-card.comm{border-top-color:var(--comm);background:#f9f0ff}
    .stat-label{font-size:.65rem;color:#95a5a6;text-transform:uppercase;line-height:1.2}
    .stat-value{font-size:1rem;font-weight:800;margin-top:3px}

    .road-scroll-wrapper{background:var(--card-bg);padding:10px;border-radius:10px;overflow-x:auto;overflow-y:hidden;height:170px;min-height:170px;flex-shrink:0;width:100%;scroll-behavior:smooth}
    .big-road-grid{display:grid;grid-template-rows:repeat(6,26px);grid-auto-columns:26px;grid-auto-flow:column;gap:1px;min-width:max-content}
    .big-road-cell{width:24px;height:24px;display:flex;justify-content:center;align-items:center;font-size:10px;font-weight:bold;border:1px solid #f0f0f0;background:#fff}
    .circle{width:18px;height:18px;border-radius:50%;border:2px solid transparent;display:flex;justify-content:center;align-items:center}
    .circle-P{border-color:var(--player);color:var(--player)}
    .circle-B{border-color:var(--banker);color:var(--banker)}
    .circle-T{border-color:var(--tie);color:var(--tie)}

    .bet-panel{background:var(--card-bg);padding:15px;border-radius:12px;text-align:center;box-shadow:0 5px 20px rgba(0,0,0,.08);flex-shrink:0;border-bottom:5px solid var(--primary)}
    .offset-formula{font-family:monospace;font-size:.9rem;color:#7f8c8d;background:#f0f3f4;padding:4px 10px;border-radius:4px;display:inline-block;margin-bottom:10px}
    .rec-amount{font-size:3.5rem;font-weight:900;line-height:1;color:var(--primary)}
    .rec-side{font-size:1.8rem;font-weight:800;margin-top:5px;text-transform:uppercase;letter-spacing:2px}
    .side-p{color:var(--player)} .side-b{color:var(--banker)} .side-n{color:#95a5a6} .side-chaos{color:var(--chaos)} .side-dragon{color:var(--dragon)}

    .controls{display:grid;grid-template-columns:1fr 1fr 80px;gap:10px;margin-top:15px}
    .btn-ctrl{padding:15px;border:none;border-radius:8px;font-size:1rem;font-weight:bold;cursor:pointer;color:#fff;touch-action:manipulation}
    .btn-ctrl:disabled{opacity:.55;cursor:not-allowed}
    .btn-p{background:var(--player)} .btn-b{background:var(--banker)} .btn-u{background:#95a5a6}

    .chart-box{background:var(--card-bg);padding:10px;border-radius:12px;flex-grow:1;min-height:250px;position:relative}

    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:999999;backdrop-filter:blur(5px)}
    .modal-box{background:#fff;padding:30px 20px;border-radius:15px;text-align:center;max-width:520px;width:90%;box-shadow:0 20px 50px rgba(0,0,0,.4);display:flex;flex-direction:column;align-items:center;border:2px solid var(--gold)}
    .modal-icon{font-size:3rem;margin-bottom:10px}
    .modal-text-th{font-size:1.2rem;font-weight:bold;color:#2c3e50;margin-bottom:5px}
    .modal-sub{font-size:1rem;color:var(--success);font-weight:bold;margin-bottom:15px}
    .btn-modal-ack{background:var(--success);color:#fff;border:none;padding:12px 20px;width:100%;border-radius:8px;font-weight:bold;cursor:pointer;font-size:1rem;margin-top:15px}

    .risk-stat-box{background:#fdedec;border:1px solid #fadbd8;padding:10px;width:100%;border-radius:8px;margin-bottom:15px;text-align:left}
    .risk-row{display:flex;justify-content:space-between;margin-bottom:5px;font-size:.9rem}
    .risk-val{font-weight:bold;color:#c0392b}

    /* ===== Shoe UI ===== */
    .shoe-ui{display:none;background:linear-gradient(135deg,#0d5e2e,#083a1c);border:2px solid rgba(255,215,0,.35);border-radius:12px;padding:12px}
    .shoe-ui.active{display:block}
    .shoe-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px}
    .shoe-hdr .t{color:#ffd700;font-weight:900;font-size:.8rem}
    .shoe-hdr .sub{color:#d7f7e6;font-size:.6rem}
    .shoe-hdr select{background:rgba(0,0,0,.25);color:#ffd700;border:1px solid rgba(255,215,0,.35);border-radius:6px;padding:5px 8px;font-weight:800;font-size:.75rem;cursor:pointer}
    .shoe-bar{position:relative;height:20px;background:rgba(0,0,0,.25);border-radius:999px;overflow:visible;margin-bottom:8px}
    .shoe-bar-fill{height:100%;width:0%;border-radius:999px;background:linear-gradient(90deg,#27ae60,#f39c12,#e74c3c);transition:width .25s}
    .shoe-bar-txt{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.6rem;font-weight:900}
    .shoe-cut{position:absolute;top:-2px;height:24px;width:3px;background:#ffd700;box-shadow:0 0 8px rgba(255,215,0,.9);border-radius:2px}
    .shoe-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:8px}
    .shoe-bx{background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:5px;text-align:center}
    .shoe-bx .lb{color:#b9f3d9;font-size:.55rem;text-transform:uppercase}
    .shoe-bx .vl{color:#fff;font-size:.9rem;font-weight:900;margin-top:1px}
    .burn-box{background:rgba(139,0,0,.22);border:1px dashed rgba(255,107,107,.7);border-radius:10px;padding:8px;margin-bottom:8px}
    .burn-box .bt{color:#ffb3b3;font-weight:900;font-size:.7rem;margin-bottom:6px}
    .burn-row{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .burn-note{color:#ffd7d7;font-size:.6rem;margin-top:6px;line-height:1.4;white-space:pre-line}
    .deal-area{background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px}
    .deal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px}
    .deal-head span{color:#ffd700;font-weight:900;font-size:.7rem}
    .deal-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .deal-col{text-align:center}
    .side-tag{display:inline-block;padding:2px 10px;border-radius:6px;color:#fff;font-weight:900;font-size:.7rem;margin-bottom:4px}
    .side-tag.tp{background:var(--player)} .side-tag.tb{background:var(--banker)}
    .card-row{display:flex;justify-content:center;gap:4px;height:60px;min-height:60px;align-items:center;flex-wrap:nowrap;overflow:hidden}
    .deal-score{font-size:1.5rem;font-weight:1000;color:#ffd700;margin-top:4px}
    .deal-result{text-align:center;margin-top:8px;font-weight:900;font-size:.8rem;padding:6px;border-radius:6px;background:rgba(0,0,0,.2)}
    .mini-card{width:38px;height:56px;background:#fff;border-radius:5px;border:1px solid #ccc;box-shadow:0 2px 8px rgba(0,0,0,.3);display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:Georgia,serif;font-weight:900;flex:0 0 auto}
    .mini-card .cr{font-size:.85rem;line-height:1}
    .mini-card .cs{font-size:.75rem;line-height:1;margin-top:1px}
    .mini-card.red{color:#c0392b} .mini-card.black{color:#2c3e50}
    .mini-card.down{background:linear-gradient(135deg,#1a3a5c,#2c5f8a);border:2px solid #3a7abd}
    .mini-card.down .cr,.mini-card.down .cs{display:none}
    .mini-card.down::after{content:'üÇ†';font-size:1.3rem;color:rgba(255,255,255,.3)}
    .mini-card.burn-reveal{border:2px solid #f44;box-shadow:0 0 12px rgba(255,68,68,.5)}
    .mini-card.placeholder{visibility:hidden}
    .shoe-newbtn{background:linear-gradient(135deg,#ffd700,#f39c12);color:#2c3e50;border:none;padding:8px 10px;border-radius:6px;font-weight:900;cursor:pointer;font-size:.75rem;white-space:nowrap}

    /* ===== Session History UI ===== */
    .sess-box{background:#ffffff;border:1px solid #e8e8e8;border-radius:10px;padding:10px}
    .sess-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
    .sess-head .t{font-weight:900;color:var(--primary);font-size:.8rem}
    .sess-actions{display:flex;gap:6px;flex-wrap:wrap}
    .btn-mini{border:none;border-radius:6px;padding:6px 8px;font-size:.7rem;font-weight:900;cursor:pointer}
    .btn-mini.export{background:var(--comm);color:#fff}
    .btn-mini.clear{background:#ecf0f1;color:#2c3e50;border:1px solid #d0d0d0}
    .sess-table-wrap{max-height:240px;overflow:auto;border:1px solid #eee;border-radius:8px}
    table.sess-table{width:100%;border-collapse:collapse;font-size:.72rem}
    .sess-table th,.sess-table td{padding:6px 6px;border-bottom:1px solid #f0f0f0;vertical-align:top;white-space:nowrap}
    .sess-table th{position:sticky;top:0;background:#f8f9fb;z-index:2;text-align:left;color:#6c7a89;font-weight:900}
    .pos{color:var(--success);font-weight:900}
    .neg{color:var(--danger);font-weight:900}
    .muted{color:#7f8c8d}

    @media(max-width:768px){
      body{overflow-y:auto;height:auto;display:block}
      .container{grid-template-columns:1fr;height:auto;display:flex;flex-direction:column;gap:20px;padding-bottom:30px}
      .sidebar{height:auto}
      .main-content{height:auto;overflow:visible}
      .stats-grid{grid-template-columns:repeat(2,1fr)}
      .chart-box{min-height:300px}
    }
  </style>
</head>
<body>

<div class="container">
  <div class="sidebar">
    <div class="section-title" style="justify-content:center;border-bottom:none">
      <span class="badge-ult" style="font-size:.8rem;padding:5px 10px;">V3.4 FULL: SHOE + COMM + SESSIONS</span>
    </div>

    <button class="btn-reset" onclick="resetAll()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Hard Reset)</button>

    <div class="section-title">üß™ ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ú‡∏• (Top)</div>
    <div class="form-group">
      <label>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏° (RNG Algorithm)</label>
      <select id="rng_method" onchange="onRngChange(); syncSimSettings('top')">
        <option value="math">üé≤ Standard (Math.random)</option>
        <option value="crypto">üîí Crypto Secure</option>
        <option value="shoe" selected>üÉè Real 8-Deck Shoe</option>
      </select>
    </div>

    <div class="shoe-ui" id="shoe_ui">
      <div class="shoe-hdr">
        <div>
          <div class="t">üÉè 8-Deck Shoe ‚Äî Casino Real</div>
          <div class="sub">Burn Card + Cut Card (Penetration)</div>
        </div>
        <select id="shoe_pen" onchange="onPenChange()">
          <option value="50">‡πÉ‡∏ä‡πâ‡πÑ‡∏û‡πà 50%</option>
          <option value="60" selected>‡πÉ‡∏ä‡πâ‡πÑ‡∏û‡πà 60%</option>
          <option value="70">‡πÉ‡∏ä‡πâ‡πÑ‡∏û‡πà 70%</option>
          <option value="80">‡πÉ‡∏ä‡πâ‡πÑ‡∏û‡πà 80%</option>
        </select>
      </div>

      <div class="shoe-bar">
        <div class="shoe-bar-fill" id="sb_fill"></div>
        <div class="shoe-cut" id="sb_cut" style="left:60%"></div>
        <div class="shoe-bar-txt" id="sb_txt">0 / 416 (0.0%)</div>
      </div>

      <div class="shoe-grid">
        <div class="shoe-bx"><div class="lb">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div><div class="vl" id="sh_rem">416</div></div>
        <div class="shoe-bx"><div class="lb">‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß</div><div class="vl" id="sh_used">0</div></div>
        <div class="shoe-bx"><div class="lb">Shoe #</div><div class="vl" id="sh_no">0</div></div>
      </div>

      <div class="burn-box" id="burn_box" style="display:none">
        <div class="bt">üî• Burn Card Ceremony</div>
        <div class="burn-row">
          <span style="color:#ffd7d7;font-size:.65rem">‡πÑ‡∏û‡πà‡∏´‡∏á‡∏≤‡∏¢:</span>
          <span id="burn_card_slot"></span>
          <span id="burn_label" style="color:#ffd7d7;font-size:.7rem;font-weight:900"></span>
        </div>
        <div class="burn-row" id="burn_down_row" style="margin-top:4px"></div>
        <div class="burn-note" id="burn_note"></div>
      </div>

      <div class="deal-area" id="deal_area" style="display:none">
        <div class="deal-head">
          <span>üìã ‡∏ï‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
          <button class="shoe-newbtn" onclick="initShoe(true)">üîÑ ‡∏™‡∏±‡∏ö‡πÑ‡∏û‡πà‡πÉ‡∏´‡∏°‡πà</button>
        </div>
        <div class="deal-grid">
          <div class="deal-col">
            <div class="side-tag tp">PLAYER</div>
            <div class="card-row" id="pc_row"></div>
            <div class="deal-score" id="pc_sc">-</div>
          </div>
          <div class="deal-col">
            <div class="side-tag tb">BANKER</div>
            <div class="card-row" id="bc_row"></div>
            <div class="deal-score" id="bc_sc">-</div>
          </div>
        </div>
        <div class="deal-result" id="deal_res" style="color:#ffd700">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡∏Å‡πÑ‡∏û‡πà...</div>
      </div>
    </div>

    <div class="form-group">
      <input type="number" id="sim_hands" value="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≤" oninput="syncSimSettings('top')" />
      <button class="btn-action btn-sim" onclick="runSimulation()">‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ú‡∏• (Simulate)</button>

      <label style="margin-top:10px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß Auto Sim:</label>
      <select id="sim_speed" onchange="syncSimSettings('top')">
        <option value="0">üöÄ ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Instant)</option>
        <option value="20" selected>‚ö° ‡πÄ‡∏£‡πá‡∏ß (Fast)</option>
      </select>

      <button class="btn-action btn-auto" id="btn_auto_sim" onclick="toggleAutoSim()">üöÄ Auto Sim</button>
      <button class="btn-action btn-stop" id="btn_stop_sim" onclick="stopAutoSim()">‚èπ STOP</button>

      <div id="sim_stats_display" style="display:none;font-size:.75rem;text-align:center;margin-top:5px;">
        ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà: <span id="sim_round_count">0</span> | ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <span id="sim_success_count" style="color:green;">0</span>
      </div>
    </div>

    <div class="section-title">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Settings)</div>
    <div class="form-group">
      <label>‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå (Strategy Mode)</label>
      <select id="strat_mode" onchange="updateUI()">
        <option value="offset" selected>‚öñÔ∏è Offset (‡∏™‡∏°‡∏î‡∏∏‡∏• P-B)</option>
        <option value="anti_last">‚ö° Anti Last (‡∏™‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏¥‡∏î)</option>
        <option value="follow_last">üåä Follow Last (‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏ï‡∏¥‡∏î)</option>
      </select>
    </div>

    <div class="comm-box">
      <div class="comm-title">
        <span>üí∞ Commission / Rolling Rebate</span>
        <button class="btn-guide" onclick="showGuideModal()">üìñ ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</button>
      </div>
      <div class="form-group">
        <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏° / ‡πÇ‡∏£‡∏•‡∏•‡∏¥‡πà‡∏á (%)</label>
        <input type="number" id="commission_rate" value="0.9" step="0.01" min="0" oninput="updateUI()">
        <div style="font-size:.6rem;color:var(--comm);margin-top:2px;">*‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á</div>
      </div>
      <div class="comm-grid">
        <div class="comm-stat"><div class="lb">‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏°</div><div class="vl" id="comm_turnover">0</div></div>
        <div class="comm-stat"><div class="lb">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏™‡∏∞‡∏™‡∏°</div><div class="vl" id="comm_total">0</div></div>
        <div class="comm-stat"><div class="lb">‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô</div><div class="vl" id="comm_hands">0</div></div>
        <div class="comm-stat"><div class="lb">Net + ‡∏Ñ‡∏≠‡∏°</div><div class="vl" id="comm_net_plus">0</div></div>
      </div>
    </div>

    <!-- ===== NEW: Lifetime Stats (‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°) ===== -->
    <div class="section-title">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°)</div>
    <div class="comm-box" style="border-color:#cfe2ff;background:#f7fbff">
      <div class="comm-title" style="color:#1d4ed8">
        <span>Lifetime Stats</span>
      </div>

      <div class="comm-grid">
        <div class="comm-stat" style="background:rgba(29,78,216,.06)">
          <div class="lb">Net Profit ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          <div class="vl" id="all_net">0</div>
        </div>

        <div class="comm-stat" style="background:rgba(29,78,216,.06)">
          <div class="lb">Net + Commission ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          <div class="vl" id="all_net_comm">0</div>
        </div>

        <div class="comm-stat" style="background:rgba(29,78,216,.06)">
          <div class="lb">Max Drawdown ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏ô</div>
          <div class="vl" id="all_max_dd">0</div>
        </div>

        <div class="comm-stat" style="background:rgba(29,78,216,.06)">
          <div class="lb">Max Bet ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏ô</div>
          <div class="vl" id="all_max_bet">0</div>
        </div>
      </div>
    </div>
    <!-- ===== /NEW ===== -->

    <div class="target-box">
      <div class="target-title">üéØ Target Profit (‡πÄ‡∏õ‡πâ‡∏≤‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö) (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà)</div>
      <div class="form-group">
        <label>Reset Cycle if Profit >=</label>
        <input type="number" id="target_profit" value="40">
      </div>
    </div>
    <div class="feature-box" style="border-color: var(--dragon);">
      <div class="feature-title" style="color: var(--dragon);">üêâ Dragon Logic (‡∏ï‡∏±‡∏î‡∏°‡∏±‡∏á‡∏Å‡∏£)</div>
      <div class="form-group">
        <label>Stop if Streak >=</label>
        <input type="number" id="dragon_limit" value="7">
      </div>
    </div>

    <div class="feature-box">
      <div class="feature-title">üîí Trailing Stop</div>
      <div class="dual-input">
        <div class="form-group"><label>Start (Profit)</label><input type="number" id="trail_start" value="11"></div>
        <div class="form-group"><label>Drop (%)</label><input type="number" id="trail_drop" value="17.3"></div>
      </div>
    </div>

    <div class="feature-box">
      <div class="feature-title">üå™Ô∏è Chaos Filter</div>
      <div class="form-group">
        <label>Zigzag Limit (Last 10)</label>
        <select id="chaos_limit" onchange="updateUI()">
          <option value="5" selected>5/10</option>
          <option value="9">9/10</option>
          <option value="11">Disable</option>
        </select>
      </div>
    </div>

    <div class="feature-box" id="survival_box">
      <div class="feature-title">üõ°Ô∏è Survival Mode</div>
      <div class="dual-input">
        <div class="form-group"><label>Trigger DD%</label><input type="number" id="surv_trigger" value="46"></div>
        <div class="form-group"><label>Div Multiplier</label><input type="number" id="surv_div" value="2.04"></div>
      </div>
    </div>

    <div class="form-group"><label>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô (Bankroll)=MINBETX2000</label><input type="number" id="init_bank" value="20000"></div>
    <div class="form-group"><label>Max Bet Cap=MINBETX2000</label><input type="number" id="max_bet_cap" value="20000"></div>
    <div class="form-group"><label>Rebalance Adaptivity</label><input type="number" id="rebalance_val" value="4.62" step="0.01"></div>

    <div class="dual-input">
      <div class="form-group"><label>Min Bet</label><input type="number" id="min_bet" value="10"></div>
      <div class="form-group"><label style="color:var(--primary);">Chip Unit</label><input type="number" id="chip_size" value="10" style="border:2px solid var(--primary);font-weight:bold"></div>
    </div>

    <button class="btn-restore" onclick="restoreRecommended()">‚Ü∫ ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ V3.4</button>

    <div class="section-title">üéØ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status)</div>
    <div class="monitor-box">
      <span class="monitor-label">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ / High Water Mark</span>
      <div id="target_status_display" class="monitor-val">0 / 0</div>
      <div class="cycle-monitor">
        <span>Cycle Profit:</span>
        <span id="cycle_profit_disp" style="color:var(--target);font-weight:bold;">0</span>
      </div>
      <div style="font-size:.6rem;color:#bdc3c7;margin-top:4px;" id="trailing_info">Trailing Inactive</div>
      <div style="font-size:.7rem;color:#d7f7e6;margin-top:8px;">
        ‡∏ó‡∏∏‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°): <b id="bankroll_left_disp">0</b><br/>
        Session #: <b id="session_no_disp">0</b> | Sessions Saved: <b id="session_saved_disp">0</b>
      </div>
    </div>

    <!-- ===== Session History on Sidebar ===== -->
    <div class="sess-box">
      <div class="sess-head">
        <div class="t">üìí Session History (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</div>
        <div class="sess-actions">
          <button class="btn-mini export" onclick="exportSessionHistory()">Export JSON</button>
          <button class="btn-mini clear" onclick="clearSessionHistory()">Clear</button>
        </div>
      </div>
      <div class="sess-table-wrap">
        <table class="sess-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Reason</th>
              <th>Hands</th>
              <th>Net+Comm</th>
              <th>Comm</th>
              <th>Turn</th>
              <th>Left</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody id="session_table_body">
            <tr><td colspan="8" class="muted" style="padding:10px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ session ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td></tr>
          </tbody>
        </table>
      </div>
      <div class="muted" style="font-size:.68rem;margin-top:6px;line-height:1.5">
        * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: ‡∏ñ‡∏∂‡∏á Target Profit ‡∏´‡∏£‡∏∑‡∏≠ Trailing Stop ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ BankrollLeft &lt; MinBet/‚â§ 0 ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏° session ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      </div>
    </div>

    <div class="section-title">üß† AI Brain Monitor</div>
    <div class="brain-monitor">
      <div class="brain-col">
        <div class="brain-head txt-p">PLAYER AI</div>
        <div class="brain-val txt-p" id="mon_p_req">0</div>
        <div class="brain-info" id="mon_p_info">Wait:0</div>
      </div>
      <div class="brain-col">
        <div class="brain-head txt-b">BANKER AI</div>
        <div class="brain-val txt-b" id="mon_b_req">0</div>
        <div class="brain-info" id="mon_b_info">Wait:0</div>
      </div>
    </div>

    <div class="section-title">üß™ ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ú‡∏• (Bottom)</div>
    <div class="form-group">
      <label>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°</label>
      <select id="rng_method_bot" onchange="onRngChange(); syncSimSettings('bot')">
        <option value="math">üé≤ Standard</option>
        <option value="crypto">üîí Crypto</option>
        <option value="shoe" selected>üÉè Real Shoe</option>
      </select>
    </div>

    <div class="form-group">
      <input type="number" id="sim_hands_bot" value="1" oninput="syncSimSettings('bot')">
      <button class="btn-action btn-sim" onclick="runSimulation()">‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ú‡∏• (Simulate)</button>

      <label style="margin-top:10px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß Auto Sim:</label>
      <select id="sim_speed_bot" onchange="syncSimSettings('bot')">
        <option value="0">üöÄ ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</option>
        <option value="20" selected>‚ö° ‡πÄ‡∏£‡πá‡∏ß</option>
      </select>

      <button class="btn-action btn-auto" id="btn_auto_sim_bot" onclick="toggleAutoSim()">üöÄ Auto Sim</button>
      <button class="btn-action btn-stop" id="btn_stop_sim_bot" onclick="stopAutoSim()">‚èπ STOP</button>

      <div id="sim_stats_display_bot" style="display:none;font-size:.75rem;text-align:center;margin-top:5px;">
        ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà: <span id="sim_round_count_bot">0</span> | ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <span id="sim_success_count_bot" style="color:green;">0</span>
      </div>
    </div>

    <button class="btn-reset" onclick="resetAll()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Hard Reset)</button>
  </div>

  <div class="main-content">
    <div class="stats-grid">
      <div class="stat-card profit">
        <div class="stat-label">Net Profit</div>
        <div class="stat-value" id="disp_net">0</div>
      </div>
      <div class="stat-card comm">
        <div class="stat-label">Net + Commission</div>
        <div class="stat-value" id="disp_net_comm" style="color:var(--comm);">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Max Drawdown</div>
        <div class="stat-value" id="disp_dd">0</div>
      </div>
      <div class="stat-card loss">
        <div class="stat-label">Max Bet</div>
        <div class="stat-value" id="disp_maxbet">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Hands</div>
        <div class="stat-value" id="disp_hands">0</div>
      </div>
      <div class="stat-card pre">
        <div class="stat-label">Dragon</div>
        <div class="stat-value" id="disp_dragon">0</div>
      </div>
      <div class="stat-card pre">
        <div class="stat-label">Chaos</div>
        <div class="stat-value" id="disp_chaos">0</div>
      </div>
      <div class="stat-card comm">
        <div class="stat-label">Commission Total</div>
        <div class="stat-value" id="disp_comm_total" style="color:var(--comm);">0</div>
      </div>
    </div>

    <div class="road-scroll-wrapper">
      <div class="big-road-grid" id="road_container"></div>
    </div>

    <div class="bet-panel">
      <div class="offset-formula" id="formula_disp">Strategy: Offset</div>
      <div class="rec-amount" id="rec_amount">0</div>
      <div class="rec-side side-n" id="rec_side">WAIT</div>
      <div class="controls">
        <button class="btn-ctrl btn-p" onclick="processResult('P')">PLAYER</button>
        <button class="btn-ctrl btn-b" onclick="processResult('B')">BANKER</button>
        <button class="btn-ctrl btn-u" onclick="undo()">UNDO</button>
      </div>
    </div>

    <div class="chart-box">
      <canvas id="profitChart"></canvas>
    </div>
  </div>
</div>

<!-- Risk Modal -->
<div class="modal-overlay" id="riskModal">
  <div class="modal-box" style="border-top:5px solid #c0392b;">
    <div class="modal-icon">‚ö†Ô∏è</div>
    <div class="modal-text-th" style="color:#c0392b;">Session End</div>
    <div class="risk-stat-box">
      <div class="risk-row"><span>Reason:</span><span class="risk-val" id="risk_reason">-</span></div>
      <div class="risk-row"><span>Net:</span><span class="risk-val" id="risk_dd">-</span></div>
      <div class="risk-row"><span>‡∏ó‡∏∏‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span><span class="risk-val" id="risk_left">-</span></div>
    </div>
    <button class="btn-modal-ack" style="background:#c0392b;" onclick="closeRiskModal()">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

<!-- Guide Modal -->
<div class="modal-overlay" id="guideModal">
  <div class="modal-box" style="border:2px solid var(--comm); text-align:left;">
    <div class="modal-icon" style="width:100%;text-align:center;">üí∞</div>
    <div class="modal-text-th" style="color:var(--comm); text-align:center;">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
    <div style="font-size:.9rem;line-height:1.8;color:#2c3e50;margin-top:10px;">
      Take profits in short rounds. Once your Net Profit is positive, restart your session.
    </div>
    <button class="btn-modal-ack" style="background:var(--comm);" onclick="closeGuideModal()">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß ‚úì</button>
  </div>
</div>

<script>
/* =========================
   Real Shoe Engine (8 Deck + Burn Card)
   ========================= */
const SUITS=['‚ô†','‚ô•','‚ô¶','‚ô£'];
const RANKS=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
const BAC_VAL={A:1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':0,J:0,Q:0,K:0};
const BURN_VAL={A:1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,J:10,Q:10,K:10};

let shoe={deck:[],total:416,used:0,no:0,pen:60,lastHand:null,burnInfo:null,ready:false};

function isRedSuit(s){return s==='‚ô•'||s==='‚ô¶';}
function cryptoRandInt(maxExclusive){
  if(window.crypto && window.crypto.getRandomValues){
    const a=new Uint32Array(1); window.crypto.getRandomValues(a); return a[0]%maxExclusive;
  }
  return Math.floor(Math.random()*maxExclusive);
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=cryptoRandInt(i+1);
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function build8Deck(){
  const d=[];
  for(let k=0;k<8;k++) for(const s of SUITS) for(const r of RANKS) d.push({rank:r,suit:s,v:BAC_VAL[r]});
  return d;
}
function bacScore(cards){
  let t=0; for(const c of cards) t+=c.v; return t%10;
}
function makeCardEl(card, faceDown=false){
  const div=document.createElement('div');
  div.className='mini-card'+(faceDown?' down':(isRedSuit(card.suit)?' red':' black'));
  if(!faceDown) div.innerHTML=`<div class="cr">${card.rank}</div><div class="cs">${card.suit}</div>`;
  return div;
}
function makeBurnRevealEl(card){
  const el=makeCardEl(card,false); el.classList.add('burn-reveal'); return el;
}
function shoeNeedCut(){
  const cutPoint=Math.floor(shoe.total*(shoe.pen/100));
  return shoe.used>=cutPoint || shoe.deck.length<6;
}
function shoeDraw(){
  if(shoe.deck.length===0) return null;
  shoe.used++; return shoe.deck.pop();
}
function doBurnCeremony(){
  const reveal=shoeDraw(); if(!reveal) return;
  const burnN=BURN_VAL[reveal.rank];
  const downs=[];
  for(let i=0;i<burnN;i++){ const c=shoeDraw(); if(!c) break; downs.push(c); }
  shoe.burnInfo={reveal,burnN,downs};

  document.getElementById('burn_box').style.display='block';
  const slot=document.getElementById('burn_card_slot');
  slot.innerHTML=''; slot.appendChild(makeBurnRevealEl(reveal));
  document.getElementById('burn_label').innerText=`${reveal.rank}${reveal.suit} ‚Üí ‡∏ó‡∏¥‡πâ‡∏á‡∏Ñ‡∏ß‡πà‡∏≥ ${burnN} ‡πÉ‡∏ö`;
  const row=document.getElementById('burn_down_row');
  row.innerHTML=''; downs.forEach(c=>row.appendChild(makeCardEl(c,true)));
  document.getElementById('burn_note').innerText=
`‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ö‡∏≤‡∏Ñ‡∏≤‡∏£‡πà‡∏≤:
- ‡∏´‡∏á‡∏≤‡∏¢‡πÑ‡∏û‡πà‡πÉ‡∏ö‡πÅ‡∏£‡∏Å‡∏î‡∏π‡πÅ‡∏ï‡πâ‡∏°
- ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà‡πÉ‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ß‡πà‡∏≥‡∏ï‡∏≤‡∏°‡πÅ‡∏ï‡πâ‡∏°
A=1, 2-9=‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç, 10/J/Q/K=10
‡∏£‡∏ß‡∏°‡πÑ‡∏û‡πà‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏≠‡∏≠‡∏Å: ${burnN+1} ‡πÉ‡∏ö`;
}
function initShoe(force=false){
  if(shoe.ready && !force) return;
  const d=shuffle(shuffle(shuffle(build8Deck())));
  shoe.deck=d; shoe.total=d.length; shoe.used=0; shoe.no++;
  shoe.lastHand=null; shoe.burnInfo=null; shoe.ready=true;
  shoe.pen=parseInt(document.getElementById('shoe_pen').value)||60;
  doBurnCeremony();
  refreshShoeUI();
}
function dealBaccarat(){
  if(!shoe.ready) initShoe(true);
  if(shoeNeedCut()) initShoe(true);

  const P=[shoeDraw(),shoeDraw()];
  const B=[shoeDraw(),shoeDraw()];
  if(!P[0]||!P[1]||!B[0]||!B[1]){ initShoe(true); return dealBaccarat(); }

  let p=bacScore(P), b=bacScore(B);
  const pNat=p>=8, bNat=b>=8;
  let pThird=null;

  if(!pNat && !bNat){
    if(p<=5){
      pThird=shoeDraw();
      if(pThird){ P.push(pThird); p=bacScore(P); }
    }
    if(pThird===null){
      if(b<=5){
        const b3=shoeDraw();
        if(b3){ B.push(b3); b=bacScore(B); }
      }
    }else{
      const pt=pThird.v;
      let bankerDraw=false;
      if(b<=2) bankerDraw=true;
      else if(b===3 && pt!==8) bankerDraw=true;
      else if(b===4 && pt>=2 && pt<=7) bankerDraw=true;
      else if(b===5 && pt>=4 && pt<=7) bankerDraw=true;
      else if(b===6 && pt>=6 && pt<=7) bankerDraw=true;

      if(bankerDraw){
        const b3=shoeDraw();
        if(b3){ B.push(b3); b=bacScore(B); }
      }
    }
  }

  const res=(p>b)?'P':(b>p?'B':'T');
  shoe.lastHand={P,B,p,b,res};
  refreshShoeUI();
  return res;
}
function refreshShoeUI(){
  const ui=document.getElementById('shoe_ui');
  if(!ui) return;

  const m=document.getElementById('rng_method').value;
  if(m!=='shoe'){ ui.classList.remove('active'); return; }
  ui.classList.add('active');
  if(!shoe.ready) return;

  const pct=(shoe.used/shoe.total)*100;
  document.getElementById('sb_fill').style.width=pct.toFixed(1)+'%';
  document.getElementById('sb_txt').innerText=`${shoe.used} / ${shoe.total} (${pct.toFixed(1)}%)`;
  document.getElementById('sb_cut').style.left=shoe.pen+'%';
  document.getElementById('sh_rem').innerText=shoe.total-shoe.used;
  document.getElementById('sh_used').innerText=shoe.used;
  document.getElementById('sh_no').innerText=shoe.no;

  const dealArea=document.getElementById('deal_area');
  if(shoe.lastHand){
    dealArea.style.display='block';
    const pc=document.getElementById('pc_row');
    const bc=document.getElementById('bc_row');
    pc.innerHTML=''; bc.innerHTML='';
    shoe.lastHand.P.forEach(c=>pc.appendChild(makeCardEl(c,false)));
    shoe.lastHand.B.forEach(c=>bc.appendChild(makeCardEl(c,false)));

    while(pc.children.length<3){ const ph=document.createElement('div'); ph.className='mini-card placeholder'; pc.appendChild(ph); }
    while(bc.children.length<3){ const ph=document.createElement('div'); ph.className='mini-card placeholder'; bc.appendChild(ph); }

    document.getElementById('pc_sc').innerText=shoe.lastHand.p;
    document.getElementById('bc_sc').innerText=shoe.lastHand.b;

    const dr=document.getElementById('deal_res');
    if(shoe.lastHand.res==='P'){ dr.innerText=`üîµ PLAYER WIN ‚Äî P:${shoe.lastHand.p} vs B:${shoe.lastHand.b}`; dr.style.color='#3498db'; }
    else if(shoe.lastHand.res==='B'){ dr.innerText=`üî¥ BANKER WIN ‚Äî P:${shoe.lastHand.p} vs B:${shoe.lastHand.b}`; dr.style.color='#e74c3c'; }
    else { dr.innerText=`üü¢ TIE ‚Äî P:${shoe.lastHand.p} vs B:${shoe.lastHand.b}`; dr.style.color='#27ae60'; }
  }else{
    dealArea.style.display='none';
  }
}
function onPenChange(){
  shoe.pen=parseInt(document.getElementById('shoe_pen').value)||60;
  document.getElementById('sb_cut').style.left=shoe.pen+'%';
  if(document.getElementById('rng_method').value==='shoe' && !shoe.ready) initShoe(true);
  refreshShoeUI();
}
function onRngChange(){
  const m=document.getElementById('rng_method').value;
  const ui=document.getElementById('shoe_ui');
  if(m==='shoe'){
    ui.classList.add('active');
    initShoe(false);
    refreshShoeUI();
  }else{
    ui.classList.remove('active');
  }
}

/* =========================
   Core System + Commission + Sessions + Bankroll Cap
   ========================= */
let state={
  realBalance:0, history:[], maxDrawdown:0, maxBet:0,
  highWaterMark:0, targetReached:false, survivalActive:false,
  cycleStartBalance:0,
  pStrat:{bal:0,wait:0,stage:0,initBet:0,cons_loss:0},
  bStrat:{bal:0,wait:0,stage:0,initBet:0,cons_loss:0},
  graphData:[0], graphLabels:[0],
  commTurnover:0, commTotal:0, commHands:0
};

// ===== NEW: Lifetime (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°) =====
let lifetime = {
  net: 0,
  comm: 0,
  maxBet: 0,
  highWater: 0,
  maxDrawdown: 0
};
function lifetimeEquity(){
  return lifetime.net + lifetime.comm;
}
function updateLifetimeUI(){
  const netAll = lifetime.net;
  const netCommAll = lifetimeEquity();

  const elNet = document.getElementById('all_net');
  const elNetComm = document.getElementById('all_net_comm');
  const elDD = document.getElementById('all_max_dd');
  const elMaxBet = document.getElementById('all_max_bet');

  if(elNet){
    elNet.innerText = netAll.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    elNet.style.color = netAll>=0 ? 'var(--success)' : 'var(--danger)';
  }
  if(elNetComm){
    elNetComm.innerText = netCommAll.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    elNetComm.style.color = netCommAll>=0 ? 'var(--success)' : 'var(--danger)';
  }
  if(elDD){
    elDD.innerText = lifetime.maxDrawdown.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    elDD.style.color = lifetime.maxDrawdown<=0 ? 'var(--danger)' : 'var(--text)';
  }
  if(elMaxBet){
    elMaxBet.innerText = lifetime.maxBet.toLocaleString();
  }
}
// ===== /NEW =====

let undoStack=[];
let chartInstance=null;
let isAutoRunning=false;
let simRoundCount=0;
let simSuccessCount=0;
let autoTimer=null;

// ===== Sessions =====
let sessionHistory = [];
let sessionNo = 0;
let sessionStartTs = Date.now();

const DEFAULT_DIVISOR=2.0;

function getBankroll(){ return parseFloat(document.getElementById('init_bank').value)||0; }
function getMinBet(){ return parseFloat(document.getElementById('min_bet').value)||0; }
function getChip(){ return parseFloat(document.getElementById('chip_size').value)||1; }

// ‡∏ó‡∏∏‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏£‡∏¥‡∏á = bankroll + net + commission
function getBankrollLeft(){
  return getBankroll() + state.realBalance + state.commTotal;
}

function disablePlayButtons(disabled){
  document.querySelectorAll('.btn-ctrl').forEach(b=>{ b.disabled = !!disabled; });
}

function capBetToBankroll(netBet){
  if(netBet<=0) return 0;
  const chip=getChip();
  const left=getBankrollLeft();
  const minBet=getMinBet();
  if(left<=0) return 0;
  const capped=Math.floor(Math.min(netBet,left)/chip)*chip;
  if(capped<minBet) return 0;
  return capped;
}

function renderSessionHistory(){
  const body=document.getElementById('session_table_body');
  if(!body) return;
  if(sessionHistory.length===0){
    body.innerHTML=`<tr><td colspan="8" class="muted" style="padding:10px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ session ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td></tr>`;
    return;
  }
  const rows=sessionHistory.slice(-60).reverse().map(s=>{
    const cls=(s.netPlusComm>=0)?'pos':'neg';
    const t=new Date(s.tsEnd);
    const timeStr=t.toLocaleString('th-TH',{hour12:false});
    const reason=String(s.reason||'').slice(0,20);
    return `
      <tr>
        <td>${s.sessionNo}</td>
        <td title="${s.reason}">${reason}</td>
        <td>${s.hands}</td>
        <td class="${cls}">${(s.netPlusComm||0).toFixed(2)}</td>
        <td>${(s.comm||0).toFixed(2)}</td>
        <td>${(s.turnover||0).toFixed(0)}</td>
        <td>${(s.bankrollLeft||0).toFixed(2)}</td>
        <td class="muted">${timeStr}</td>
      </tr>
    `;
  }).join('');
  body.innerHTML=rows;
}

function exportSessionHistory(){
  const blob=new Blob([JSON.stringify(sessionHistory,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`sessionHistory_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function clearSessionHistory(){
  if(!confirm("‡∏•‡πâ‡∏≤‡∏á Session History ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) return;
  sessionHistory=[];
  renderSessionHistory();
  updateUI();
}

function startNewSession(){
  sessionNo += 1;
  sessionStartTs = Date.now();

  state.realBalance=0; state.history=[]; state.maxDrawdown=0; state.maxBet=0;
  state.highWaterMark=0; state.targetReached=false; state.survivalActive=false;
  state.cycleStartBalance=0;
  state.pStrat={bal:0,wait:0,stage:0,initBet:0,cons_loss:0};
  state.bStrat={bal:0,wait:0,stage:0,initBet:0,cons_loss:0};
  state.graphData=[0]; state.graphLabels=[0];
  state.commTurnover=0; state.commTotal=0; state.commHands=0;
  undoStack=[];
  disablePlayButtons(false);
}

function closeSessionAndRestart(reason){
  const net=state.realBalance;
  const comm=state.commTotal;
  const netPlusComm=net+comm;
  sessionHistory.push({
    sessionNo: sessionNo||1,
    reason,
    tsStart: sessionStartTs,
    tsEnd: Date.now(),
    hands: state.history.length,
    net,
    comm,
    netPlusComm,
    turnover: state.commTurnover,
    betHands: state.commHands,
    bankroll: getBankroll(),
    bankrollLeft: getBankrollLeft(),
    minBet: getMinBet()
  });
  startNewSession();
  renderSessionHistory();
}

// ‡∏à‡∏ö session ‡πÄ‡∏°‡∏∑‡πà‡∏≠: bankrollLeft <= 0 ‡∏´‡∏£‡∏∑‡∏≠ bankrollLeft < minBet
function checkAndEndSessionIfNeeded(isSim){
  const left=getBankrollLeft();
  const minBet=getMinBet();
  if(left<=0){
    closeSessionAndRestart("Bankroll Empty (<= 0)");
    if(!isSim) updateUI();
    return true;
  }
  if(left<minBet){
    closeSessionAndRestart("Bankroll < MinBet");
    if(!isSim) updateUI();
    return true;
  }
  return false;
}

/* ===== NEW: Session End Rules (Optimize-style) =====
   - End session when Cycle Profit >= Target Profit
   - End session when Trailing Stop hits
*/
function checkAndEndSessionByTargetOrTrailing(isSim){
  const targetProfit = parseFloat(document.getElementById('target_profit').value) || 0;

  // ----- Target Profit (Cycle) -----
  const cycleProfit = state.realBalance - state.cycleStartBalance;
  if(targetProfit > 0 && cycleProfit >= targetProfit){
    closeSessionAndRestart(`Target Profit Reached (Cycle +${cycleProfit.toFixed(2)})`);
    if(!isSim) updateUI();
    return true;
  }

  // ----- Trailing Stop -----
  const trailStart=parseFloat(document.getElementById('trail_start').value);
  const trailDrop=parseFloat(document.getElementById('trail_drop').value);

  // update HWM after reaching start
  if(state.realBalance>=trailStart && state.realBalance>state.highWaterMark){
    state.highWaterMark=state.realBalance;
  }

  // if active, check drop
  if(state.highWaterMark>=trailStart){
    const cutLine=state.highWaterMark*(1-(trailDrop/100));
    if(state.realBalance<=cutLine){
      closeSessionAndRestart(`Trailing Stop Hit (HWM ${state.highWaterMark.toFixed(2)} ‚Üí Cut ${cutLine.toFixed(2)})`);
      if(!isSim) updateUI();
      return true;
    }
  }

  return false;
}

function syncSimSettings(source){
  if(source==='top'){
    document.getElementById('sim_hands_bot').value=document.getElementById('sim_hands').value;
    document.getElementById('sim_speed_bot').value=document.getElementById('sim_speed').value;
    document.getElementById('rng_method_bot').value=document.getElementById('rng_method').value;
  }else{
    document.getElementById('sim_hands').value=document.getElementById('sim_hands_bot').value;
    document.getElementById('sim_speed').value=document.getElementById('sim_speed_bot').value;
    document.getElementById('rng_method').value=document.getElementById('rng_method_bot').value;
  }
  onRngChange();
}

function generateOutcome(){
  const method=document.getElementById('rng_method').value;
  if(method==='crypto'){
    const array=new Uint32Array(1);
    window.crypto.getRandomValues(array);
    const val=array[0]/(0xFFFFFFFF+1);
    return val<0.4932?'P':'B';
  }
  if(method==='shoe') return dealBaccarat();
  return Math.random()<0.4932?'P':'B';
}

function restoreRecommended(){
  document.getElementById('init_bank').value=20000;
  document.getElementById('strat_mode').value="offset";
  document.getElementById('min_bet').value=10;
  document.getElementById('chip_size').value=10;
  document.getElementById('target_profit').value=40;
  document.getElementById('trail_start').value=11;
  document.getElementById('trail_drop').value=17.3;
  document.getElementById('chaos_limit').value=9;
  document.getElementById('surv_trigger').value=46;
  document.getElementById('surv_div').value=2.04;
  document.getElementById('dragon_limit').value=7;
  document.getElementById('max_bet_cap').value=20000;
  document.getElementById('rebalance_val').value=4.62;
  document.getElementById('commission_rate').value="0.9";
  document.getElementById('rng_method').value='shoe';
  document.getElementById('shoe_pen').value='60';
  syncSimSettings('top');
  updateUI();
}

function roundToChip(val){
  const chip=getChip();
  const min=getMinBet();
  if(val<=0) return 0;
  const rounded=Math.ceil(val/chip)*chip;
  return Math.max(min,rounded);
}

function calculateDivisor(deficit,minBet){
  let baseDiv=DEFAULT_DIVISOR;
  const bank=getBankroll();
  const survTrigger=parseFloat(document.getElementById('surv_trigger').value);
  const survMult=parseFloat(document.getElementById('surv_div').value);

  let currentDD = state.realBalance<0 ? Math.abs(state.realBalance) : 0;
  let ddPercent=(bank>0)?(currentDD/bank)*100:0;

  if(ddPercent>=survTrigger){ baseDiv*=survMult; state.survivalActive=true; }
  else state.survivalActive=false;

  if(deficit>500*minBet) baseDiv-=0.1;
  if(deficit>2000*minBet) baseDiv-=0.1;
  if(deficit>5000*minBet) baseDiv-=0.1;
  if(baseDiv<1.5) baseDiv=1.5;
  return baseDiv;
}

function getRawBet(strat){
  const minBet=getMinBet();
  let bet=0;
  if(strat.stage>=1){
    bet=strat.initBet*Math.pow(2,strat.stage);
  }else if(strat.wait>=1){
    let deficit=Math.abs(strat.bal);
    if(deficit>0){
      let div=calculateDivisor(deficit,minBet);
      div=div*Math.pow(1.04,strat.cons_loss||0);
      bet=(deficit+minBet)/div;
    }else bet=minBet;
  }
  return roundToChip(bet);
}

function updateAI(strat,side,res,rawBet){
  if(res==='T') return;
  const isWin=(side==='P'&&res==='P')||(side==='B'&&res==='B');
  if(isWin){
    strat.wait++; strat.cons_loss=0;
    strat.bal += (side==='P') ? rawBet : (rawBet*0.95);
    if(rawBet>0){
      if(strat.stage===0){ strat.initBet=rawBet; strat.stage=1; }
      else strat.stage++;
    }
  }else{
    strat.wait=0;
    strat.cons_loss=(strat.cons_loss||0)+1;
    if(rawBet>0){ strat.bal-=rawBet; strat.stage=0; }
  }
}

function checkChaos(){
  if(state.history.length<10) return 0;
  const slice=state.history.slice(-10);
  let zigzags=0;
  for(let i=0;i<slice.length-1;i++) if(slice[i]!==slice[i+1]) zigzags++;
  return zigzags;
}
function checkDragon(){
  if(state.history.length<2) return 1;
  const last=state.history[state.history.length-1];
  let count=1;
  for(let i=state.history.length-2;i>=0;i--){
    if(state.history[i]===last) count++; else break;
  }
  return count;
}

function applyTargetSniper(betAmount, side){
  const targetProfit=parseFloat(document.getElementById('target_profit').value);
  const minBet=getMinBet();
  const chipSize=getChip();
  if(targetProfit<=0) return betAmount;

  const currentCycleProfit=state.realBalance-state.cycleStartBalance;
  const needed=targetProfit-currentCycleProfit;

  if(needed>0 && betAmount>needed){
    let capped=needed;
    if(side==='B' || side==='BANKER') capped=needed/0.95;
    capped=Math.ceil(capped/chipSize)*chipSize;
    return Math.max(capped,minBet);
  }
  return betAmount;
}

function processResult(res,isSim=false){
  // ‡∏à‡∏ö session ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ minBet ‡∏´‡∏£‡∏∑‡∏≠ <=0
  if(checkAndEndSessionIfNeeded(isSim)) return;

  if(!isSim) saveState();

  // ===== Lifetime delta trackers =====
  let commAdded = 0;
  let netDelta = 0;

  const stratMode=document.getElementById('strat_mode').value;
  const maxBetCap=parseFloat(document.getElementById('max_bet_cap').value);
  const chaosLimit=parseInt(document.getElementById('chaos_limit').value);
  const dragonLimit=parseInt(document.getElementById('dragon_limit').value);
  const commRate=parseFloat(document.getElementById('commission_rate').value)||0;

  const chaosCount=checkChaos();
  const dragonCount=checkDragon();
  const isChaos=chaosCount>=chaosLimit;
  const isDragon=dragonCount>=dragonLimit;

  if(isChaos || isDragon){
    state.history.push(res);
    state.graphData.push(state.realBalance);
    state.graphLabels.push(state.history.length);
    if(!isSim) updateUI();
    return;
  }

  const rawP=getRawBet(state.pStrat);
  const rawB=getRawBet(state.bStrat);

  let netBet=0, netSide=null;
  if(stratMode==='offset'){
    if(rawP>rawB){ netBet=rawP-rawB; netSide='P'; }
    else if(rawB>rawP){ netBet=rawB-rawP; netSide='B'; }
  }else{
    const lastRes=state.history.length>0?state.history[state.history.length-1]:null;
    let trendSide='P';
    if(lastRes && lastRes!=='T'){
      trendSide=(stratMode==='anti_last') ? (lastRes==='P'?'B':'P') : (lastRes==='P'?'P':'B');
    }
    netSide=trendSide;
    netBet=Math.max(rawP,rawB);
  }

  if(netBet>0) netBet=roundToChip(netBet);
  if(netBet>0) netBet=applyTargetSniper(netBet,netSide);
  if(netBet>maxBetCap) netBet=maxBetCap;

  // CAP ‡∏ï‡∏≤‡∏°‡∏ó‡∏∏‡∏ô‡∏à‡∏£‡∏¥‡∏á (‡∏ñ‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠ < minBet ‡∏à‡∏∞‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô 0)
  if(netBet>0) netBet=capBetToBankroll(netBet);

  // Commission/Rolling
  if(netBet>0 && res!=='T'){
    state.commTurnover += netBet;
    state.commHands += 1;
    if(commRate>0){
      commAdded = netBet*(commRate/100);
      state.commTotal += commAdded;
    }
  }

  // P/L (Tie push)
  if(netBet>0){
    if(res==='T'){
      netDelta = 0; // push
    }else if(netSide==='P'){
      netDelta = (res==='P') ? netBet : -netBet;
      state.realBalance += netDelta;
    }else{
      netDelta = (res==='B') ? (netBet*0.95) : -netBet;
      state.realBalance += netDelta;
    }
  }

  updateAI(state.pStrat,'P',res,rawP);
  updateAI(state.bStrat,'B',res,rawB);

  // rebalance
  if(Math.abs(state.pStrat.bal - state.bStrat.bal) > 100){
    const avg=(state.pStrat.bal + state.bStrat.bal)/2;
    state.pStrat.bal += (avg - state.pStrat.bal)*0.01;
    state.bStrat.bal += (avg - state.bStrat.bal)*0.01;
  }

  state.history.push(res);
  state.graphData.push(state.realBalance);
  state.graphLabels.push(state.history.length);

  if(state.realBalance < state.maxDrawdown) state.maxDrawdown=state.realBalance;
  if(netBet > state.maxBet) state.maxBet=netBet;

  // ===== NEW: Lifetime Update (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°) =====
  if(netBet>0){
    lifetime.net += netDelta;
    lifetime.comm += commAdded;

    if(netBet > lifetime.maxBet) lifetime.maxBet = netBet;

    const eq = lifetimeEquity();
    if(eq > lifetime.highWater) lifetime.highWater = eq;

    const dd = eq - lifetime.highWater; // <= 0
    if(dd < lifetime.maxDrawdown) lifetime.maxDrawdown = dd;
  }
  // ===== /NEW =====

  // ===== SESSION RULE: Target OR Trailing => ‡∏õ‡∏¥‡∏î session + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å =====
  if(checkAndEndSessionByTargetOrTrailing(isSim)) return;

  // ===== SESSION RULE: ‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ minBet / ‡∏ó‡∏∏‡∏ô‡∏´‡∏°‡∏î => ‡∏õ‡∏¥‡∏î session =====
  if(checkAndEndSessionIfNeeded(isSim)) return;

  if(!isSim) updateUI();
}

function updateUI(){
  const stratMode=document.getElementById('strat_mode').value;
  const maxBetCap=parseFloat(document.getElementById('max_bet_cap').value);
  const chaosLimit=parseInt(document.getElementById('chaos_limit').value);
  const dragonLimit=parseInt(document.getElementById('dragon_limit').value);

  const chaosCount=checkChaos();
  const dragonCount=checkDragon();
  const isChaos=chaosCount>=chaosLimit;
  const isDragon=dragonCount>=dragonLimit;

  const nextP=getRawBet(state.pStrat);
  const nextB=getRawBet(state.bStrat);

  let netAmt=0, netSide="WAIT", formula="", sideClass="side-n";

  if(isDragon){
    netSide="DRAGON"; netAmt=0; sideClass="side-dragon"; formula=`Dragon (${dragonCount})`;
  }else if(isChaos){
    netSide="CHAOS"; netAmt=0; sideClass="side-chaos"; formula=`Chaos (${chaosCount}/${chaosLimit})`;
  }else if(stratMode==='offset'){
    if(nextP>nextB){ netAmt=nextP-nextB; netSide="PLAYER"; sideClass="side-p"; }
    else if(nextB>nextP){ netAmt=nextB-nextP; netSide="BANKER"; sideClass="side-b"; }
    formula=`Offset: P${nextP} vs B${nextB}`;
  }else{
    const lastRes=state.history.length>0?state.history[state.history.length-1]:null;
    let trendSide="PLAYER";
    if(lastRes && lastRes!=='T'){
      trendSide=(stratMode==='anti_last') ? (lastRes==='P'?'BANKER':'PLAYER') : (lastRes==='P'?'PLAYER':'BANKER');
    }
    netSide=trendSide;
    netAmt=Math.max(nextP,nextB);
    sideClass=(trendSide==="PLAYER")?'side-p':'side-b';
    formula=(stratMode==='anti_last')?'Anti Last':'Follow Last';
  }

  if(netAmt>0) netAmt=roundToChip(netAmt);
  const originalAmt=netAmt;
  if(netAmt>0) netAmt=applyTargetSniper(netAmt, netSide);
  if(originalAmt>netAmt) formula += " [Sniper]";
  if(netAmt>maxBetCap) netAmt=maxBetCap;

  // preview cap
  if(netAmt>0){
    const cappedPreview=capBetToBankroll(netAmt);
    if(cappedPreview===0) formula += " [NoBet: Bankroll<Min]";
    else if(cappedPreview<netAmt) formula += " [Cap: Bankroll]";
    netAmt=cappedPreview;
  }

  document.getElementById('rec_amount').innerText=netAmt.toLocaleString();
  document.getElementById('rec_side').innerText=netSide;
  document.getElementById('rec_side').className=`rec-side ${sideClass}`;
  document.getElementById('formula_disp').innerText=formula;

  document.getElementById('mon_p_req').innerText=Math.round(state.pStrat.bal).toLocaleString();
  document.getElementById('mon_b_req').innerText=Math.round(state.bStrat.bal).toLocaleString();
  document.getElementById('mon_p_info').innerText=`Wait:${state.pStrat.wait} | Stg:${state.pStrat.stage}`;
  document.getElementById('mon_b_info').innerText=`Wait:${state.bStrat.wait} | Stg:${state.bStrat.stage}`;

  document.getElementById('target_status_display').innerText=`${state.realBalance.toFixed(2)} / ${state.highWaterMark.toFixed(2)}`;

  const cycleProfit=state.realBalance-state.cycleStartBalance;
  const targetProfit=parseFloat(document.getElementById('target_profit').value)||0;
  document.getElementById('cycle_profit_disp').innerText=`${cycleProfit.toFixed(2)} / ${targetProfit}`;

  const trailStart=parseFloat(document.getElementById('trail_start').value);
  document.getElementById('trailing_info').innerText = state.highWaterMark>=trailStart ? 'Active' : 'Waiting';

  const profitElem=document.getElementById('disp_net');
  profitElem.innerText=state.realBalance.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  profitElem.style.color=state.realBalance>=0?'var(--success)':'var(--danger)';

  document.getElementById('disp_dd').innerText=state.maxDrawdown.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  document.getElementById('disp_maxbet').innerText=state.maxBet.toLocaleString();
  document.getElementById('disp_hands').innerText=state.history.length;
  document.getElementById('disp_chaos').innerText=`${chaosCount}/${chaosLimit}`;
  document.getElementById('disp_dragon').innerText=dragonCount;

  if(state.survivalActive) document.getElementById('survival_box').classList.add('survival-active');
  else document.getElementById('survival_box').classList.remove('survival-active');

  const netPlusComm = state.realBalance + state.commTotal;
  document.getElementById('comm_turnover').innerText = state.commTurnover.toLocaleString(undefined,{maximumFractionDigits:2});
  document.getElementById('comm_total').innerText = state.commTotal.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  document.getElementById('comm_hands').innerText = state.commHands.toLocaleString();
  document.getElementById('comm_net_plus').innerText = netPlusComm.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});

  document.getElementById('disp_net_comm').innerText = netPlusComm.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  document.getElementById('disp_comm_total').innerText = state.commTotal.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});

  document.getElementById('sim_round_count').innerText=simRoundCount;
  document.getElementById('sim_success_count').innerText=simSuccessCount;
  document.getElementById('sim_round_count_bot').innerText=simRoundCount;
  document.getElementById('sim_success_count_bot').innerText=simSuccessCount;

  const left=getBankrollLeft();
  const el=document.getElementById('bankroll_left_disp');
  if(el){
    el.innerText = left.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    el.style.color = left>=getMinBet() ? '#d7f7e6' : '#ffb3b3';
  }
  document.getElementById('session_no_disp').innerText = sessionNo.toLocaleString();
  document.getElementById('session_saved_disp').innerText = sessionHistory.length.toLocaleString();

  renderSessionHistory();
  renderBigRoad();
  updateChart();
  updateLifetimeUI();
  refreshShoeUI();
}

/* ===== Road ===== */
function renderBigRoad(){
  const roadDiv=document.getElementById('road_container');
  roadDiv.innerHTML='';
  let matrix=[], col=0, row=0, last=null;
  const setCell=(c,r,v)=>{ if(!matrix[c]) matrix[c]=[]; matrix[c][r]=v; };

  state.history.forEach(res=>{
    if(last===null){ setCell(col,row,res); last=res; return; }
    if(res===last){
      if(row<5 && (!matrix[col] || matrix[col][row+1]===undefined)) row++;
      else col++;
      setCell(col,row,res);
    }else{
      col++; row=0; setCell(col,row,res); last=res;
    }
  });

  const maxCol=matrix.length;
  const renderCols=Math.max(20,maxCol);
  for(let c=0;c<renderCols;c++){
    for(let r=0;r<6;r++){
      const cell=document.createElement('div');
      cell.className='big-road-cell';
      if(matrix[c] && matrix[c][r]){
        const v=matrix[c][r];
        const circle=document.createElement('div');
        circle.className=`circle circle-${v}`;
        circle.innerText=v;
        cell.appendChild(circle);
      }
      roadDiv.appendChild(cell);
    }
  }
  const wrapper=document.querySelector('.road-scroll-wrapper');
  if(wrapper){
    setTimeout(()=>{
      wrapper.scrollLeft = (maxCol*27)>wrapper.clientWidth ? (maxCol*27)-wrapper.clientWidth+50 : 0;
    },0);
  }
}

/* ===== Chart ===== */
function updateChart(){
  const ctx=document.getElementById('profitChart').getContext('2d');
  if(!chartInstance){
    chartInstance=new Chart(ctx,{
      type:'line',
      data:{ labels:state.graphLabels,
        datasets:[{ label:'Net Profit', data:state.graphData,
          borderColor:'#e67e22', backgroundColor:'rgba(230,126,34,0.1)',
          borderWidth:2, fill:true, pointRadius:0, tension:0.1
        }]
      },
      options:{
        responsive:true, maintainAspectRatio:false, animation:{duration:0},
        plugins:{ legend:{display:false}},
        scales:{ x:{display:false}, y:{grid:{color:'#f0f0f0'}}}
      }
    });
  }else{
    chartInstance.data.labels=state.graphLabels;
    chartInstance.data.datasets[0].data=state.graphData;
    chartInstance.data.datasets[0].borderColor = state.realBalance>=0 ? '#27ae60' : '#c0392b';
    chartInstance.data.datasets[0].backgroundColor = state.realBalance>=0 ? 'rgba(39,174,96,0.1)' : 'rgba(192,57,43,0.1)';
    chartInstance.update();
  }
}

/* ===== Undo/Reset ===== */
function saveState(){
  undoStack.push({
    state: JSON.parse(JSON.stringify(state)),
    lifetime: JSON.parse(JSON.stringify(lifetime))
  });
  if(undoStack.length>30) undoStack.shift();
}
function undo(){
  if(undoStack.length===0) return;
  const snap=undoStack.pop();
  state=snap.state;
  lifetime=snap.lifetime;
  updateUI();
}
function resetAll(){
  if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) location.reload();
}

/* ===== Modals ===== */
function showRiskModal(reason){
  document.getElementById('risk_reason').innerText=reason;
  document.getElementById('risk_dd').innerText=state.realBalance.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  document.getElementById('risk_left').innerText=getBankrollLeft().toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  document.getElementById('riskModal').style.display='flex';
}
function closeRiskModal(){ document.getElementById('riskModal').style.display='none'; }
function showGuideModal(){ document.getElementById('guideModal').style.display='flex'; }
function closeGuideModal(){ document.getElementById('guideModal').style.display='none'; }

/* ===== Simulation ===== */
function runSimulation(){
  const n=parseInt(document.getElementById('sim_hands').value)||1;
  saveState();
  for(let i=0;i<n;i++){
    processResult(generateOutcome(), true);
  }
  updateUI();
}

function toggleAutoSim(){
  if(isAutoRunning) return;
  isAutoRunning=true;

  document.getElementById('btn_auto_sim').style.display='none';
  document.getElementById('btn_auto_sim_bot').style.display='none';
  document.getElementById('btn_stop_sim').style.display='inline-block';
  document.getElementById('btn_stop_sim_bot').style.display='inline-block';
  document.getElementById('sim_stats_display').style.display='block';
  document.getElementById('sim_stats_display_bot').style.display='block';

  if(simRoundCount===0){
    simRoundCount=1; simSuccessCount=0;
    startNewSession();
    updateUI();
  }

  const speed=parseInt(document.getElementById('sim_speed').value);
  if(speed===0) runInstantLoop();
  else autoPlayStep();
}

function stopAutoSim(){
  isAutoRunning=false;
  if(autoTimer) clearTimeout(autoTimer);
  document.getElementById('btn_auto_sim').style.display='inline-block';
  document.getElementById('btn_auto_sim_bot').style.display='inline-block';
  document.getElementById('btn_stop_sim').style.display='none';
  document.getElementById('btn_stop_sim_bot').style.display='none';
}

async function runInstantLoop(){
  while(isAutoRunning){
    processResult(generateOutcome(), true);
    await new Promise(r=>setTimeout(r,0));
  }
}

function autoPlayStep(){
  if(!isAutoRunning) return;
  const speed=parseInt(document.getElementById('sim_speed').value);
  processResult(generateOutcome(), true);
  updateUI();
  autoTimer=setTimeout(autoPlayStep, speed);
}

/* ===== Boot ===== */
window.onload=function(){
  restoreRecommended();
  startNewSession();
  onRngChange();
  renderSessionHistory();
  updateUI();
};
</script>

</body>
</html>

