<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Baccarat Strategy Simulator</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="top-stats">
        <div class="stat-box">NET PROFIT<br><span id="net-profit">0.00</span></div>
        <div class="stat-box">COMMISSION<br><span id="commission">0.00</span></div>
        <div class="stat-box">MAX BET<br><span id="max-bet">0</span></div>
        <div class="stat-box">SESSION<br><span id="session-count">0</span></div>
    </div>

    <div class="main-container">
        <aside class="sidebar">
            <label>โหมด (Mode)</label>
            <select id="mode">
                <option>Manual Input (กดมือ)</option>
            </select>

            <label>Initial Bankroll</label>
            <input type="number" id="initial-bankroll" value="500000">

            <label>Min Unit Size</label>
            <input type="number" id="unit-size" value="5.0">

            <label>Recovery Ratio</label>
            <input type="number" id="recovery-ratio" value="5">

            <label>Stop Loss Threshold</label>
            <input type="number" id="stop-loss" value="75000">

            <label>Commission %</label>
            <input type="number" id="comm-pct" value="1.0" step="0.1">

            <button id="start-btn">START SYSTEM</button>

            <div class="input-pad">
                <button onclick="handleInput('P')" class="btn-p">P</button>
                <button onclick="handleInput('B')" class="btn-b">B</button>
                <button onclick="handleInput('T')" class="btn-t">T</button>
            </div>
            
            <div class="action-btns">
                <button onclick="undo()" class="btn-undo">Undo</button>
                <button onclick="reset()" class="btn-reset">Reset</button>
            </div>
        </aside>

        <main class="content">
            <div class="bet-display">
                <span id="bet-target">WAITING...</span>
                <span id="bet-amount" class="float-right">0</span>
            </div>

            <div class="road-container">
                <canvas id="bigRoad"></canvas>
            </div>

            <div class="history-table">
                <table>
                    <thead>
                        <tr>
                            <th>Hand #</th>
                            <th>Type</th>
                            <th>State</th>
                            <th>Result</th>
                            <th>Bet</th>
                            <th>Outcome</th>
                            <th>Net Profit</th>
                        </tr>
                    </thead>
                    <tbody id="history-log"></tbody>
                </table>
            </div>
        </main>
    </div>
    <script src="script.js"></script>
</body>
</html>
body { background: #121212; color: white; font-family: sans-serif; margin: 0; padding: 10px; }
.top-stats { display: flex; gap: 5px; margin-bottom: 10px; }
.stat-box { flex: 1; background: #1e1e1e; padding: 10px; text-align: center; border: 1px solid #333; font-size: 12px; font-weight: bold; }
.stat-box span { font-size: 20px; color: #fff; }

.main-container { display: flex; gap: 10px; }
.sidebar { width: 220px; background: #1e1e1e; padding: 15px; border-radius: 4px; }
.sidebar label { display: block; font-size: 12px; margin-bottom: 5px; color: #aaa; }
.sidebar input, .sidebar select { width: 100%; background: #2a2a2a; border: 1px solid #444; color: white; padding: 5px; margin-bottom: 15px; }

#start-btn { width: 100%; background: #28a745; border: none; color: white; padding: 10px; cursor: pointer; font-weight: bold; margin-bottom: 15px; }
.input-pad { display: flex; gap: 5px; margin-bottom: 10px; }
.input-pad button { flex: 1; height: 40px; border: none; font-weight: bold; cursor: pointer; }
.btn-p { background: #007bff; color: white; }
.btn-b { background: #dc3545; color: white; }
.btn-t { background: #28a745; color: white; }

.content { flex: 1; }
.bet-display { background: #007bff; padding: 15px; font-weight: bold; font-size: 20px; margin-bottom: 5px; }
.float-right { float: right; }

.road-container { background: white; height: 180px; margin-bottom: 10px; overflow-x: auto; overflow-y: hidden; }
.history-table { height: 400px; overflow-y: auto; background: #1e1e1e; }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
th { position: sticky; top: 0; background: #2a2a2a; padding: 10px; text-align: left; }
td { padding: 8px; border-bottom: 1px solid #333; }
.win { color: #28a745; }
.loss { color: #dc3545; }

// ตรรกะ Core ยึดตาม Python ที่คุณให้มา
let state = {
    bankroll: 0, initial: 0, netProfit: 0, commission: 0,
    maxBet: 0, session: 1, history: [],
    betState: "FLAT", martyStep: 0, currentDrawdown: 0,
    peakBankroll: 0, hasLostSincePeak: false, roadData: []
};

const canvas = document.getElementById('bigRoad');
const ctx = canvas.getContext('2d');

function init() {
    state.initial = parseFloat(document.getElementById('initial-bankroll').value);
    state.bankroll = state.initial;
    state.peakBankroll = state.initial;
    calculateBet();
    drawRoad();
}

function calculateBet() {
    const unitSize = parseFloat(document.getElementById('unit-size').value);
    const stopLoss = parseFloat(document.getElementById('stop-loss').value);
    let rawBet = unitSize;

    state.currentDrawdown = state.peakBankroll - state.bankroll;

    if (state.betState === "FLAT") {
        if (state.currentDrawdown > 0 && state.hasLostSincePeak) {
            rawBet = Math.ceil(state.currentDrawdown / 4);
            rawBet = Math.max(rawBet, unitSize);
        }
    } else if (state.betState === "MARTY") {
        rawBet = unitSize * Math.pow(2, state.martyStep);
    }

    let bet = Math.min(rawBet, stopLoss);
    // ปัดเศษตาม Chip Size (สมมติ 5)
    bet = Math.ceil(bet / 5) * 5;

    document.getElementById('bet-amount').innerText = bet;
    document.getElementById('bet-target').innerText = `BET PLAYER (${state.betState})`;
    return bet;
}

function handleInput(result) {
    if (result === 'T') return; // ข้าม Tie ตามตรรกะเดิม

    const bet = calculateBet();
    const isWin = (result === 'P'); // Side Preference: Player ตาม Config เดิม
    const commPct = parseFloat(document.getElementById('comm-pct').value) / 100;
    
    let outcome = isWin ? bet : -bet;
    let commValue = isWin ? 0 : 0; // ใน Baccarat ปกติคอมมิชชั่นหักที่ Banker

    state.bankroll += outcome;
    if (state.bankroll > state.peakBankroll) state.peakBankroll = state.bankroll;

    // Update States
    if (isWin) {
        state.betState = "FLAT";
        state.martyStep = 0;
        if (state.bankroll >= state.peakBankroll) state.hasLostSincePeak = false;
    } else {
        state.hasLostSincePeak = true;
        state.betState = "MARTY";
        state.martyStep++;
    }

    // เก็บประวัติและอัปเดต UI
    state.history.unshift({
        hand: state.history.length + 1,
        state: state.betState,
        result: result,
        bet: bet,
        outcome: outcome,
        net: state.bankroll - state.initial
    });

    updateUI(result);
}

function updateUI(result) {
    document.getElementById('net-profit').innerText = (state.bankroll - state.initial).toFixed(2);
    document.getElementById('max-bet').innerText = state.maxBet;
    
    const log = document.getElementById('history-log');
    const h = state.history[0];
    const row = `<tr class="${h.outcome >= 0 ? 'win' : 'loss'}">
        <td>${h.hand}</td><td>REAL</td><td>${h.state}</td>
        <td>${h.result}</td><td>${h.bet}</td><td>${h.outcome}</td>
        <td>${h.net.toFixed(2)}</td>
    </tr>`;
    log.insertAdjacentHTML('afterbegin', row);
    
    state.roadData.push(result);
    drawRoad();
    calculateBet();
}

// ระบบวาด Big Road (แบบง่าย)
function drawRoad() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const cellSize = 25;
    canvas.width = 1000; canvas.height = cellSize * 6;
    
    let col = 0, row = 0;
    let lastSign = '';

    state.roadData.forEach(res => {
        if (res !== lastSign && lastSign !== '') {
            col++; row = 0;
        }
        ctx.beginPath();
        ctx.strokeStyle = (res === 'P') ? 'blue' : 'red';
        ctx.lineWidth = 2;
        ctx.arc(col * cellSize + 12, row * cellSize + 12, 8, 0, Math.PI * 2);
        ctx.stroke();
        
        ctx.font = "10px Arial";
        ctx.fillStyle = (res === 'P') ? 'blue' : 'red';
        ctx.fillText(res, col * cellSize + 8, row * cellSize + 16);

        lastSign = res;
        row++;
        if (row >= 6) { row = 0; col++; }
    });
}

document.getElementById('start-btn').addEventListener('click', init);
