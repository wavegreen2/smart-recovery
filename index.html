<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baccarat Recovery Simulator</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; margin: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; text-align: center; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .input-group { margin-bottom: 10px; }
        label { display: block; font-size: 0.9em; color: #666; }
        input, select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; }
        button { width: 100%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; margin-top: 10px; }
        button:hover { background: #219150; }
        #manual-input-area { display: none; margin-top: 20px; padding: 15px; background: #e8f4fd; border-radius: 8px; text-align: center; }
        .btn-manual { width: 80px; margin: 5px; font-weight: bold; }
        #log { height: 300px; overflow-y: scroll; background: #2c3e50; color: #ecf0f1; padding: 10px; font-family: monospace; font-size: 12px; margin-top: 20px; border-radius: 4px; }
        .summary { margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; }
        .win { color: #2ecc71; }
        .loss { color: #e74c3c; }
    </style>
</head>
<body>

<div class="container">
    <h2>üé∞ Baccarat Strategy Simulator</h2>
    
    <div class="grid">
        <div class="settings">
            <div class="input-group">
                <label>Mode</label>
                <select id="mode" onchange="toggleManualArea()">
                    <option value="r">Random Simulation</option>
                    <option value="m">Manual Input (Hand by Hand)</option>
                </select>
            </div>
            <div class="input-group">
                <label>Initial Bankroll ($)</label>
                <input type="number" id="base_bankroll" value="20">
            </div>
            <div class="input-group">
                <label>Unit Size ($)</label>
                <input type="number" id="unit_size" value="10">
            </div>
            <div class="input-group">
                <label>Target Profit per Session ($)</label>
                <input type="number" id="base_target" value="0.01" step="0.01">
            </div>
            <div class="input-group">
                <label>Virtual Loss Trigger (Wait for X Busts)</label>
                <input type="number" id="virtual_loss_trigger" value="2">
            </div>
        </div>
        
        <div class="settings">
            <div class="input-group">
                <label>Side Preference</label>
                <select id="side_preference">
                    <option value="PLAYER">PLAYER</option>
                    <option value="BANKER">BANKER</option>
                </select>
            </div>
            <div class="input-group">
                <label>Marty Multiplier</label>
                <input type="number" id="marty_mult" value="2">
            </div>
            <div class="input-group">
                <label>Fibo Multiplier</label>
                <input type="number" id="fibo_mult" value="10000000">
            </div>
            <div class="input-group">
                <label>Stop Loss Threshold ($)</label>
                <input type="number" id="stop_loss_threshold" value="100000000">
            </div>
            <div class="input-group">
                <label>Max Real Sessions (for Random)</label>
                <input type="number" id="max_sessions" value="10">
            </div>
        </div>
    </div>

    <button id="startBtn" onclick="startSimulation()">Start Simulation</button>

    <div id="manual-input-area">
        <p><strong>Next Hand Result?</strong></p>
        <button class="btn-manual" onclick="processManual('P')" style="background:#3498db; color:white;">PLAYER</button>
        <button class="btn-manual" onclick="processManual('B')" style="background:#e74c3c; color:white;">BANKER</button>
        <button class="btn-manual" onclick="processManual('T')" style="background:#95a5a6; color:white;">TIE</button>
        <button class="btn-manual" onclick="stopSimulation()" style="background:#34495e; color:white;">STOP</button>
    </div>

    <div class="summary" id="summary">
        <strong>Summary:</strong> Waiting to start...
    </div>

    <div id="log"></div>
</div>

<script>
    // Global Variables for State Management
    let simRunning = false;
    let config = {};
    let sessionData = {
        totalRealSessions: 0,
        totalLossAccumulated: 0,
        currentBankroll: 0,
        currentTarget: 0,
        overallMaxBet: 0,
        overallMaxDrawdown: 0,
        maxConsecutiveBusts: 0,
        currentConsecutiveBusts: 0,
        consecutiveVirtualLosses: 0,
        handCounter: 0
    };

    let currentSessionState = null;

    function getFibo(n) {
        if (n <= 0) return 1;
        if (n === 1) return 1;
        let a = 1, b = 1;
        for (let i = 2; i <= n; i++) {
            let temp = a + b;
            a = b;
            b = temp;
        }
        return b;
    }

    function toggleManualArea() {
        const mode = document.getElementById('mode').value;
        document.getElementById('startBtn').style.display = (mode === 'm') ? 'block' : 'block';
    }

    function log(msg, color = "") {
        const logDiv = document.getElementById('log');
        const span = document.createElement('div');
        if (color) span.style.color = color;
        span.textContent = msg;
        logDiv.appendChild(span);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function startSimulation() {
        const mode = document.getElementById('mode').value;
        
        // Reset Stats
        sessionData = {
            totalRealSessions: 0,
            totalLossAccumulated: 0,
            currentBankroll: parseFloat(document.getElementById('base_bankroll').value),
            currentTarget: parseFloat(document.getElementById('base_target').value),
            overallMaxBet: 0,
            overallMaxDrawdown: 0,
            maxConsecutiveBusts: 0,
            currentConsecutiveBusts: 0,
            consecutiveVirtualLosses: 0,
            handCounter: 0
        };
        
        config = {
            mode: mode,
            baseTarget: parseFloat(document.getElementById('base_target').value),
            baseBankroll: parseFloat(document.getElementById('base_bankroll').value),
            unitSize: parseFloat(document.getElementById('unit_size').value),
            martyMult: parseFloat(document.getElementById('marty_mult').value),
            fiboMult: parseFloat(document.getElementById('fibo_mult').value),
            stopLoss: parseFloat(document.getElementById('stop_loss_threshold').value),
            virtualTrigger: parseInt(document.getElementById('virtual_loss_trigger').value),
            sidePref: document.getElementById('side_preference').value,
            maxSessions: parseInt(document.getElementById('max_sessions').value),
            rebateRate: 0.01
        };

        document.getElementById('log').innerHTML = "";
        document.getElementById('startBtn').disabled = true;
        simRunning = true;

        if (mode === 'r') {
            runRandomLoop();
        } else {
            document.getElementById('manual-input-area').style.display = 'block';
            prepareNextSession();
        }
    }

    function prepareNextSession() {
        if (!simRunning) return;

        const isVirtual = sessionData.consecutiveVirtualLosses < config.virtualTrigger;
        
        if (isVirtual) {
            log(`--- üß™ VIRTUAL SESSION (Wait: ${sessionData.consecutiveVirtualLosses}/${config.virtualTrigger}) ---`, "#f1c40f");
        } else {
            if(sessionData.totalRealSessions >= config.maxSessions) {
                stopSimulation();
                return;
            }
            log(`--- üí∞ REAL SESSION ${sessionData.totalRealSessions + 1} (START) ---`, "#2ecc71");
        }

        // Initialize Session State
        currentSessionState = {
            isVirtual: isVirtual,
            bankroll: sessionData.currentBankroll,
            initialBankroll: sessionData.currentBankroll,
            peakBankroll: sessionData.currentBankroll,
            targetProfit: sessionData.currentTarget,
            state: "FLAT",
            martyStep: 0,
            fiboIdx: 0,
            maxDrawdown: 0,
            maxBet: 0,
            hasLostSincePeak: false
        };
    }

    function processHand(result) {
        if (result === 'T') {
            log(`   [Hand ${++sessionData.handCounter}] TIE - Skip`);
            return "CONTINUE";
        }

        let s = currentSessionState;
        let currentDrawdown = s.peakBankroll - s.bankroll;
        
        // Stop Loss Reset
        if (currentDrawdown >= config.stopLoss) {
            s.state = "FLAT"; s.martyStep = 0; s.fiboIdx = 0;
        }

        // Calculate Bet
        let rawBet = 0;
        if (s.state === "FLAT") {
            rawBet = (currentDrawdown > 0 && s.hasLostSincePeak) ? Math.max(Math.ceil(currentDrawdown / 4), config.unitSize) : config.unitSize;
        } else if (s.state === "MARTY") {
            rawBet = config.unitSize * Math.pow(config.martyMult, s.martyStep);
        } else if (s.state === "FIBO") {
            rawBet = getFibo(s.fiboIdx) * config.fiboMult;
        }

        let neededToRecover = currentDrawdown + config.unitSize;
        let bet = (s.state !== "FLAT") ? Math.min(rawBet, neededToRecover) : rawBet;

        // Constraint: Stop Loss
        let isMaxBetActive = false;
        if (bet >= config.stopLoss) {
            bet = config.stopLoss;
            isMaxBetActive = true;
        }

        // Constraint: Target
        let currentProfit = s.bankroll - s.initialBankroll;
        let remainingToTarget = s.targetProfit - currentProfit;
        if (bet > remainingToTarget && remainingToTarget > 0) {
            bet = Math.max(config.unitSize, remainingToTarget);
        }

        if (bet > s.maxBet) s.maxBet = bet;

        // Check Win/Loss
        const isWin = (result === s.sidePref.charAt(0));
        const payout = (config.sidePref === "BANKER") ? 0.95 : 1.0;
        const rebate = bet * config.rebateRate;
        
        s.bankroll += rebate;

        if (isWin) {
            s.bankroll += (bet * payout);
            log(`   [Hand ${++sessionData.handCounter}] Bet: ${bet.toLocaleString()} (${result}) | ‚úÖ WIN | BR: ${s.bankroll.toFixed(2)}`, "#27ae60");
            
            if (s.state === "FIBO") {
                s.fiboIdx = Math.max(-1, s.fiboIdx - 2);
                if (s.fiboIdx < 0) { s.state = "FLAT"; s.fiboIdx = 0; }
            } else {
                if (s.bankroll >= s.peakBankroll) s.hasLostSincePeak = false;
                s.state = "FLAT"; s.martyStep = 0;
            }
        } else {
            s.bankroll -= bet;
            s.hasLostSincePeak = true;
            log(`   [Hand ${++sessionData.handCounter}] Bet: ${bet.toLocaleString()} (${result}) | ‚ùå LOSS | BR: ${s.bankroll.toFixed(2)}`, "#e74c3c");
            
            if (isMaxBetActive) {
                s.state = "FLAT"; s.martyStep = 0; s.fiboIdx = 0;
            } else {
                if (s.state === "FLAT") { s.state = "MARTY"; s.martyStep = 1; }
                else if (s.state === "MARTY") {
                    s.martyStep++;
                    if (s.martyStep > 12) { s.state = "FIBO"; s.fiboIdx = 0; }
                } else if (s.state === "FIBO") {
                    s.fiboIdx++;
                }
            }
        }

        if (s.bankroll > s.peakBankroll) s.peakBankroll = s.bankroll;
        let dd = s.peakBankroll - s.bankroll;
        if (dd > s.maxDrawdown) s.maxDrawdown = dd;

        // Check Session End
        if (s.bankroll <= 0) return "BUST";
        if ((s.bankroll - s.initialBankroll) >= s.targetProfit) return "WIN";
        
        return "CONTINUE";
    }

    function finalizeSession(status) {
        let s = currentSessionState;
        let profit = s.bankroll - s.initialBankroll;

        if (s.isVirtual) {
            if (status === "BUST") {
                sessionData.consecutiveVirtualLosses++;
                log(`üìâ Virtual Result: BUST (${sessionData.consecutiveVirtualLosses}/${config.virtualTrigger})`, "#e67e22");
            } else {
                sessionData.consecutiveVirtualLosses = 0;
                log(`üîÑ Virtual Result: WIN (Resetting)`, "#3498db");
            }
        } else {
            sessionData.totalRealSessions++;
            if (s.maxBet > sessionData.overallMaxBet) sessionData.overallMaxBet = s.maxBet;
            if (s.maxDrawdown > sessionData.overallMaxDrawdown) sessionData.overallMaxDrawdown = s.maxDrawdown;

            if (status === "WIN") {
                log(`‚úÖ REAL WIN: Profit +${profit.toFixed(2)}`, "#2ecc71");
                sessionData.totalLossAccumulated = 0;
                sessionData.currentTarget = config.baseTarget;
                sessionData.currentBankroll = config.baseBankroll;
                sessionData.currentConsecutiveBusts = 0;
                sessionData.consecutiveVirtualLosses = 0;
            } else {
                log(`‚ùå REAL BUST: Loss ${profit.toFixed(2)}`, "#c0392b");
                sessionData.totalLossAccumulated += Math.abs(profit);
                sessionData.currentTarget = sessionData.totalLossAccumulated + config.baseTarget;
                sessionData.currentBankroll = sessionData.currentTarget * 1.5;
                sessionData.currentConsecutiveBusts++;
                if (sessionData.currentConsecutiveBusts > sessionData.maxConsecutiveBusts) {
                    sessionData.maxConsecutiveBusts = sessionData.currentConsecutiveBusts;
                }
                log(`‚ö†Ô∏è RECOVERY | Accumulated Loss: ${sessionData.totalLossAccumulated.toFixed(2)}`, "#f39c12");
            }
        }
        
        updateSummary();
        prepareNextSession();
    }

    function runRandomLoop() {
        let iterations = 0;
        const maxHands = 10000; 

        while (simRunning && iterations < maxHands) {
            if (!currentSessionState) prepareNextSession();
            if (!simRunning) break;

            let rand = Math.random() * 100;
            let res = (rand <= 50.68) ? "B" : "P";
            
            let status = processHand(res);
            if (status !== "CONTINUE") {
                finalizeSession(status);
            }
            iterations++;
        }
        if (iterations >= maxHands) {
            log("Reached total_rounds limit (10,000)");
            stopSimulation();
        }
    }

    function processManual(res) {
        if (!simRunning) return;
        let status = processHand(res);
        if (status !== "CONTINUE") {
            finalizeSession(status);
        }
    }

    function stopSimulation() {
        simRunning = false;
        document.getElementById('startBtn').disabled = false;
        document.getElementById('manual-input-area').style.display = 'none';
        log("‚ïê".repeat(30));
        log(" SIMULATION STOPPED ");
        log("‚ïê".repeat(30));
        updateSummary();
    }

    function updateSummary() {
        const s = sessionData;
        document.getElementById('summary').innerHTML = `
            <strong>üìä SUMMARY REPORT</strong><br>
            üéØ Total Real Sessions: ${s.totalRealSessions}<br>
            üî• Max Consecutive Busts: ${s.maxConsecutiveBusts} times<br>
            üí∏ Overall Max Bet: ${s.overallMaxBet.toLocaleString()}<br>
            üìâ Overall Max Drawdown: ${s.overallMaxDrawdown.toLocaleString()}
        `;
    }
</script>

</body>
</html>
