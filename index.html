<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baccarat Strategy Simulator (Fixed)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; margin: 20px; color: #333; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .config-box, .manual-box { border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #fafafa; }
        label { display: block; margin: 10px 0 5px; font-weight: bold; font-size: 0.9em; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-start { background: #27ae60; color: white; }
        .btn-start:hover { background: #219150; }
        .btn-manual { background: #3498db; color: white; margin-top: 5px; flex: 1; }
        .results { margin-top: 20px; background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 8px; font-family: 'Courier New', Courier, monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; line-height: 1.4; }
        .status-win { color: #2ecc71; font-weight: bold; }
        .status-loss { color: #e74c3c; font-weight: bold; }
        .status-virtual { color: #f1c40f; }
    </style>
</head>
<body>

<div class="container">
    <h2>üìä Baccarat Strategy Simulator</h2>
    
    <div class="grid">
        <div class="config-box">
            <h3>‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Configuration)</h3>
            <label>Mode:</label>
            <select id="mode" onchange="toggleManualBox()">
                <option value="r">Random Simulation</option>
                <option value="m">Manual Input (‡∏ó‡∏µ‡∏•‡∏∞‡∏ï‡∏≤)</option>
                <option value="a">Auto Data (‡∏à‡∏≤‡∏Å‡∏î‡∏¥‡∏ö‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á)</option>
            </select>

            <label>Side Preference:</label>
            <select id="side_preference">
                <option value="PLAYER">PLAYER</option>
                <option value="BANKER">BANKER</option>
            </select>

            <label>Unit Size:</label>
            <input type="number" id="unit_size" value="10">
            
            <label>Virtual Loss Trigger (‡∏£‡∏≠‡∏™‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô):</label>
            <input type="number" id="virtual_loss_trigger" value="2">

            <label>Marty Mult:</label>
            <input type="number" id="marty_mult" value="2">
            
            <label>Stop Loss Threshold:</label>
            <input type="number" id="stop_loss_threshold" value="5000">
        </div>

        <div class="config-box">
            <h3>üìà ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î</h3>
            <label>Max Real Sessions (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏≥‡πÑ‡∏£):</label>
            <input type="number" id="max_sessions" value="10">
            
            <label>Total Rounds (Limit ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Auto/Random):</label>
            <input type="number" id="total_rounds" value="10000">

            <label>Raw Data (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î Auto - ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤):</label>
            <textarea id="raw_data" style="width:100%; height:80px; font-size: 10px;">P,B,T,P,B,B,B,P,P,P,T,P,P,P,P,T,B,P,P,B,P,P,B,B,P,P,B,P,B,P,T,B,T,B,P,P,T,B,P,P,B,P,P,T,P,P,P,P,P,B,P,B,B,P,B,B,P,B,B,P,B,B,B,B,P,B,P,B,P,T,P,B,B,B,P,B,B,P,P,P</textarea>

            <button class="btn-start" onclick="startSimulation()">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô / Reset</button>
        </div>
    </div>

    <div id="manual_input_box" class="manual-box" style="display:none;">
        <h3>üéÆ Manual Control (‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå)</h3>
        <p>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á:</p>
        <div style="display:flex; gap:10px;">
            <button class="btn-manual" style="background:#2980b9" onclick="handleManual('P')">PLAYER (P)</button>
            <button class="btn-manual" style="background:#c0392b" onclick="handleManual('B')">BANKER (B)</button>
            <button class="btn-manual" style="background:#27ae60" onclick="handleManual('T')">TIE (T)</button>
        </div>
    </div>

    <div class="results" id="log_output">Log ‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...</div>
</div>

<script>
    let simState = {
        running: false,
        full_results: [],
        current_data_idx: 0,
        total_real_sessions: 0,
        consecutive_virtual_losses: 0,
        total_loss_accumulated: 0,
        current_target: 10, // ‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö (‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏° Unit ‡πÑ‡∏î‡πâ)
        current_bankroll: 0,
        max_bet_encountered: 0,
        max_drawdown: 0,
        max_consecutive_busts: 0,
        current_consecutive_busts: 0,
        session_active: false,
        s_bankroll: 0,
        s_peak: 0,
        s_state: "FLAT",
        s_marty_step: 0,
        s_has_lost: false,
        s_initial_br: 0
    };

    function toggleManualBox() {
        const mode = document.getElementById('mode').value;
        document.getElementById('manual_input_box').style.display = (mode === 'm') ? 'block' : 'none';
    }

    function log(msg, className = "") {
        const div = document.getElementById('log_output');
        div.innerHTML += `<span class="${className}">${msg}</span>\n`;
        div.scrollTop = div.scrollHeight;
    }

    function startSimulation() {
        const mode = document.getElementById('mode').value;
        const unit = parseFloat(document.getElementById('unit_size').value);
        document.getElementById('log_output').innerHTML = "--- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ---\n";
        
        simState.running = true;
        simState.total_real_sessions = 0;
        simState.total_loss_accumulated = 0;
        simState.current_data_idx = 0;
        simState.consecutive_virtual_losses = 0;
        simState.current_target = unit; 
        simState.current_bankroll = unit * 10; // ‡∏ó‡∏∏‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏°‡∏°‡∏ï‡∏¥
        simState.max_bet_encountered = 0;
        simState.max_drawdown = 0;
        simState.max_consecutive_busts = 0;

        if (mode === 'a') {
            const raw = document.getElementById('raw_data').value;
            simState.full_results = raw.split(',').map(x => x.trim().toUpperCase()).filter(x => ['P','B','T'].includes(x));
        }

        runNextSession();
    }

    function runNextSession() {
        if (!simState.running) return;
        const mode = document.getElementById('mode').value;
        const max_sessions = parseInt(document.getElementById('max_sessions').value);
        const virtual_trigger = parseInt(document.getElementById('virtual_loss_trigger').value);

        if (mode !== 'm' && simState.total_real_sessions >= max_sessions) {
            finishReport();
            return;
        }

        const isVirtual = simState.consecutive_virtual_losses < virtual_trigger;
        if (isVirtual) {
            log(`\n--- üß™ VIRTUAL (‡∏£‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô: ${simState.consecutive_virtual_losses}/${virtual_trigger}) ---`, "status-virtual");
        } else {
            log(`\n--- üí∞ REAL SESSION ${simState.total_real_sessions + 1} ---`, "status-win");
        }

        setupSession();

        if (mode === 'r' || mode === 'a') {
            autoProcess();
        }
    }

    function setupSession() {
        simState.session_active = true;
        simState.s_initial_br = simState.current_bankroll;
        simState.s_bankroll = simState.current_bankroll;
        simState.s_peak = simState.current_bankroll;
        simState.s_state = "FLAT";
        simState.s_marty_step = 0;
        simState.s_has_lost = false;
    }

    function calculateBet() {
        const unit_size = parseFloat(document.getElementById('unit_size').value);
        const marty_mult = parseFloat(document.getElementById('marty_mult').value);
        
        let bet = unit_size;
        if (simState.s_state === "MARTY") {
            bet = unit_size * Math.pow(marty_mult, simState.s_marty_step);
        }
        
        // ‡∏Å‡∏£‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏•‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
        let current_profit = simState.s_bankroll - simState.s_initial_br;
        let remaining = simState.current_target - current_profit;
        if (remaining > 0 && bet > remaining) {
            bet = Math.max(unit_size, remaining);
        }

        return bet;
    }

    function processHand(actual_result) {
        if (!simState.session_active) return;

        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ú‡∏• Tie ‡∏Å‡πà‡∏≠‡∏ô: Tie ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏ä‡∏ô‡∏∞‡πÅ‡∏û‡πâ ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô State ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏¢‡∏±‡∏ö‡∏î‡∏±‡∏ä‡∏ô‡∏µ
        if (actual_result === 'T') {
            log(`   ‡∏ï‡∏≤‡∏ó‡∏µ‡πà ${simState.current_data_idx + 1}: [TIE] - ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô/‡∏Ç‡πâ‡∏≤‡∏°`);
            simState.current_data_idx++;
            return;
        }

        const side = document.getElementById('side_preference').value;
        const bet = calculateBet();
        if (bet > simState.max_bet_encountered) simState.max_bet_encountered = bet;

        const isWin = (actual_result === side[0]); // 'P' ‡∏´‡∏£‡∏∑‡∏≠ 'B'
        const payout = (side === 'BANKER') ? 0.95 : 1.0;

        if (isWin) {
            simState.s_bankroll += (bet * payout);
            log(`   Bet: ${bet.toFixed(0)} (${actual_result}) | ‚úÖ WIN | BR: ${simState.s_bankroll.toFixed(1)}`, "status-win");
            simState.s_state = "FLAT";
            simState.s_marty_step = 0;
        } else {
            simState.s_bankroll -= bet;
            log(`   Bet: ${bet.toFixed(0)} (${actual_result}) | ‚ùå LOSS | BR: ${simState.s_bankroll.toFixed(1)}`, "status-loss");
            simState.s_state = "MARTY";
            simState.s_marty_step++;
        }

        if (simState.s_bankroll > simState.s_peak) simState.s_peak = simState.s_bankroll;
        let dd = simState.s_peak - simState.s_bankroll;
        if (dd > simState.max_drawdown) simState.max_drawdown = dd;

        simState.current_data_idx++;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏ö Session
        let current_p = simState.s_bankroll - simState.s_initial_br;
        if (simState.s_bankroll <= 0 || current_p >= simState.current_target) {
            const status = (simState.s_bankroll <= 0) ? "BUST" : "WIN";
            finalizeSession(status, current_p);
        }
    }

    function handleManual(res) {
        if (!simState.running) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô' ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            return;
        }
        if (!simState.session_active) {
            runNextSession();
        }
        processHand(res);
    }

    function autoProcess() {
        const mode = document.getElementById('mode').value;
        const total_rounds = parseInt(document.getElementById('total_rounds').value);

        while (simState.session_active) {
            let res = "";
            if (mode === 'r') {
                if (simState.current_data_idx >= total_rounds) break;
                res = (Math.random() > 0.5) ? "B" : "P"; // Simple Random
            } else if (mode === 'a') {
                if (simState.current_data_idx >= simState.full_results.length) break;
                res = simState.full_results[simState.current_data_idx];
            } else {
                break; // Manual mode uses buttons
            }
            processHand(res);
        }
        
        if (simState.running && !simState.session_active && mode !== 'm') {
            setTimeout(runNextSession, 50);
        }
    }

    function finalizeSession(status, profit) {
        simState.session_active = false;
        const virtual_trigger = parseInt(document.getElementById('virtual_loss_trigger').value);
        const isVirtual = simState.consecutive_virtual_losses < virtual_trigger;

        if (isVirtual) {
            if (status === "BUST") simState.consecutive_virtual_losses++;
            else simState.consecutive_virtual_losses = 0;
            log(`üìâ Virtual Result: ${status} (‡∏™‡∏∞‡∏™‡∏°‡πÄ‡∏™‡∏µ‡∏¢: ${simState.consecutive_virtual_losses})`);
        } else {
            simState.total_real_sessions++;
            if (status === "WIN") {
                log(`‚úÖ REAL SESSION WIN! | ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ: ${profit.toFixed(2)}`, "status-win");
                simState.consecutive_virtual_losses = 0;
                simState.total_loss_accumulated = 0;
            } else {
                log(`‚ùå REAL SESSION BUST! | ‡πÄ‡∏™‡∏µ‡∏¢: ${profit.toFixed(2)}`, "status-loss");
                simState.total_loss_accumulated += Math.abs(profit);
                simState.consecutive_virtual_losses = 0; // Reset ‡∏£‡∏≠ Virtual ‡πÉ‡∏´‡∏°‡πà
            }
        }
        
        const mode = document.getElementById('mode').value;
        if (mode === 'm') {
            log("--- ‡∏à‡∏ö‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡∏Å‡∏î P/B/T ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡πà‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ) ---");
        }
    }

    function finishReport() {
        simState.running = false;
        log("\n" + "‚ïê".repeat(30));
        log(" üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á");
        log("‚ïê".repeat(30));
        log(`üéØ ‡∏à‡∏ö‡∏£‡∏≠‡∏ö Real ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î    : ${simState.total_real_sessions}`);
        log(`üí∏ ‡πÑ‡∏°‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏•‡∏á      : ${simState.max_bet_encountered.toLocaleString()}`);
        log(`üìâ Drawdown ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î    : ${simState.max_drawdown.toLocaleString()}`);
        log("‚ïê".repeat(30));
    }
</script>

</body>
</html>
