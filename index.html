<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Baccarat AI: Ultimate V3.4 (UI ‡πÄ‡∏î‡∏¥‡∏°) ‚Äî 5 Strategies (incl OFFSET) + Netting + Central Staker + Cycles</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --primary:#2c3e50;--accent:#e74c3c;--player:#2980b9;--banker:#c0392b;--tie:#27ae60;
      --bg:#f4f6f7;--card-bg:#fff;--text:#2c3e50;--success:#27ae60;--warning:#f39c12;--danger:#c0392b;
      --auto:#8e44ad;--gold:#d4ac0d;--chaos:#8e44ad;--dragon:#e67e22;--target:#16a085;--comm:#8e44ad;
    }
    *{box-sizing:border-box}
    body{font-family:'Segoe UI','Sarabun',sans-serif;background:var(--bg);color:var(--text);margin:0;padding:10px;display:flex;justify-content:center;height:100vh;overflow:hidden}
    .container{width:100%;max-width:1200px;display:grid;grid-template-columns:360px 1fr;gap:15px;height:95vh}
    .sidebar{background:var(--card-bg);padding:15px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.05);overflow-y:auto;display:flex;flex-direction:column;gap:10px;height:100%;border-top:5px solid var(--target)}
    .main-content{display:flex;flex-direction:column;gap:15px;overflow-y:auto;padding-right:5px;height:100%}
    .section-title{font-size:.85rem;font-weight:bold;color:var(--primary);margin-top:5px;border-bottom:2px solid #eee;padding-bottom:3px;display:flex;justify-content:space-between;align-items:center}
    .badge-ult{background:var(--primary);color:#fff;padding:2px 6px;border-radius:4px;font-size:.6rem}
    .form-group{margin-bottom:5px}
    .form-group label{display:block;font-size:.8rem;font-weight:600;margin-bottom:2px;color:#555}
    .form-group input,.form-group select{width:100%;padding:8px;border:1px solid #bdc3c7;border-radius:5px;font-size:.95rem}
    .btn-action{width:100%;padding:12px;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;font-size:.9rem;margin-top:5px}
    .btn-sim{background:var(--primary)}
    .btn-auto{background:var(--auto)}
    .btn-stop{background:var(--danger);display:none}
    .btn-reset{background:#ecf0f1;color:#7f8c8d;border:1px solid #bdc3c7;margin-top:10px;width:100%;padding:12px;border-radius:6px;cursor:pointer;font-weight:bold;font-size:.9rem}
    .btn-restore{background:#fff;border:1px dashed var(--target);color:var(--target);font-size:.75rem;width:100%;cursor:pointer;padding:6px;margin-top:5px;border-radius:4px;font-weight:bold}
    .target-box{background:#e8f8f5;border:1px solid #a3e4d7;border-radius:8px;padding:8px;margin-bottom:5px}
    .target-title{font-size:.75rem;font-weight:bold;color:var(--target);margin-bottom:5px}
    .feature-box{background:#fffcf5;border:1px solid #fae5d3;border-radius:8px;padding:8px;margin-bottom:5px}
    .feature-title{font-size:.75rem;font-weight:bold;color:#d35400;margin-bottom:5px;display:flex;justify-content:space-between}
    .dual-input{display:grid;grid-template-columns:1fr 1fr;gap:5px}
    .survival-active{animation:pulse-red 2s infinite;border:2px solid var(--danger)}
    @keyframes pulse-red{0%,100%{box-shadow:0 0 5px rgba(192,57,43,.3)}50%{box-shadow:0 0 15px rgba(192,57,43,.6)}}

    /* Commission */
    .comm-box{background:#f5eef8;border:1px solid #d2b4de;border-radius:8px;padding:8px;margin-bottom:5px}
    .comm-title{font-size:.75rem;font-weight:bold;color:var(--comm);margin-bottom:5px;display:flex;justify-content:space-between;align-items:center}
    .btn-guide{background:var(--comm);color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:.65rem;cursor:pointer;font-weight:800}
    .comm-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px}
    .comm-stat{background:rgba(142,68,173,.08);border-radius:6px;padding:6px;text-align:center}
    .comm-stat .lb{font-size:.6rem;color:#7f8c8d;text-transform:uppercase}
    .comm-stat .vl{font-size:.95rem;font-weight:900;color:var(--comm)}

    .monitor-box{background:#2c3e50;border-radius:8px;padding:12px;margin-bottom:5px;text-align:center;color:#fff}
    .monitor-label{font-size:.7rem;color:#bdc3c7;font-weight:600;display:block;margin-bottom:2px;text-transform:uppercase;letter-spacing:1px}
    .monitor-val{font-size:1.2rem;font-weight:bold;color:var(--gold)}
    .cycle-monitor{display:flex;justify-content:space-between;background:rgba(0,0,0,.2);padding:5px 10px;border-radius:4px;margin-top:5px;font-size:.8rem}

    .brain-monitor{background:#fff;border:1px solid #e0e0e0;border-radius:8px;padding:8px;display:grid;grid-template-columns:1fr 1fr;gap:5px}
    .brain-col{text-align:center}
    .brain-head{font-size:.7rem;font-weight:bold;margin-bottom:2px}
    .brain-val{font-size:1.1rem;font-weight:800}
    .brain-info{font-size:.65rem;color:#7f8c8d}
    .txt-p{color:var(--player)} .txt-b{color:var(--banker)}

    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;flex-shrink:0}
    .stat-card{background:var(--card-bg);padding:10px;border-radius:10px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.03);border-top:4px solid transparent}
    .stat-card.profit{border-top-color:var(--success)}
    .stat-card.loss{border-top-color:var(--danger)}
    .stat-card.pre{border-top-color:var(--gold);background:#fffcf5}
    .stat-card.comm{border-top-color:var(--comm);background:#f9f0ff}
    .stat-label{font-size:.65rem;color:#95a5a6;text-transform:uppercase;line-height:1.2}
    .stat-value{font-size:1rem;font-weight:800;margin-top:3px}

    .road-scroll-wrapper{background:var(--card-bg);padding:10px;border-radius:10px;overflow-x:auto;overflow-y:hidden;height:170px;min-height:170px;flex-shrink:0;width:100%;scroll-behavior:smooth}
    .big-road-grid{display:grid;grid-template-rows:repeat(6,26px);grid-auto-columns:26px;grid-auto-flow:column;gap:1px;min-width:max-content}
    .big-road-cell{width:24px;height:24px;display:flex;justify-content:center;align-items:center;font-size:10px;font-weight:bold;border:1px solid #f0f0f0;background:#fff}
    .circle{width:18px;height:18px;border-radius:50%;border:2px solid transparent;display:flex;justify-content:center;align-items:center}
    .circle-P{border-color:var(--player);color:var(--player)}
    .circle-B{border-color:var(--banker);color:var(--banker)}
    .circle-T{border-color:var(--tie);color:var(--tie)}

    .bet-panel{background:var(--card-bg);padding:15px;border-radius:12px;text-align:center;box-shadow:0 5px 20px rgba(0,0,0,.08);flex-shrink:0;border-bottom:5px solid var(--primary)}
    .offset-formula{font-family:monospace;font-size:.9rem;color:#7f8c8d;background:#f0f3f4;padding:4px 10px;border-radius:4px;display:inline-block;margin-bottom:10px}
    .rec-amount{font-size:3.5rem;font-weight:900;line-height:1;color:var(--primary)}
    .rec-side{font-size:1.8rem;font-weight:800;margin-top:5px;text-transform:uppercase;letter-spacing:2px}
    .side-p{color:var(--player)} .side-b{color:var(--banker)} .side-n{color:#95a5a6}

    .controls{display:grid;grid-template-columns:1fr 1fr 80px;gap:10px;margin-top:15px}
    .btn-ctrl{padding:15px;border:none;border-radius:8px;font-size:1rem;font-weight:bold;cursor:pointer;color:#fff;touch-action:manipulation}
    .btn-ctrl:disabled{opacity:.55;cursor:not-allowed}
    .btn-p{background:var(--player)} .btn-b{background:var(--banker)} .btn-u{background:#95a5a6}

    .chart-box{background:var(--card-bg);padding:10px;border-radius:12px;flex-grow:1;min-height:250px;position:relative}

    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:999999;backdrop-filter:blur(5px)}
    .modal-box{background:#fff;padding:30px 20px;border-radius:15px;text-align:center;max-width:520px;width:90%;box-shadow:0 20px 50px rgba(0,0,0,.4);display:flex;flex-direction:column;align-items:center;border:2px solid var(--gold)}
    .modal-icon{font-size:3rem;margin-bottom:10px}
    .modal-text-th{font-size:1.2rem;font-weight:bold;color:#2c3e50;margin-bottom:5px}
    .btn-modal-ack{background:var(--success);color:#fff;border:none;padding:12px 20px;width:100%;border-radius:8px;font-weight:bold;cursor:pointer;font-size:1rem;margin-top:15px}

    /* ===== Shoe UI ===== */
    .shoe-ui{display:none;background:linear-gradient(135deg,#0d5e2e,#083a1c);border:2px solid rgba(255,215,0,.35);border-radius:12px;padding:12px}
    .shoe-ui.active{display:block}
    .shoe-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px}
    .shoe-hdr .t{color:#ffd700;font-weight:900;font-size:.8rem}
    .shoe-hdr .sub{color:#d7f7e6;font-size:.6rem}
    .shoe-hdr select{background:rgba(0,0,0,.25);color:#ffd700;border:1px solid rgba(255,215,0,.35);border-radius:6px;padding:5px 8px;font-weight:800;font-size:.75rem;cursor:pointer}
    .shoe-bar{position:relative;height:20px;background:rgba(0,0,0,.25);border-radius:999px;overflow:visible;margin-bottom:8px}
    .shoe-bar-fill{height:100%;width:0%;border-radius:999px;background:linear-gradient(90deg,#27ae60,#f39c12,#e74c3c);transition:width .25s}
    .shoe-bar-txt{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.6rem;font-weight:900}
    .shoe-cut{position:absolute;top:-2px;height:24px;width:3px;background:#ffd700;box-shadow:0 0 8px rgba(255,215,0,.9);border-radius:2px}
    .shoe-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:8px}
    .shoe-bx{background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:5px;text-align:center}
    .shoe-bx .lb{color:#b9f3d9;font-size:.55rem;text-transform:uppercase}
    .shoe-bx .vl{color:#fff;font-size:.9rem;font-weight:900;margin-top:1px}
    .burn-box{background:rgba(139,0,0,.22);border:1px dashed rgba(255,107,107,.7);border-radius:10px;padding:8px;margin-bottom:8px}
    .burn-box .bt{color:#ffb3b3;font-weight:900;font-size:.7rem;margin-bottom:6px}
    .burn-row{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .burn-note{color:#ffd7d7;font-size:.6rem;margin-top:6px;line-height:1.4;white-space:pre-line}
    .deal-area{background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px}
    .deal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px}
    .deal-head span{color:#ffd700;font-weight:900;font-size:.7rem}
    .deal-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .deal-col{text-align:center}
    .side-tag{display:inline-block;padding:2px 10px;border-radius:6px;color:#fff;font-weight:900;font-size:.7rem;margin-bottom:4px}
    .side-tag.tp{background:var(--player)} .side-tag.tb{background:var(--banker)}
    .card-row{display:flex;justify-content:center;gap:4px;height:60px;min-height:60px;align-items:center;flex-wrap:nowrap;overflow:hidden}
    .deal-score{font-size:1.5rem;font-weight:1000;color:#ffd700;margin-top:4px}
    .deal-result{text-align:center;margin-top:8px;font-weight:900;font-size:.8rem;padding:6px;border-radius:6px;background:rgba(0,0,0,.2)}
    .mini-card{width:38px;height:56px;background:#fff;border-radius:5px;border:1px solid #ccc;box-shadow:0 2px 8px rgba(0,0,0,.3);display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:Georgia,serif;font-weight:900;flex:0 0 auto}
    .mini-card .cr{font-size:.85rem;line-height:1}
    .mini-card .cs{font-size:.75rem;line-height:1;margin-top:1px}
    .mini-card.red{color:#c0392b} .mini-card.black{color:#2c3e50}
    .mini-card.down{background:linear-gradient(135deg,#1a3a5c,#2c5f8a);border:2px solid #3a7abd}
    .mini-card.down .cr,.mini-card.down .cs{display:none}
    .mini-card.down::after{content:'üÇ†';font-size:1.3rem;color:rgba(255,255,255,.3)}
    .mini-card.burn-reveal{border:2px solid #f44;box-shadow:0 0 12px rgba(255,68,68,.5)}
    .mini-card.placeholder{visibility:hidden}
    .shoe-newbtn{background:linear-gradient(135deg,#ffd700,#f39c12);color:#2c3e50;border:none;padding:8px 10px;border-radius:6px;font-weight:900;cursor:pointer;font-size:.75rem;white-space:nowrap}

    /* ===== History ===== */
    .sess-box{background:#ffffff;border:1px solid #e8e8e8;border-radius:10px;padding:10px}
    .sess-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
    .sess-head .t{font-weight:900;color:var(--primary);font-size:.8rem}
    .sess-actions{display:flex;gap:6px;flex-wrap:wrap}
    .btn-mini{border:none;border-radius:6px;padding:6px 8px;font-size:.7rem;font-weight:900;cursor:pointer}
    .btn-mini.export{background:var(--comm);color:#fff}
    .btn-mini.clear{background:#ecf0f1;color:#2c3e50;border:1px solid #d0d0d0}
    .sess-table-wrap{max-height:240px;overflow:auto;border:1px solid #eee;border-radius:8px}
    table.sess-table{width:100%;border-collapse:collapse;font-size:.72rem}
    .sess-table th,.sess-table td{padding:6px 6px;border-bottom:1px solid #f0f0f0;vertical-align:top;white-space:nowrap}
    .sess-table th{position:sticky;top:0;background:#f8f9fb;z-index:2;text-align:left;color:#6c7a89;font-weight:900}
    .pos{color:var(--success);font-weight:900}
    .neg{color:var(--danger);font-weight:900}
    .muted{color:#7f8c8d}

    .chk-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .chk-row input[type="checkbox"]{width:18px;height:18px}
    .mini-note{font-size:.65rem;color:#7f8c8d;line-height:1.35;margin-top:4px}

    @media(max-width:768px){
      body{overflow-y:auto;height:auto;display:block}
      .container{grid-template-columns:1fr;height:auto;display:flex;flex-direction:column;gap:20px;padding-bottom:30px}
      .sidebar{height:auto}
      .main-content{height:auto;overflow:visible}
      .stats-grid{grid-template-columns:repeat(2,1fr)}
      .chart-box{min-height:300px}
    }
  </style>
</head>

<body>
<div class="container">
  <div class="sidebar">
    <div class="section-title" style="justify-content:center;border-bottom:none">
      <span class="badge-ult" style="font-size:.8rem;padding:5px 10px;">V3.4 UI ‡πÄ‡∏î‡∏¥‡∏° ‚Äî 5 Strategies (OFFSET ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß) + Netting + Central Staker + Cycles</span>
    </div>

    <button class="btn-reset" onclick="resetAll()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Hard Reset)</button>

    <div class="section-title">üß™ ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ú‡∏• (Top)</div>
    <div class="form-group">
      <label>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏° (RNG Algorithm)</label>
      <select id="rng_method" onchange="onRngChange(); syncSimSettings('top')">
        <option value="math">üé≤ Standard (Math.random)</option>
        <option value="crypto">üîí Crypto Secure</option>
        <option value="shoe" selected>üÉè Real 8-Deck Shoe</option>
      </select>
    </div>

    <div class="shoe-ui" id="shoe_ui">
      <div class="shoe-hdr">
        <div>
          <div class="t">üÉè 8-Deck Shoe ‚Äî Casino Real</div>
          <div class="sub">Burn Card + Cut Card (Penetration)</div>
        </div>
        <select id="shoe_pen" onchange="onPenChange()">
          <option value="50">‡πÉ‡∏ä‡πâ‡πÑ‡∏û‡πà 50%</option>
          <option value="60" selected>‡πÉ‡∏ä‡πâ‡πÑ‡∏û‡πà 60%</option>
          <option value="70">‡πÉ‡∏ä‡πâ‡πÑ‡∏û‡πà 70%</option>
          <option value="80">‡πÉ‡∏ä‡πâ‡πÑ‡∏û‡πà 80%</option>
        </select>
      </div>

      <div class="shoe-bar">
        <div class="shoe-bar-fill" id="sb_fill"></div>
        <div class="shoe-cut" id="sb_cut" style="left:60%"></div>
        <div class="shoe-bar-txt" id="sb_txt">0 / 416 (0.0%)</div>
      </div>

      <div class="shoe-grid">
        <div class="shoe-bx"><div class="lb">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div><div class="vl" id="sh_rem">416</div></div>
        <div class="shoe-bx"><div class="lb">‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß</div><div class="vl" id="sh_used">0</div></div>
        <div class="shoe-bx"><div class="lb">Shoe #</div><div class="vl" id="sh_no">0</div></div>
      </div>

      <div class="burn-box" id="burn_box" style="display:none">
        <div class="bt">üî• Burn Card Ceremony</div>
        <div class="burn-row">
          <span style="color:#ffd7d7;font-size:.65rem">‡πÑ‡∏û‡πà‡∏´‡∏á‡∏≤‡∏¢:</span>
          <span id="burn_card_slot"></span>
          <span id="burn_label" style="color:#ffd7d7;font-size:.7rem;font-weight:900"></span>
        </div>
        <div class="burn-row" id="burn_down_row" style="margin-top:4px"></div>
        <div class="burn-note" id="burn_note"></div>
      </div>

      <div class="deal-area" id="deal_area" style="display:none">
        <div class="deal-head">
          <span>üìã ‡∏ï‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
          <button class="shoe-newbtn" onclick="initShoe(true)">üîÑ ‡∏™‡∏±‡∏ö‡πÑ‡∏û‡πà‡πÉ‡∏´‡∏°‡πà</button>
        </div>
        <div class="deal-grid">
          <div class="deal-col">
            <div class="side-tag tp">PLAYER</div>
            <div class="card-row" id="pc_row"></div>
            <div class="deal-score" id="pc_sc">-</div>
          </div>
          <div class="deal-col">
            <div class="side-tag tb">BANKER</div>
            <div class="card-row" id="bc_row"></div>
            <div class="deal-score" id="bc_sc">-</div>
          </div>
        </div>
        <div class="deal-result" id="deal_res" style="color:#ffd700">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡∏Å‡πÑ‡∏û‡πà...</div>
      </div>
    </div>

    <div class="form-group">
      <input type="number" id="sim_hands" value="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≤" oninput="syncSimSettings('top')" />
      <button class="btn-action btn-sim" onclick="runSimulation()">‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ú‡∏• (Simulate)</button>

      <label style="margin-top:10px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß Auto Sim:</label>
      <select id="sim_speed" onchange="syncSimSettings('top')">
        <option value="0">üöÄ ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Instant)</option>
        <option value="20" selected>‚ö° ‡πÄ‡∏£‡πá‡∏ß (Fast)</option>
      </select>

      <button class="btn-action btn-auto" id="btn_auto_sim" onclick="toggleAutoSim()">üöÄ Auto Sim</button>
      <button class="btn-action btn-stop" id="btn_stop_sim" onclick="stopAutoSim()">‚èπ STOP</button>

      <div id="sim_stats_display" style="display:none;font-size:.75rem;text-align:center;margin-top:5px;">
        ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà: <span id="sim_round_count">0</span> | ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (cycle): <span id="sim_success_count" style="color:green;">0</span>
      </div>
    </div>

    <div class="section-title">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Settings)</div>

    <div class="feature-box" style="border-color:#bfc9ca;background:#fbfcfc">
      <div class="feature-title" style="color:var(--primary);">üß† Netting (Multi-Strategy)</div>

      <div class="form-group">
        <label>Netting Mode (2 ‡πÇ‡∏´‡∏°‡∏î, default = weight)</label>
        <select id="net_mode" onchange="updateUI()">
          <option value="weight" selected>weight (sum weights)</option>
          <option value="count">count (ignore weights)</option>
        </select>
      </div>

      <div class="dual-input">
        <div class="form-group">
          <label>min_strength (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ = WAIT)</label>
          <input type="number" id="min_strength" value="0.45" step="0.01" oninput="updateUI()" />
        </div>
        <div class="form-group">
          <label>Reset Road ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö cycle</label>
          <select id="reset_road_on_cycle" onchange="updateUI()">
            <option value="yes">Yes</option>
            <option value="no" selected>No (‡∏™‡∏∞‡∏™‡∏° Big Road ‡∏ï‡πà‡∏≠)</option>
          </select>
        </div>
      </div>

      <div class="section-title" style="margin-top:8px;">üó≥Ô∏è Strategy Votes (5) ‚Äî ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°</div>

      <div class="chk-row">
        <input type="checkbox" id="use_offset" onchange="updateUI()" />
        <label for="use_offset" style="margin:0;font-size:.78rem;font-weight:800;color:#2c3e50">1) Offset (‡∏™‡∏°‡∏î‡∏∏‡∏• P-B)</label>
      </div>
      <div class="form-group">
        <label>Weight (Offset)</label>
        <input type="number" id="w_offset" value="2.54" step="0.01" oninput="updateUI()" />
      </div>

      <div class="chk-row">
        <input type="checkbox" id="use_anti_last" checked onchange="updateUI()" />
        <label for="use_anti_last" style="margin:0;font-size:.78rem;font-weight:800;color:#2c3e50">2) Anti Last</label>
      </div>
      <div class="form-group">
        <label>Weight (Anti Last)</label>
        <input type="number" id="w_anti_last" value="2.46" step="0.01" oninput="updateUI()" />
      </div>

      <div class="chk-row">
        <input type="checkbox" id="use_follow_last" onchange="updateUI()" />
        <label for="use_follow_last" style="margin:0;font-size:.78rem;font-weight:800;color:#2c3e50">3) Follow Last</label>
      </div>
      <div class="form-group">
        <label>Weight (Follow Last)</label>
        <input type="number" id="w_follow_last" value="0.63" step="0.01" oninput="updateUI()" />
      </div>

      <div class="chk-row">
        <input type="checkbox" id="use_something_else" onchange="updateUI()" />
        <label for="use_something_else" style="margin:0;font-size:.78rem;font-weight:800;color:#2c3e50">4) Something Else (Engine)</label>
      </div>
      <div class="form-group">
        <label>Weight (Something Else)</label>
        <input type="number" id="w_something_else" value="0.37" step="0.01" oninput="updateUI()" />
      </div>

      <div class="chk-row">
        <input type="checkbox" id="use_policy_ai" checked onchange="updateUI()" />
        <label for="use_policy_ai" style="margin:0;font-size:.78rem;font-weight:800;color:#2c3e50">5) Policy AI (trained weights)</label>
      </div>
      <div class="form-group">
        <label>Weight (Policy AI)</label>
        <input type="number" id="w_policy_ai" value="1.06" step="0.01" oninput="updateUI()" />
      </div>

      <div class="mini-note">
        Offset/SomethingElse ‡πÉ‡∏ä‡πâ ‚ÄúP-Engine vs B-Engine‚Äù ‡πÅ‡∏ö‡∏ö V3.4 (‡∏Ñ‡∏∑‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏ß‡∏ï‡∏ù‡∏±‡πà‡∏á<br/>
        (‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏¢‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å Central Staker √ó f(net_strength))
      </div>
    </div>

    <div class="comm-box">
      <div class="comm-title">
        <span>üí∞ Commission / Rolling Rebate</span>
        <button class="btn-guide" onclick="showGuideModal()">üìñ ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</button>
      </div>
      <div class="form-group">
        <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏° / ‡πÇ‡∏£‡∏•‡∏•‡∏¥‡πà‡∏á (%)</label>
        <input type="number" id="commission_rate" value="0.9" step="0.01" min="0" oninput="updateUI()">
        <div style="font-size:.6rem;color:var(--comm);margin-top:2px;">*‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡∏∞ ‚Äú‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Tie‚Äù</div>
      </div>
      <div class="comm-grid">
        <div class="comm-stat"><div class="lb">‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏° (cycle ‡∏ô‡∏µ‡πâ)</div><div class="vl" id="comm_turnover">0</div></div>
        <div class="comm-stat"><div class="lb">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏™‡∏∞‡∏™‡∏° (cycle ‡∏ô‡∏µ‡πâ)</div><div class="vl" id="comm_total">0</div></div>
        <div class="comm-stat"><div class="lb">‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô (cycle ‡∏ô‡∏µ‡πâ)</div><div class="vl" id="comm_hands">0</div></div>
        <div class="comm-stat"><div class="lb">Cycle + ‡∏Ñ‡∏≠‡∏°</div><div class="vl" id="comm_net_plus">0</div></div>
      </div>
    </div>

    <div class="section-title">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°)</div>
    <div class="comm-box" style="border-color:#cfe2ff;background:#f7fbff">
      <div class="comm-title" style="color:#1d4ed8"><span>Lifetime Stats</span></div>
      <div class="comm-grid">
        <div class="comm-stat" style="background:rgba(29,78,216,.06)"><div class="lb">Net Profit ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="vl" id="all_net">0</div></div>
        <div class="comm-stat" style="background:rgba(29,78,216,.06)"><div class="lb">Net + Commission ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="vl" id="all_net_comm">0</div></div>
        <div class="comm-stat" style="background:rgba(29,78,216,.06)"><div class="lb">Max Drawdown ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏ô</div><div class="vl" id="all_max_dd">0</div></div>
        <div class="comm-stat" style="background:rgba(29,78,216,.06)"><div class="lb">Max Bet ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏ô</div><div class="vl" id="all_max_bet">0</div></div>
      </div>
    </div>

    <div class="target-box">
      <div class="target-title">üéØ Target Profit (‡∏ï‡πà‡∏≠ cycle) + Bet Reduction</div>
      <div class="form-group">
        <label>Reset Cycle if Profit >=</label>
        <input type="number" id="target_profit" value="0.01" step="0.01" oninput="updateUI()">
        <div class="mini-note">‡∏°‡∏µ Target Sniper ‡∏•‡∏î bet ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏Å‡∏¥‡∏ô target (‡∏ï‡∏≤‡∏° chip/min bet)</div>
      </div>
    </div>

    <div class="feature-box" id="survival_box">
      <div class="feature-title">üõ°Ô∏è Survival Mode</div>
      <div class="dual-input">
        <div class="form-group"><label>Trigger DD%</label><input type="number" id="surv_trigger" value="24.05" step="0.01" oninput="updateUI()"></div>
        <div class="form-group"><label>Div Multiplier</label><input type="number" id="surv_div" value="1.61" step="0.01" oninput="updateUI()"></div>
      </div>
    </div>

    <div class="form-group"><label>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Bankroll)</label><input type="number" id="init_bank" value="514502" oninput="updateUI()"></div>
    <div class="form-group"><label>Max Bet</label><input type="number" id="max_bet_cap" value="51964" oninput="updateUI()"></div>

    <div class="dual-input">
      <div class="form-group"><label>Min Bet</label><input type="number" id="min_bet" value="5" oninput="updateUI()"></div>
      <div class="form-group"><label style="color:var(--primary);">Chip Unit</label><input type="number" id="chip_size" value="5" style="border:2px solid var(--primary);font-weight:bold" oninput="updateUI()"></div>
    </div>

    <button class="btn-restore" onclick="restoreRecommended()">‚Ü∫ ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ (DEFAULT)</button>

    <div class="section-title">üéØ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status)</div>
    <div class="monitor-box">
      <span class="monitor-label">Cycle Profit / Cycle HWM</span>
      <div id="target_status_display" class="monitor-val">0 / 0</div>
      <div class="cycle-monitor">
        <span>Cycle Profit / Target:</span>
        <span id="cycle_profit_disp" style="color:var(--target);font-weight:bold;">0</span>
      </div>
      <div style="font-size:.7rem;color:#d7f7e6;margin-top:8px;">
        ‡∏ó‡∏∏‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°): <b id="bankroll_left_disp">0</b><br/>
        Cycle #: <b id="cycle_no_disp">0</b> | Cycles Saved: <b id="session_saved_disp">0</b>
      </div>
    </div>

    <div class="sess-box">
      <div class="sess-head">
        <div class="t">üìí Cycle History (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</div>
        <div class="sess-actions">
          <button class="btn-mini export" onclick="exportSessionHistory()">Export JSON</button>
          <button class="btn-mini clear" onclick="clearSessionHistory()">Clear</button>
        </div>
      </div>
      <div class="sess-table-wrap">
        <table class="sess-table">
          <thead>
            <tr>
              <th>#</th><th>Reason</th><th>Hands</th><th>Cycle</th><th>Comm</th><th>Turn</th><th>Left</th><th>Time</th>
            </tr>
          </thead>
          <tbody id="session_table_body">
            <tr><td colspan="8" class="muted" style="padding:10px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ cycle ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="section-title">üß† Monitors</div>
    <div class="brain-monitor">
      <div class="brain-col">
        <div class="brain-head txt-p">CENTRAL STAKER</div>
        <div class="brain-val txt-p" id="mon_bal">0</div>
        <div class="brain-info" id="mon_info">Wait:0 | Stg:0 | CL:0</div>
      </div>
      <div class="brain-col">
        <div class="brain-head txt-b">NET (side/strength)</div>
        <div class="brain-val txt-b" id="mon_net">WAIT</div>
        <div class="brain-info" id="mon_net_info">P:0 B:0</div>
      </div>
    </div>

    <div class="section-title">üß™ ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ú‡∏• (Bottom)</div>
    <div class="form-group">
      <label>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°</label>
      <select id="rng_method_bot" onchange="onRngChange(); syncSimSettings('bot')">
        <option value="math">üé≤ Standard</option>
        <option value="crypto">üîí Crypto</option>
        <option value="shoe" selected>üÉè Real Shoe</option>
      </select>
    </div>

    <div class="form-group">
      <input type="number" id="sim_hands_bot" value="1" oninput="syncSimSettings('bot')">
      <button class="btn-action btn-sim" onclick="runSimulation()">‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ú‡∏• (Simulate)</button>

      <label style="margin-top:10px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß Auto Sim:</label>
      <select id="sim_speed_bot" onchange="syncSimSettings('bot')">
        <option value="0">üöÄ ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</option>
        <option value="20" selected>‚ö° ‡πÄ‡∏£‡πá‡∏ß</option>
      </select>

      <button class="btn-action btn-auto" id="btn_auto_sim_bot" onclick="toggleAutoSim()">üöÄ Auto Sim</button>
      <button class="btn-action btn-stop" id="btn_stop_sim_bot" onclick="stopAutoSim()">‚èπ STOP</button>

      <div id="sim_stats_display_bot" style="display:none;font-size:.75rem;text-align:center;margin-top:5px;">
        ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà: <span id="sim_round_count_bot">0</span> | ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (cycle): <span id="sim_success_count_bot" style="color:green;">0</span>
      </div>
    </div>

    <button class="btn-reset" onclick="resetAll()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Hard Reset)</button>
  </div>

  <div class="main-content">
    <div class="stats-grid">
      <div class="stat-card profit"><div class="stat-label">Cycle Profit</div><div class="stat-value" id="disp_net">0</div></div>
      <div class="stat-card comm"><div class="stat-label">Cycle + Commission</div><div class="stat-value" id="disp_net_comm" style="color:var(--comm);">0</div></div>
      <div class="stat-card"><div class="stat-label">Max Drawdown (run)</div><div class="stat-value" id="disp_dd">0</div></div>
      <div class="stat-card loss"><div class="stat-label">Max Bet (cycle)</div><div class="stat-value" id="disp_maxbet">0</div></div>
      <div class="stat-card"><div class="stat-label">Hands (cycle)</div><div class="stat-value" id="disp_hands">0</div></div>
      <div class="stat-card pre"><div class="stat-label">Net Mode</div><div class="stat-value" id="disp_mode">weight</div></div>
      <div class="stat-card pre"><div class="stat-label">Net Strength</div><div class="stat-value" id="disp_strength">0</div></div>
      <div class="stat-card comm"><div class="stat-label">Commission (cycle)</div><div class="stat-value" id="disp_comm_total" style="color:var(--comm);">0</div></div>
    </div>

    <div class="road-scroll-wrapper"><div class="big-road-grid" id="road_container"></div></div>

    <div class="bet-panel">
      <div class="offset-formula" id="formula_disp">Central Staker √ó Net Strength</div>
      <div class="rec-amount" id="rec_amount">0</div>
      <div class="rec-side side-n" id="rec_side">WAIT</div>
      <div class="controls">
        <button class="btn-ctrl btn-p" onclick="processResult('P')">PLAYER</button>
        <button class="btn-ctrl btn-b" onclick="processResult('B')">BANKER</button>
        <button class="btn-ctrl btn-u" onclick="undo()">UNDO</button>
      </div>
    </div>

    <div class="chart-box"><canvas id="profitChart"></canvas></div>
  </div>
</div>

<div class="modal-overlay" id="guideModal">
  <div class="modal-box" style="border:2px solid var(--comm); text-align:left;">
    <div class="modal-icon" style="width:100%;text-align:center;">üìñ</div>
    <div class="modal-text-th" style="color:var(--comm); text-align:center;">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô</div>
    <div style="font-size:.9rem;line-height:1.8;color:#2c3e50;margin-top:10px;">
      - ‡∏Ñ‡∏∑‡∏ô <b>OFFSET</b> ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô 5 ‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡πÅ‡∏ö‡∏ö V3.4 ‡πÄ‡∏î‡∏¥‡∏°)<br/>
      - Offset / Something Else ‡πÉ‡∏ä‡πâ P-Engine vs B-Engine ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏ß‡∏ï‡∏ù‡∏±‡πà‡∏á<br/>
      - Bet ‡∏à‡∏£‡∏¥‡∏á = Central Staker √ó f(net_strength)<br/>
      - ‡∏°‡∏µ Target Sniper ‡∏•‡∏î bet ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏Å‡∏¥‡∏ô target (‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà chip/min bet ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï)
    </div>
    <button class="btn-modal-ack" style="background:var(--comm);" onclick="closeGuideModal()">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß ‚úì</button>
  </div>
</div>

<script>
/* =========================
   Real Shoe Engine (8 Deck + Burn Card)
   ========================= */
const SUITS=['‚ô†','‚ô•','‚ô¶','‚ô£'];
const RANKS=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
const BAC_VAL={A:1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':0,J:0,Q:0,K:0};
const BURN_VAL={A:1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,J:10,Q:10,K:10};
let shoe={deck:[],total:416,used:0,no:0,pen:60,cutAt:0,lastHand:null,burnInfo:null,ready:false};
function isRedSuit(s){return s==='‚ô•'||s==='‚ô¶';}
function cryptoRandInt(maxExclusive){
  if(!(window.crypto && window.crypto.getRandomValues)) throw new Error("Crypto RNG not available");
  const a=new Uint32Array(1); window.crypto.getRandomValues(a); return a[0] % maxExclusive;
}
function randFloat01(){
  if(!(window.crypto && window.crypto.getRandomValues)) throw new Error("Crypto RNG not available");
  const a=new Uint32Array(1); window.crypto.getRandomValues(a); return a[0] / 4294967296;
}
function pickCutAt(total, penPercent){
  const target = Math.floor(total*(penPercent/100));
  const jitter = Math.floor(total*0.04);
  const lo = Math.max(60, target - jitter);
  const hi = Math.min(total - 20, target + jitter);
  return lo + Math.floor(randFloat01() * (hi - lo + 1));
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=cryptoRandInt(i+1);
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function build8Deck(){
  const d=[];
  for(let k=0;k<8;k++) for(const s of SUITS) for(const r of RANKS) d.push({rank:r,suit:s,v:BAC_VAL[r]});
  return d;
}
function bacScore(cards){ let t=0; for(const c of cards) t+=c.v; return t%10; }
function makeCardEl(card, faceDown=false){
  const div=document.createElement('div');
  div.className='mini-card'+(faceDown?' down':(isRedSuit(card.suit)?' red':' black'));
  if(!faceDown) div.innerHTML=`<div class="cr">${card.rank}</div><div class="cs">${card.suit}</div>`;
  return div;
}
function makeBurnRevealEl(card){ const el=makeCardEl(card,false); el.classList.add('burn-reveal'); return el; }
function shoeNeedCut(){ return shoe.used>=shoe.cutAt || shoe.deck.length<6; }
function shoeDraw(){ if(shoe.deck.length===0) return null; shoe.used++; return shoe.deck.pop(); }
function doBurnCeremony(){
  const reveal=shoeDraw(); if(!reveal) return;
  const burnN=BURN_VAL[reveal.rank];
  const downs=[];
  for(let i=0;i<burnN;i++){ const c=shoeDraw(); if(!c) break; downs.push(c); }
  shoe.burnInfo={reveal,burnN,downs};
  document.getElementById('burn_box').style.display='block';
  const slot=document.getElementById('burn_card_slot');
  slot.innerHTML=''; slot.appendChild(makeBurnRevealEl(reveal));
  document.getElementById('burn_label').innerText=`${reveal.rank}${reveal.suit} ‚Üí ‡∏ó‡∏¥‡πâ‡∏á‡∏Ñ‡∏ß‡πà‡∏≥ ${burnN} ‡πÉ‡∏ö`;
  const row=document.getElementById('burn_down_row');
  row.innerHTML=''; downs.forEach(c=>row.appendChild(makeCardEl(c,true)));
  document.getElementById('burn_note').innerText=
`‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ö‡∏≤‡∏Ñ‡∏≤‡∏£‡πà‡∏≤:
- ‡∏´‡∏á‡∏≤‡∏¢‡πÑ‡∏û‡πà‡πÉ‡∏ö‡πÅ‡∏£‡∏Å‡∏î‡∏π‡πÅ‡∏ï‡πâ‡∏°
- ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏û‡πà‡πÉ‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ß‡πà‡∏≥‡∏ï‡∏≤‡∏°‡πÅ‡∏ï‡πâ‡∏°
A=1, 2-9=‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç, 10/J/Q/K=10
‡∏£‡∏ß‡∏°‡πÑ‡∏û‡πà‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏≠‡∏≠‡∏Å: ${burnN+1} ‡πÉ‡∏ö`;
}
function initShoe(force=false){
  if(shoe.ready && !force) return;
  const d=shuffle(shuffle(shuffle(build8Deck())));
  shoe.deck=d; shoe.total=d.length; shoe.used=0; shoe.no++;
  shoe.lastHand=null; shoe.burnInfo=null; shoe.ready=true;
  shoe.pen=parseInt(document.getElementById('shoe_pen').value)||60;
  shoe.cutAt = pickCutAt(shoe.total, shoe.pen);
  doBurnCeremony();
  refreshShoeUI();
}
function dealBaccarat(){
  if(!shoe.ready) initShoe(true);
  if(shoeNeedCut()) initShoe(true);
  const P=[shoeDraw(),shoeDraw()];
  const B=[shoeDraw(),shoeDraw()];
  if(!P[0]||!P[1]||!B[0]||!B[1]){ initShoe(true); return dealBaccarat(); }
  let p=bacScore(P), b=bacScore(B);
  const pNat=p>=8, bNat=b>=8;
  let pThird=null;
  if(!pNat && !bNat){
    if(p<=5){
      pThird=shoeDraw();
      if(pThird){ P.push(pThird); p=bacScore(P); }
    }
    if(pThird===null){
      if(b<=5){
        const b3=shoeDraw();
        if(b3){ B.push(b3); b=bacScore(B); }
      }
    }else{
      const pt=pThird.v;
      let bankerDraw=false;
      if(b<=2) bankerDraw=true;
      else if(b===3 && pt!==8) bankerDraw=true;
      else if(b===4 && pt>=2 && pt<=7) bankerDraw=true;
      else if(b===5 && pt>=4 && pt<=7) bankerDraw=true;
      else if(b===6 && pt>=6 && pt<=7) bankerDraw=true;
      if(bankerDraw){
        const b3=shoeDraw();
        if(b3){ B.push(b3); b=bacScore(B); }
      }
    }
  }
  const res=(p>b)?'P':(b>p?'B':'T');
  shoe.lastHand={P,B,p,b,res};
  refreshShoeUI();
  return res;
}
function refreshShoeUI(){
  const ui=document.getElementById('shoe_ui');
  if(!ui) return;
  const m=document.getElementById('rng_method').value;
  if(m!=='shoe'){ ui.classList.remove('active'); return; }
  ui.classList.add('active');
  if(!shoe.ready) return;
  const pct=(shoe.used/shoe.total)*100;
  document.getElementById('sb_fill').style.width=pct.toFixed(1)+'%';
  document.getElementById('sb_txt').innerText=`${shoe.used} / ${shoe.total} (${pct.toFixed(1)}%)`;
  document.getElementById('sb_cut').style.left=((shoe.cutAt/shoe.total)*100).toFixed(1)+'%';
  document.getElementById('sh_rem').innerText=shoe.total-shoe.used;
  document.getElementById('sh_used').innerText=shoe.used;
  document.getElementById('sh_no').innerText=shoe.no;
  const dealArea=document.getElementById('deal_area');
  if(shoe.lastHand){
    dealArea.style.display='block';
    const pc=document.getElementById('pc_row');
    const bc=document.getElementById('bc_row');
    pc.innerHTML=''; bc.innerHTML='';
    shoe.lastHand.P.forEach(c=>pc.appendChild(makeCardEl(c,false)));
    shoe.lastHand.B.forEach(c=>bc.appendChild(makeCardEl(c,false)));
    while(pc.children.length<3){ const ph=document.createElement('div'); ph.className='mini-card placeholder'; pc.appendChild(ph); }
    while(bc.children.length<3){ const ph=document.createElement('div'); ph.className='mini-card placeholder'; bc.appendChild(ph); }
    document.getElementById('pc_sc').innerText=shoe.lastHand.p;
    document.getElementById('bc_sc').innerText=shoe.lastHand.b;
    const dr=document.getElementById('deal_res');
    if(shoe.lastHand.res==='P'){ dr.innerText=`PLAYER WIN ‚Äî P:${shoe.lastHand.p} vs B:${shoe.lastHand.b}`; dr.style.color='#3498db'; }
    else if(shoe.lastHand.res==='B'){ dr.innerText=`BANKER WIN ‚Äî P:${shoe.lastHand.p} vs B:${shoe.lastHand.b}`; dr.style.color='#e74c3c'; }
    else { dr.innerText=`TIE ‚Äî P:${shoe.lastHand.p} vs B:${shoe.lastHand.b}`; dr.style.color='#27ae60'; }
  }else{
    dealArea.style.display='none';
  }
}
function onPenChange(){
  shoe.pen=parseInt(document.getElementById('shoe_pen').value)||60;
  if(document.getElementById('rng_method').value==='shoe') initShoe(true);
  refreshShoeUI();
}
function onRngChange(){
  const m=document.getElementById('rng_method').value;
  const ui=document.getElementById('shoe_ui');
  if(m==='shoe'){
    ui.classList.add('active');
    initShoe(false);
    refreshShoeUI();
  }else{
    ui.classList.remove('active');
  }
}

/* =========================
   Core System
   ========================= */
const UNDO_STACK_LIMIT = 500;
const MAX_STAGE = 30;
const DEFAULT_DIVISOR = 2.0;

let undoStack=[];
let chartInstance=null;
let isAutoRunning=false;
let simRoundCount=0;
let simSuccessCount=0;
let autoTimer=null;
let cycleHistory=[];
let cycleNo=0;
let cycleStartTs=Date.now();

let lifetime = { net:0, comm:0, maxBet:0, highWater:0, maxDrawdown:0 };
function lifetimeEquity(){ return lifetime.net + lifetime.comm; }

let state={
  realBalance:0,
  commTotal:0,
  equityHigh:0,
  maxDDEquity:0,

  history:[],
  roadAll:[],
  maxBet:0,
  cycleStartBalance:0,

  commTurnover:0,
  commHands:0,

  graphData:[0],
  graphLabels:[0],

  staker:{bal:0,wait:1,stage:0,initBet:0,cons_loss:0, equity_high_cycle:0},
  lastNet:{side:'WAIT', strength:0, p:0, b:0, p_cnt:0, b_cnt:0},
  commTotalStart:0,

  // ‚úÖ restore dual engines for OFFSET / SomethingElse vote
  pStrat:{bal:0,wait:0,stage:0,initBet:0,cons_loss:0},
  bStrat:{bal:0,wait:0,stage:0,initBet:0,cons_loss:0}
};

function getBankroll(){ return parseFloat(document.getElementById('init_bank').value)||0; }
function getMinBet(){ return parseFloat(document.getElementById('min_bet').value)||0; }
function getChip(){ return parseFloat(document.getElementById('chip_size').value)||1; }
function getEquity(){ return state.realBalance + state.commTotal; }
function getBankrollLeft(){ return getBankroll() + getEquity(); }
function getCycleProfit(){ return state.realBalance - state.cycleStartBalance; }
function getCycleHwm(){ return state.staker.equity_high_cycle || 0; }

function saveState(){
  undoStack.push({
    state: JSON.parse(JSON.stringify(state)),
    cycleHistory: JSON.parse(JSON.stringify(cycleHistory)),
    cycleNo,
    cycleStartTs,
    simRoundCount,
    simSuccessCount,
    lifetime: JSON.parse(JSON.stringify(lifetime))
  });
  if(undoStack.length > UNDO_STACK_LIMIT) undoStack.shift();
}
function undo(){
  if(undoStack.length===0) return;
  const snap=undoStack.pop();
  state=snap.state;
  cycleHistory=snap.cycleHistory || [];
  cycleNo=snap.cycleNo || 0;
  cycleStartTs=snap.cycleStartTs || Date.now();
  simRoundCount = snap.simRoundCount || 0;
  simSuccessCount = snap.simSuccessCount || 0;
  lifetime = snap.lifetime || lifetime;
  updateUI();
}

function roundToChip(val){
  const chip=getChip();
  const min=getMinBet();
  if(!Number.isFinite(val) || val<=0) return 0;
  const rounded=Math.ceil(val/chip)*chip;
  return Math.max(min, rounded);
}
function capBetToBankroll(bet){
  if(!Number.isFinite(bet) || bet<=0) return 0;
  const chip=getChip();
  const left=getBankrollLeft();
  const minBet=getMinBet();
  if(left<=0) return 0;
  const capped=Math.floor(Math.min(bet,left)/chip)*chip;
  if(capped<minBet) return 0;
  return capped;
}

function getDdPercentFromEquityHigh(){
  const bank=getBankroll();
  if(bank<=0) return 0;
  const eq=getEquity();
  const high=state.equityHigh || 0;
  const dd = eq - high;
  return (Math.abs(Math.min(0,dd)) / bank) * 100;
}
function calculateDivisor(deficit, minBet){
  let baseDiv=DEFAULT_DIVISOR;
  const survTrigger=parseFloat(document.getElementById('surv_trigger').value)||8;
  const survMult=parseFloat(document.getElementById('surv_div').value)||1.85;
  const ddPercent = getDdPercentFromEquityHigh();
  if(ddPercent>=survTrigger){
    baseDiv*=survMult;
    document.getElementById('survival_box').classList.add('survival-active');
  }else{
    document.getElementById('survival_box').classList.remove('survival-active');
  }
  if(deficit>500*minBet) baseDiv-=0.1;
  if(deficit>2000*minBet) baseDiv-=0.1;
  if(deficit>5000*minBet) baseDiv-=0.1;
  if(baseDiv<1.5) baseDiv=1.5;
  return baseDiv;
}

// ---- Central Staker ----
function resetStaker(){
  state.staker = {bal:0,wait:1,stage:0,initBet:0,cons_loss:0, equity_high_cycle:0};
}
function stakerProposeBaseBet(){
  const s=state.staker;
  const minBet=getMinBet();
  if(s.stage > MAX_STAGE) s.stage = MAX_STAGE;
  let bet=0;
  if(s.stage>=1){
    bet = s.initBet * Math.pow(2, Math.max(0, s.stage-1));
  }else if(s.wait>=1){
    const deficit = Math.abs(s.bal);
    if(deficit>0){
      let div = calculateDivisor(deficit, minBet);
      const cl = Math.min(200, Math.max(0, s.cons_loss||0));
      div = div * Math.pow(1.04, cl);
      bet = (div<=0) ? 0 : ((deficit + minBet) / div);
    }else bet = minBet;
  }
  if(!Number.isFinite(bet) || bet<=0) return 0;
  bet = roundToChip(bet);
  const maxBetCap=parseFloat(document.getElementById('max_bet_cap').value)||0;
  if(maxBetCap>0) bet = Math.min(bet, maxBetCap);
  return bet;
}
function stakerUpdateOnResult(netSide, bet, res){
  const s=state.staker;
  const cp=getCycleProfit();
  if(cp > (s.equity_high_cycle||0)) s.equity_high_cycle = cp;
  if(bet<=0 || netSide==='WAIT') return;
  if(res==='T') return;
  const isWin = (netSide==='P' && res==='P') || (netSide==='B' && res==='B');
  if(isWin){
    s.wait = Math.max(1, (s.wait||0) + 1);
    s.cons_loss=0;
    const profit = (netSide==='B') ? (bet*0.95) : bet;
    s.bal += profit;
    if(s.stage===0){ s.initBet=bet; s.stage=1; }
    else s.stage = Math.min(MAX_STAGE, (s.stage||0)+1);
  }else{
    s.wait = 1;
    s.cons_loss=(s.cons_loss||0)+1;
    s.bal -= bet;
    s.stage=0;
  }
}

// ---- Dual engines (restored) for OFFSET / SomethingElse votes ----
function getRawBet(strat){
  const minBet=getMinBet();
  const maxBetCap=parseFloat(document.getElementById('max_bet_cap').value)||0;
  let bet=0;
  if(strat.stage > MAX_STAGE) strat.stage = MAX_STAGE;
  if(strat.stage>=1){
    bet=strat.initBet*Math.pow(2, Math.max(0, strat.stage-1));
  }else if(strat.wait>=1){
    const deficit=Math.abs(strat.bal);
    if(deficit>0){
      let div=calculateDivisor(deficit,minBet);
      const cl = Math.min(200, (strat.cons_loss||0));
      div=div*Math.pow(1.04, cl);
      bet=(div<=0)?0:((deficit+minBet)/div);
    }else bet=minBet;
  }
  if(!Number.isFinite(bet) || bet<=0) return 0;
  bet = roundToChip(bet);
  if(maxBetCap>0) bet = Math.min(bet, maxBetCap);
  return bet;
}
function updateAI(strat,side,res,rawBet){
  if(res==='T') return;
  const isWin=(side==='P'&&res==='P')||(side==='B'&&res==='B');
  if(isWin){
    strat.wait++; strat.cons_loss=0;
    strat.bal += (side==='P') ? rawBet : (rawBet*0.95);
    if(rawBet>0){
      if(strat.stage===0){ strat.initBet=rawBet; strat.stage=1; }
      else strat.stage = Math.min((strat.stage||0) + 1, MAX_STAGE);
    }
  }else{
    strat.wait=0;
    strat.cons_loss=(strat.cons_loss||0)+1;
    if(rawBet>0){ strat.bal-=rawBet; strat.stage=0; }
  }
}
function resetDualEngines(){
  state.pStrat={bal:0,wait:0,stage:0,initBet:0,cons_loss:0};
  state.bStrat={bal:0,wait:0,stage:0,initBet:0,cons_loss:0};
}

// ---- Policy AI (trained weights) ----
const TRAINED_POLICY = {
  wP: { c:-0.3928252531634952, bias:0.8708993699161368, zig:0.9898610254061753, tieRate:-0.3955203431275083, streakN:-0.13981681295704762, lastP:0.2532830015248164, lastB:0.07488143904492145 },
  wB: { c:-1.1508993524052586, bias:-0.4321370196771435, zig:-0.9614563873601566, tieRate:0.2576827616572196, streakN:-0.41800751134256997, lastP:0.24814946837852042, lastB:0.3477249348305153 },
  wW: { c:-0.5528507363362684, bias:1.3951764069146138, zig:-0.16996934097562105, tieRate:-1.1134453873209744, streakN:1.0447036802114804, lastP:0.5488793440369264, lastB:1.0476893375084022 }
};
function _sigmoid(x){ if(x > 60) return 1; if(x < -60) return 0; return 1 / (1 + Math.exp(-x)); }
function _dot(w, f){
  return (w.c||0)*(f.c||0)+(w.bias||0)*(f.bias||0)+(w.zig||0)*(f.zig||0)+(w.tieRate||0)*(f.tieRate||0)+(w.streakN||0)*(f.streakN||0)+(w.lastP||0)*(f.lastP||0)+(w.lastB||0)*(f.lastB||0);
}
function _computePolicyFeatures(){
  const h = state.history || [];
  const N = h.length;
  const W = Math.min(30, N);
  const slice = h.slice(-W);
  const last = (N > 0) ? h[N-1] : null;
  const lastP = (last === 'P') ? 1 : 0;
  const lastB = (last === 'B') ? 1 : 0;
  let streak = (N > 0) ? 1 : 0;
  if(N >= 2){
    for(let i=N-2;i>=0;i--){
      if(h[i] === last) streak++;
      else break;
    }
  }
  const streakN = (N===0) ? 0 : Math.min(1, Math.log(1+streak) / Math.log(1+15));
  let zigCnt = 0;
  for(let i=0;i<slice.length-1;i++) if(slice[i] !== slice[i+1]) zigCnt++;
  const zig = (slice.length <= 1) ? 0 : zigCnt/(slice.length-1);
  let ties = 0;
  for(const r of slice) if(r === 'T') ties++;
  const tieRate = (slice.length === 0) ? 0 : ties/slice.length;
  let p=0, b=0;
  for(const r of slice){ if(r === 'P') p++; else if(r === 'B') b++; }
  const denom = p+b;
  const bias = (denom === 0) ? 0 : (p-b)/denom;
  return { c:1, bias, zig, tieRate, streakN, lastP, lastB };
}
function policyVote(){
  const f=_computePolicyFeatures();
  const LP=_dot(TRAINED_POLICY.wP,f);
  const LB=_dot(TRAINED_POLICY.wB,f);
  const LW=_dot(TRAINED_POLICY.wW,f);
  let action='WAIT';
  let best=LW;
  if(LP>best){ best=LP; action='P'; }
  if(LB>best){ best=LB; action='B'; }
  const w=parseFloat(document.getElementById('w_policy_ai').value)||1;
  return { side: action, w, dbg:{LP,LB,LW,r:_sigmoid(best)} };
}

function lastNonTie(){
  for(let i=state.history.length-1;i>=0;i--){
    const x=state.history[i];
    if(x==='P' || x==='B') return x;
  }
  return null;
}

// ---- Strategy votes (5) ----
function voteOffset(){
  const w=parseFloat(document.getElementById('w_offset').value)||1;
  const rawP=getRawBet(state.pStrat);
  const rawB=getRawBet(state.bStrat);
  if(rawP===0 && rawB===0) return {side:'WAIT', w:0, dbg:{rawP,rawB}};
  if(rawP>rawB) return {side:'P', w, dbg:{rawP,rawB}};
  if(rawB>rawP) return {side:'B', w, dbg:{rawP,rawB}};
  return {side:'WAIT', w:0, dbg:{rawP,rawB}};
}
function voteSomethingElse(){
  const w=parseFloat(document.getElementById('w_something_else').value)||1;
  const rawP=getRawBet(state.pStrat);
  const rawB=getRawBet(state.bStrat);
  const diff=Math.abs(rawP-rawB);
  const threshold=Math.max(getMinBet(), 2*getChip());
  if(rawP===0 && rawB===0) return {side:'WAIT', w:0, dbg:{rawP,rawB,threshold}};
  if(diff<=threshold){
    // ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°: diff ‡∏ô‡πâ‡∏≠‡∏¢ => BANKER
    return {side:'B', w, dbg:{rawP,rawB,threshold}};
  }
  // diff ‡∏°‡∏≤‡∏Å => offset
  if(rawP>rawB) return {side:'P', w, dbg:{rawP,rawB,threshold}};
  if(rawB>rawP) return {side:'B', w, dbg:{rawP,rawB,threshold}};
  return {side:'WAIT', w:0, dbg:{rawP,rawB,threshold}};
}
function voteAntiLast(){
  const last=lastNonTie();
  if(!last) return {side:'WAIT', w:0};
  const w=parseFloat(document.getElementById('w_anti_last').value)||1;
  return {side:(last==='P'?'B':'P'), w};
}
function voteFollowLast(){
  const last=lastNonTie();
  if(!last) return {side:'WAIT', w:0};
  const w=parseFloat(document.getElementById('w_follow_last').value)||1;
  return {side:last, w};
}

function getVotes(){
  const votes=[];
  if(document.getElementById('use_offset').checked) votes.push(voteOffset());
  if(document.getElementById('use_anti_last').checked) votes.push(voteAntiLast());
  if(document.getElementById('use_follow_last').checked) votes.push(voteFollowLast());
  if(document.getElementById('use_something_else').checked) votes.push(voteSomethingElse());
  if(document.getElementById('use_policy_ai').checked) votes.push(policyVote());
  return votes;
}

function netVotes(votes){
  const mode=document.getElementById('net_mode').value;
  const minStrength=parseFloat(document.getElementById('min_strength').value)||1.0;
  let p=0, b=0, p_cnt=0, b_cnt=0;
  for(const v of votes){
    const side=v.side;
    const w=Math.max(0, Number(v.w||0));
    if(side==='P'){ p_cnt++; p += (mode==='count') ? 1 : w; }
    else if(side==='B'){ b_cnt++; b += (mode==='count') ? 1 : w; }
  }
  const strength=Math.abs(p-b);
  let side='WAIT';
  if(strength>=minStrength && p!==b) side = (p>b) ? 'P' : 'B';
  state.lastNet = {side, strength, p, b, p_cnt, b_cnt};
  return {side, strength, p, b};
}

function strengthMultiplier(strength){
  if(strength <= 0) return 0.0;
  if(strength < 1.0) return 0.0;
  if(strength < 2.0) return 1.0;
  if(strength < 3.0) return 1.3;
  if(strength < 4.0) return 1.6;
  return 2.0;
}

function applyTargetSniper(bet, side){
  const targetProfit=parseFloat(document.getElementById('target_profit').value)||0;
  if(targetProfit<=0) return bet;
  if(bet<=0) return bet;
  const cp=getCycleProfit();
  const needed = targetProfit - cp;
  if(needed<=0) return 0;
  const chip=getChip();
  const minBet=getMinBet();
  let reqBet = needed;
  if(side==='B') reqBet = needed / 0.95;
  let adj = Math.floor(reqBet / chip) * chip; // floor -> ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏Å‡∏¥‡∏ô
  if(adj < minBet) return minBet;
  return adj;
}

function computeRecommendation(){
  const votes=getVotes();
  const net=netVotes(votes);
  const base=stakerProposeBaseBet();
  const mult=strengthMultiplier(net.strength);
  let side='WAIT', bet=0;
  if(net.side==='P' || net.side==='B'){
    side=net.side;
    bet = roundToChip(base * mult);
    bet = applyTargetSniper(bet, side);
    const maxBetCap=parseFloat(document.getElementById('max_bet_cap').value)||0;
    if(maxBetCap>0) bet = Math.min(bet, maxBetCap);
    bet = capBetToBankroll(bet);
    if(bet<=0) side='WAIT';
  }
  const formula = `Net(${document.getElementById('net_mode').value}) P=${state.lastNet.p.toFixed(2)} B=${state.lastNet.b.toFixed(2)} | str=${state.lastNet.strength.toFixed(2)} | base=${base.toFixed(0)} √ó f=${mult.toFixed(2)}`;
  return {side, bet, formula};
}

function applyCommission(bet, res){
  if(bet<=0) return 0;
  if(res==='T') return 0;
  const commRate=parseFloat(document.getElementById('commission_rate').value)||0;
  state.commTurnover += bet;
  state.commHands += 1;
  const comm = (commRate>0) ? bet*(commRate/100) : 0;
  state.commTotal += comm;
  return comm;
}
function settleBet(netSide, bet, res){
  if(bet<=0 || netSide==='WAIT') return 0;
  if(res==='T') return 0;
  if(netSide==='P') return (res==='P') ? bet : -bet;
  if(netSide==='B') return (res==='B') ? (bet*0.95) : -bet;
  return 0;
}
function updateLifetime(netDelta, commAdded, bet){
  lifetime.net += netDelta;
  lifetime.comm += commAdded;
  if(bet>lifetime.maxBet) lifetime.maxBet = bet;
  const eq = lifetimeEquity();
  if(eq > lifetime.highWater) lifetime.highWater = eq;
  const dd = eq - lifetime.highWater;
  if(dd < lifetime.maxDrawdown) lifetime.maxDrawdown = dd;
}

function pushOutcome(res){ state.history.push(res); state.roadAll.push(res); }

function resetCycle(reason){
  const cp=getCycleProfit();
  const commCycle = state.commTotal - (state.commTotalStart||0);

  cycleHistory.push({
    cycleNo,
    reason,
    tsStart: cycleStartTs,
    tsEnd: Date.now(),
    hands: state.history.length,
    cycleProfit: cp,
    comm: commCycle,
    netPlusComm: cp + commCycle,
    turnover: state.commTurnover,
    betHands: state.commHands,
    bankrollLeft: getBankrollLeft()
  });

  cycleNo += 1;
  cycleStartTs = Date.now();

  // ===== ‚úÖ FIX: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ ‚ÄúReset Road ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö cycle‚Äù ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á =====
  // - yes: ‡∏•‡πâ‡∏≤‡∏á Big Road (roadAll)
  // - no : ‡∏™‡∏∞‡∏™‡∏°‡∏ï‡πà‡∏≠ (‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£)
  const rr = (document.getElementById('reset_road_on_cycle')?.value || 'no');
  if(rr === 'yes'){
    state.roadAll = [];
  }
  // ================================================================

  state.history = [];
  resetStaker();
  resetDualEngines();
  state.cycleStartBalance = state.realBalance;
  state.commTotalStart = state.commTotal;
  state.commTurnover = 0;
  state.commHands = 0;
  state.maxBet = 0;

  simSuccessCount += 1;
  renderSessionHistory();
  updateUI();
}

function checkBustAndStop(){
  const left=getBankrollLeft();
  const minBet=getMinBet();
  if(left<=0 || left<minBet){
    cycleHistory.push({
      cycleNo,
      reason: (left<=0) ? "BUST: Bankroll <= 0" : "BUST: Bankroll < MinBet",
      tsStart: cycleStartTs,
      tsEnd: Date.now(),
      hands: state.history.length,
      cycleProfit: getCycleProfit(),
      comm: state.commTotal - (state.commTotalStart||0),
      netPlusComm: getCycleProfit() + (state.commTotal - (state.commTotalStart||0)),
      turnover: state.commTurnover,
      betHands: state.commHands,
      bankrollLeft: left
    });
    renderSessionHistory();
    stopAutoSim();
    updateUI();
    return true;
  }
  return false;
}

function processResult(res, isSim=false){
  if(checkBustAndStop()) return;
  if(!isSim) saveState();

  // snapshot raw bets (for dual engines update)
  const rawP=getRawBet(state.pStrat);
  const rawB=getRawBet(state.bStrat);

  // recommendation (central staker)
  const rec = computeRecommendation();
  const netSide = rec.side;
  const bet = rec.bet;

  const commAdded = applyCommission(bet, res);
  const netDelta  = settleBet(netSide, bet, res);
  state.realBalance += netDelta;

  // run equity HWM/DD
  const eqNow = getEquity();
  if(eqNow > (state.equityHigh||0)) state.equityHigh = eqNow;
  const dd = eqNow - (state.equityHigh||0);
  if(dd < (state.maxDDEquity||0)) state.maxDDEquity = dd;

  // update central staker
  stakerUpdateOnResult(netSide, bet, res);

  // update dual engines (always, like V3.4)
  updateAI(state.pStrat,'P',res,rawP);
  updateAI(state.bStrat,'B',res,rawB);

  // history
  pushOutcome(res);

  // chart
  state.graphData.push(getEquity());
  state.graphLabels.push(state.graphLabels.length);
  if(bet > state.maxBet) state.maxBet = bet;

  // lifetime
  if(bet>0 && res!=='T') updateLifetime(netDelta, commAdded, bet);

  const targetProfit=parseFloat(document.getElementById('target_profit').value)||0;
  if(targetProfit>0 && getCycleProfit() >= targetProfit){
    resetCycle(`Target Reached (+${getCycleProfit().toFixed(2)})`);
    return;
  }

  if(checkBustAndStop()) return;
  updateUI();
}

function renderSessionHistory(){
  const body=document.getElementById('session_table_body');
  if(!body) return;
  if(cycleHistory.length===0){
    body.innerHTML=`<tr><td colspan="8" class="muted" style="padding:10px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ cycle ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td></tr>`;
    return;
  }
  body.innerHTML=cycleHistory.slice(-60).reverse().map(s=>{
    const cls=(s.netPlusComm>=0)?'pos':'neg';
    const t=new Date(s.tsEnd);
    const timeStr=t.toLocaleString('th-TH',{hour12:false});
    const reason=String(s.reason||'').slice(0,22);
    return `
      <tr>
        <td>${s.cycleNo}</td>
        <td title="${s.reason}">${reason}</td>
        <td>${s.hands}</td>
        <td class="${cls}">${(s.cycleProfit||0).toFixed(2)}</td>
        <td>${(s.comm||0).toFixed(2)}</td>
        <td>${(s.turnover||0).toFixed(0)}</td>
        <td>${(s.bankrollLeft||0).toFixed(2)}</td>
        <td class="muted">${timeStr}</td>
      </tr>
    `;
  }).join('');
}
function exportSessionHistory(){
  const blob=new Blob([JSON.stringify(cycleHistory,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`cycleHistory_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function clearSessionHistory(){
  if(!confirm("‡∏•‡πâ‡∏≤‡∏á Cycle History ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) return;
  cycleHistory=[];
  renderSessionHistory();
  updateUI();
}

function renderBigRoad(){
  const roadDiv=document.getElementById('road_container');
  roadDiv.innerHTML='';
  let matrix=[], col=0, row=0, last=null;
  const setCell=(c,r,v)=>{ if(!matrix[c]) matrix[c]=[]; matrix[c][r]=v; };
  (state.roadAll || []).forEach(res=>{
    if(last===null){ setCell(col,row,res); last=res; return; }
    if(res===last){
      if(row<5 && (!matrix[col] || matrix[col][row+1]===undefined)) row++;
      else col++;
      setCell(col,row,res);
    }else{
      col++; row=0; setCell(col,row,res); last=res;
    }
  });
  const maxCol=matrix.length;
  const renderCols=Math.max(20,maxCol);
  for(let c=0;c<renderCols;c++){
    for(let r=0;r<6;r++){
      const cell=document.createElement('div');
      cell.className='big-road-cell';
      if(matrix[c] && matrix[c][r]){
        const v=matrix[c][r];
        const circle=document.createElement('div');
        circle.className=`circle circle-${v}`;
        circle.innerText=v;
        cell.appendChild(circle);
      }
      roadDiv.appendChild(cell);
    }
  }
  const wrapper=document.querySelector('.road-scroll-wrapper');
  if(wrapper){
    setTimeout(()=>{
      wrapper.scrollLeft=(maxCol*27)>wrapper.clientWidth ? (maxCol*27)-wrapper.clientWidth+50 : 0;
    },0);
  }
}

function updateChart(){
  const ctx=document.getElementById('profitChart').getContext('2d');
  if(!chartInstance){
    chartInstance=new Chart(ctx,{
      type:'line',
      data:{ labels:state.graphLabels,
        datasets:[{ label:'Equity (Real+Comm)', data:state.graphData,
          borderColor:'#e67e22', backgroundColor:'rgba(230,126,34,0.1)',
          borderWidth:2, fill:true, pointRadius:0, tension:0.1
        }]
      },
      options:{ responsive:true, maintainAspectRatio:false, animation:{duration:0},
        plugins:{ legend:{display:false}},
        scales:{ x:{display:false}, y:{grid:{color:'#f0f0f0'}}}
      }
    });
  }else{
    chartInstance.data.labels=state.graphLabels;
    chartInstance.data.datasets[0].data=state.graphData;
    const eq=getEquity();
    chartInstance.data.datasets[0].borderColor=eq>=0?'#27ae60':'#c0392b';
    chartInstance.data.datasets[0].backgroundColor=eq>=0?'rgba(39,174,96,0.1)':'rgba(192,57,43,0.1)';
    chartInstance.update();
  }
}

function updateLifetimeUI(){
  const elNet=document.getElementById('all_net');
  const elNetComm=document.getElementById('all_net_comm');
  const elDD=document.getElementById('all_max_dd');
  const elMaxBet=document.getElementById('all_max_bet');
  if(elNet){
    elNet.innerText=lifetime.net.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    elNet.style.color=lifetime.net>=0?'var(--success)':'var(--danger)';
  }
  if(elNetComm){
    const eq=lifetimeEquity();
    elNetComm.innerText=eq.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    elNetComm.style.color=eq>=0?'var(--success)':'var(--danger)';
  }
  if(elDD){
    elDD.innerText=lifetime.maxDrawdown.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    elDD.style.color=lifetime.maxDrawdown<=0?'var(--danger)':'var(--text)';
  }
  if(elMaxBet) elMaxBet.innerText=(lifetime.maxBet||0).toLocaleString();
}

function updateUI(){
  const rec = computeRecommendation();
  document.getElementById('rec_amount').innerText = (rec.bet||0).toLocaleString();
  let netSideLabel='WAIT';
  let sideClass='side-n';
  if(rec.side==='P'){ netSideLabel='PLAYER'; sideClass='side-p'; }
  else if(rec.side==='B'){ netSideLabel='BANKER'; sideClass='side-b'; }
  document.getElementById('rec_side').innerText = netSideLabel;
  document.getElementById('rec_side').className = `rec-side ${sideClass}`;
  document.getElementById('formula_disp').innerText = rec.formula;

  document.getElementById('mon_bal').innerText = Math.round(state.staker.bal).toLocaleString();
  document.getElementById('mon_info').innerText = `Wait:${state.staker.wait} | Stg:${state.staker.stage} | CL:${state.staker.cons_loss}`;
  document.getElementById('mon_net').innerText = state.lastNet.side;
  document.getElementById('mon_net_info').innerText = `P:${state.lastNet.p.toFixed(2)} B:${state.lastNet.b.toFixed(2)} (${document.getElementById('net_mode').value})`;

  const cp=getCycleProfit();
  const hwm=getCycleHwm();
  document.getElementById('target_status_display').innerText = `${cp.toFixed(2)} / ${hwm.toFixed(2)}`;
  const targetProfit=parseFloat(document.getElementById('target_profit').value)||0;
  document.getElementById('cycle_profit_disp').innerText = `${cp.toFixed(2)} / ${targetProfit}`;

  const profitElem=document.getElementById('disp_net');
  profitElem.innerText=cp.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  profitElem.style.color=cp>=0?'var(--success)':'var(--danger)';

  const commCycle = state.commTotal - (state.commTotalStart||0);
  const eqCycle = cp + commCycle;
  document.getElementById('disp_net_comm').innerText = eqCycle.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  document.getElementById('disp_comm_total').innerText = commCycle.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});

  document.getElementById('disp_dd').innerText=(state.maxDDEquity||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  document.getElementById('disp_maxbet').innerText=(state.maxBet||0).toLocaleString();
  document.getElementById('disp_hands').innerText=state.history.length.toLocaleString();

  document.getElementById('disp_mode').innerText=document.getElementById('net_mode').value;
  document.getElementById('disp_strength').innerText=(state.lastNet.strength||0).toFixed(2);

  document.getElementById('comm_turnover').innerText = state.commTurnover.toLocaleString(undefined,{maximumFractionDigits:2});
  document.getElementById('comm_total').innerText = commCycle.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  document.getElementById('comm_hands').innerText = state.commHands.toLocaleString();
  document.getElementById('comm_net_plus').innerText = eqCycle.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});

  const left=getBankrollLeft();
  const el=document.getElementById('bankroll_left_disp');
  el.innerText = left.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  el.style.color = left>=getMinBet() ? '#d7f7e6' : '#ffb3b3';

  document.getElementById('cycle_no_disp').innerText = cycleNo.toLocaleString();
  document.getElementById('session_saved_disp').innerText = cycleHistory.length.toLocaleString();

  document.getElementById('sim_round_count').innerText=simRoundCount;
  document.getElementById('sim_success_count').innerText=simSuccessCount;
  document.getElementById('sim_round_count_bot').innerText=simRoundCount;
  document.getElementById('sim_success_count_bot').innerText=simSuccessCount;

  renderBigRoad();
  updateChart();
  renderSessionHistory();
  updateLifetimeUI();
  refreshShoeUI();
}

function syncSimSettings(source){
  if(source==='top'){
    document.getElementById('sim_hands_bot').value=document.getElementById('sim_hands').value;
    document.getElementById('sim_speed_bot').value=document.getElementById('sim_speed').value;
    document.getElementById('rng_method_bot').value=document.getElementById('rng_method').value;
  }else{
    document.getElementById('sim_hands').value=document.getElementById('sim_hands_bot').value;
    document.getElementById('sim_speed').value=document.getElementById('sim_speed_bot').value;
    document.getElementById('rng_method').value=document.getElementById('rng_method_bot').value;
  }
  onRngChange();
}

function generateOutcome(){
  const method=document.getElementById('rng_method').value;
  if(method==='crypto'){
    const array=new Uint32Array(1);
    window.crypto.getRandomValues(array);
    const val=array[0]/(0xFFFFFFFF+1);
    return val<0.4932?'P':'B';
  }
  if(method==='shoe') return dealBaccarat();
  return Math.random()<0.4932?'P':'B';
}

// ‚úÖ DEFAULT = BEST PARAMS (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤)
function restoreRecommended(){
  document.getElementById('rng_method').value='shoe';
  document.getElementById('shoe_pen').value='60';

  document.getElementById('net_mode').value='weight';
  document.getElementById('min_strength').value=0.45;
  document.getElementById('reset_road_on_cycle').value='no';

  document.getElementById('use_offset').checked=true;
  document.getElementById('w_offset').value=2.54;

  document.getElementById('use_anti_last').checked=true;
  document.getElementById('w_anti_last').value=2.46;

  document.getElementById('use_follow_last').checked=true;
  document.getElementById('w_follow_last').value=0.63;

  document.getElementById('use_something_else').checked=true;
  document.getElementById('w_something_else').value=0.37;

  document.getElementById('use_policy_ai').checked=true;
  document.getElementById('w_policy_ai').value=1.06;

  document.getElementById('commission_rate').value='0.9';
  document.getElementById('init_bank').value=514502.0;
  document.getElementById('max_bet_cap').value=51964.0;
  document.getElementById('min_bet').value=5.0;
  document.getElementById('chip_size').value=5.0;

  document.getElementById('target_profit').value=0.01;
  document.getElementById('surv_trigger').value=24.05;
  document.getElementById('surv_div').value=1.61;

  syncSimSettings('top');
  onRngChange();
  updateUI();
}

function resetAll(){ if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) location.reload(); }
function showGuideModal(){ document.getElementById('guideModal').style.display='flex'; }
function closeGuideModal(){ document.getElementById('guideModal').style.display='none'; }

function runSimulation(){
  const n=parseInt(document.getElementById('sim_hands').value)||1;
  saveState();
  for(let i=0;i<n;i++) processResult(generateOutcome(), true);
  updateUI();
}

function toggleAutoSim(){
  if(isAutoRunning) return;
  isAutoRunning=true;
  document.getElementById('btn_auto_sim').style.display='none';
  document.getElementById('btn_auto_sim_bot').style.display='none';
  document.getElementById('btn_stop_sim').style.display='inline-block';
  document.getElementById('btn_stop_sim_bot').style.display='inline-block';
  document.getElementById('sim_stats_display').style.display='block';
  document.getElementById('sim_stats_display_bot').style.display='block';
  if(simRoundCount===0){ simRoundCount=1; simSuccessCount=0; }
  const speed=parseInt(document.getElementById('sim_speed').value);
  if(speed===0) runInstantLoop();
  else autoPlayStep();
}
function stopAutoSim(){
  isAutoRunning=false;
  if(autoTimer) clearTimeout(autoTimer);
  document.getElementById('btn_auto_sim').style.display='inline-block';
  document.getElementById('btn_auto_sim_bot').style.display='inline-block';
  document.getElementById('btn_stop_sim').style.display='none';
  document.getElementById('btn_stop_sim_bot').style.display='none';
}
async function runInstantLoop(){
  while(isAutoRunning){
    processResult(generateOutcome(), true);
    await new Promise(r=>setTimeout(r,0));
  }
}
function autoPlayStep(){
  if(!isAutoRunning) return;
  const speed=parseInt(document.getElementById('sim_speed').value);
  processResult(generateOutcome(), true);
  simRoundCount += 1;
  updateUI();
  autoTimer=setTimeout(autoPlayStep, speed);
}

window.onload=function(){
  restoreRecommended();
  state.equityHigh = getEquity();
  state.maxDDEquity = 0;
  cycleNo = 1;
  cycleStartTs = Date.now();
  state.cycleStartBalance = state.realBalance;
  state.commTotalStart = state.commTotal;
  resetStaker();
  resetDualEngines();
  lifetime.highWater = lifetimeEquity();
  lifetime.maxDrawdown = 0;
  onRngChange();
  renderSessionHistory();
  updateUI();
};
</script>
</body>
</html>
