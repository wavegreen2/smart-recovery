<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Recovery Simulator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .log-container { height: 300px; overflow-y: auto; background: #212529; color: #00ff00; font-family: monospace; padding: 10px; font-size: 12px; }
        .stat-card { text-align: center; padding: 15px; border-radius: 10px; color: white; }
    </style>
</head>
<body>

<div class="container py-5">
    <h2 class="text-center mb-4">üé∞ Smart Recovery Simulation</h2>
    
    <div class="row g-4">
        <div class="col-md-4">
            <div class="card p-4">
                <h5 class="mb-3">Settings</h5>
                <div class="mb-2">
                    <label class="form-label">Max Sessions</label>
                    <input type="number" id="max_sessions" class="form-control" value="100">
                </div>
                <div class="mb-2">
                    <label class="form-label">Virtual Loss Trigger</label>
                    <input type="number" id="virtual_trigger" class="form-control" value="2">
                </div>
                <div class="mb-2">
                    <label class="form-label">Unit Size</label>
                    <input type="number" id="unit_size" class="form-control" value="10">
                </div>
                <div class="mb-2">
                    <label class="form-label">Marty Mult</label>
                    <input type="number" id="marty_mult" class="form-control" value="2">
                </div>
                <button onclick="startSimulation()" class="btn btn-primary w-100 mt-3" id="runBtn">Start Simulation</button>
            </div>
        </div>

        <div class="col-md-8">
            <div class="row g-3 mb-4">
                <div class="col-4">
                    <div class="stat-card bg-dark">
                        <small>Total Sessions</small>
                        <h4 id="stat_total">0</h4>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-card bg-danger">
                        <small>Max Consecutive Busts</small>
                        <h4 id="stat_busts">0</h4>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-card bg-success">
                        <small>Max Bet</small>
                        <h4 id="stat_max_bet">0</h4>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Live Simulation Log</div>
                <div id="log" class="log-container">
                    Waiting for start...
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// --- Logic Core (‡∏î‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≤‡∏Å Python) ---

function getFibo(n) {
    if (n <= 0) return 1;
    if (n === 1) return 1;
    let a = 1, b = 1;
    for (let i = 2; i <= n; i++) {
        let temp = a + b;
        a = b;
        b = temp;
    }
    return b;
}

function runSingleSession(params) {
    let bankroll = params.initial_bankroll;
    let peak_bankroll = bankroll;
    let max_bet = 0;
    let max_drawdown = 0;
    let total_rebate = 0;
    
    let state = "FLAT";
    let marty_step = 0;
    let fibo_idx = 0;
    let marty_limit = 12;
    let has_lost_since_peak = false;

    for (let r = 1; r <= 1000; r++) { // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏≠‡∏ö‡∏ï‡πà‡∏≠ session ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á
        let current_drawdown = peak_bankroll - bankroll;
        
        let bet = params.unit_size;
        if (state === "FLAT") {
            bet = (current_drawdown > 0 && has_lost_since_peak) ? Math.ceil(current_drawdown / 4) : params.unit_size;
        } else if (state === "MARTY") {
            bet = params.unit_size * Math.pow(params.marty_mult, marty_step);
        } else if (state === "FIBO") {
            bet = getFibo(fibo_idx) * 100; // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏Ñ‡πà‡∏≤ fibo_mult
        }

        // Apply Constraints
        let needed = current_drawdown + params.unit_size;
        if (state !== "FLAT") bet = Math.min(bet, needed);
        if (bet > params.stop_loss) bet = params.stop_loss;

        max_bet = Math.max(max_bet, bet);
        bankroll += (bet * 0.01); // Rebate

        let win_prob = 0.4932; // Player side
        let is_win = Math.random() < win_prob;

        if (is_win) {
            bankroll += bet;
            if (state === "FIBO") {
                fibo_idx = Math.max(-1, fibo_idx - 2);
                if (fibo_idx < 0) { state = "FLAT"; fibo_idx = 0; }
            } else {
                state = "FLAT"; marty_step = 0;
            }
        } else {
            bankroll -= bet;
            has_lost_since_peak = true;
            if (state === "FLAT") { state = "MARTY"; marty_step = 1; }
            else if (state === "MARTY") {
                marty_step++;
                if (marty_step > marty_limit) { state = "FIBO"; fibo_idx = 0; }
            } else { fibo_idx++; }
        }

        peak_bankroll = Math.max(peak_bankroll, bankroll);
        max_drawdown = Math.max(max_drawdown, peak_bankroll - bankroll);

        if (bankroll <= 0) return { status: "BUST", profit: bankroll - params.initial_bankroll, max_bet, max_drawdown };
        if ((bankroll - params.initial_bankroll) >= params.target) return { status: "WIN", profit: bankroll - params.initial_bankroll, max_bet, max_drawdown };
    }
    return { status: "TIMEOUT", profit: bankroll - params.initial_bankroll, max_bet, max_drawdown };
}

async function startSimulation() {
    const logEl = document.getElementById('log');
    const runBtn = document.getElementById('runBtn');
    logEl.innerHTML = "Starting Simulation...<br>";
    runBtn.disabled = true;

    // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
    let config = {
        max_sessions: parseInt(document.getElementById('max_sessions').value),
        virtual_trigger: parseInt(document.getElementById('virtual_trigger').value),
        unit_size: parseFloat(document.getElementById('unit_size').value),
        marty_mult: parseFloat(document.getElementById('marty_mult').value),
        stop_loss: 100000,
        initial_bankroll: 20.0,
        target: 0.01
    };

    let total_real = 0;
    let accumulated_loss = 0;
    let max_consecutive_busts = 0;
    let current_consecutive_busts = 0;
    let virtual_losses = 0;
    let overall_max_bet = 0;

    for (let i = 1; i <= config.max_sessions; i++) {
        let is_virtual = virtual_losses < config.virtual_trigger;
        
        let session_target = is_virtual ? config.target : (accumulated_loss + config.target);
        let session_br = is_virtual ? config.initial_bankroll : (session_target * 1.25);

        let res = run_single_session_internal(session_target, session_br, config);

        if (is_virtual) {
            if (res.status !== "WIN") {
                virtual_losses++;
                logEl.innerHTML += `<span style="color:gray">[VIRTUAL] Session ${i}: LOSS (Count: ${virtual_losses})</span><br>`;
            } else {
                virtual_losses = 0;
                logEl.innerHTML += `<span style="color:gray">[VIRTUAL] Session ${i}: WIN (Reset)</span><br>`;
            }
        } else {
            total_real++;
            overall_max_bet = Math.max(overall_max_bet, res.max_bet);
            
            if (res.status === "WIN") {
                logEl.innerHTML += `<span style="color:#00ff00">[REAL] Session ${total_real}: WIN (+${res.profit.toFixed(2)})</span><br>`;
                accumulated_loss = 0;
                virtual_losses = 0;
                current_consecutive_busts = 0;
            } else {
                logEl.innerHTML += `<span style="color:#ff4444">[REAL] Session ${total_real}: ${res.status} (-${res.profit.toFixed(2)})</span><br>`;
                accumulated_loss += Math.abs(res.profit);
                current_consecutive_busts++;
                max_consecutive_busts = Math.max(max_consecutive_busts, current_consecutive_busts);
            }
        }
        
        // Update Stats UI
        document.getElementById('stat_total').innerText = total_real;
        document.getElementById('stat_busts').innerText = max_consecutive_busts;
        document.getElementById('stat_max_bet').innerText = overall_max_bet.toLocaleString();
        
        logEl.scrollTop = logEl.scrollHeight;
        if (i % 10 === 0) await new Promise(r => setTimeout(r, 10)); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á
    }
    
    runBtn.disabled = false;
    logEl.innerHTML += "--- SIMULATION END ---<br>";
}

// Wrapper ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå
function run_single_session_internal(target, br, config) {
    return runSingleSession({
        ...config,
        target: target,
        initial_bankroll: br
    });
}
</script>

</body>
</html>
