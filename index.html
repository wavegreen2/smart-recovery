<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baccarat Recovery System</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --win: #27ae60;
            --loss: #e74c3c;
            --bg: #f4f7f6;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: var(--primary); }
        
        /* Layout Sections */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
        
        /* Stats Styling */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; text-align: center; }
        .stat-box { background: #eee; padding: 10px; border-radius: 5px; }
        .stat-val { display: block; font-size: 1.2em; font-weight: bold; color: var(--accent); }

        /* Controls */
        input, select, textarea { width: 100%; padding: 8px; margin: 5px 0 15px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-start { background: var(--win); color: white; }
        .btn-manual { background: var(--accent); color: white; }
        .btn-p { background: #3498db; color: white; }
        .btn-b { background: #e67e22; color: white; }
        .btn-t { background: #95a5a6; color: white; }
        
        /* Logs */
        #log-container { height: 250px; overflow-y: scroll; background: #222; color: #0f0; padding: 10px; font-family: monospace; border-radius: 5px; margin-top: 20px; font-size: 0.85em; }
        .log-win { color: #2ecc71; }
        .log-loss { color: #e74c3c; }
        .log-info { color: #f1c40f; }
    </style>
</head>
<body>

<div class="container">
    <h2>üé∞ Baccarat Strategy Simulator</h2>

    <div class="grid">
        <div class="card">
            <h3>‚öôÔ∏è Settings</h3>
            <label>Mode:</label>
            <select id="mode" onchange="toggleInputs()">
                <option value="r">Random Simulation</option>
                <option value="m">Manual (Hand by Hand)</option>
                <option value="a">Auto (Data Set)</option>
            </select>

            <label>Unit Size:</label>
            <input type="number" id="unit_size" value="10">
            
            <label>Side Preference:</label>
            <select id="side_pref">
                <option value="PLAYER">PLAYER</option>
                <option value="BANKER">BANKER</option>
            </select>

            <label>Virtual Loss Wait:</label>
            <input type="number" id="v_loss" value="2">
        </div>

        <div class="card">
            <h3>üìä Dashboard</h3>
            <div class="stats-grid">
                <div class="stat-box">Bankroll<span class="stat-val" id="stat-br">20.00</span></div>
                <div class="stat-box">Profit<span class="stat-val" id="stat-profit">0.00</span></div>
                <div class="stat-box">Next Bet<span class="stat-val" id="stat-bet">0.00</span></div>
                <div class="stat-box">Max Bet<span class="stat-val" id="stat-maxbet">0.00</span></div>
            </div>
            <div id="manual-controls" style="display:none; margin-top:20px; border-top: 1px solid #ddd; padding-top:15px;">
                <p style="text-align:center; margin-bottom:10px;"><b>ENTER RESULT:</b></p>
                <div class="btn-group">
                    <button class="btn-p" onclick="processManual('P')">P</button>
                    <button class="btn-b" onclick="processManual('B')">B</button>
                    <button class="btn-t" onclick="processManual('T')">T</button>
                </div>
            </div>
        </div>
    </div>

    <div id="auto-data-input" style="display:none;">
        <label>Auto Data (CSV format):</label>
        <textarea id="raw_data" rows="3">P,B,B,P,P,B,P,P,P,B</textarea>
    </div>

    <button class="btn-start" id="start-btn" onclick="startApp()">üöÄ START SIMULATION</button>

    <div id="log-container">
        <div class="log-info">System ready. Click START...</div>
    </div>
</div>

<script>
    // --- Logic Variables ---
    let config = {};
    let session = {
        bankroll: 0,
        peakBankroll: 0,
        initialBankroll: 20,
        targetProfit: 0.01,
        currentDrawdown: 0,
        state: "FLAT",
        martyStep: 0,
        fiboIdx: 0,
        totalLossAccumulated: 0,
        totalRealSessions: 0,
        consecutiveVirtualLosses: 0,
        isVirtual: true,
        maxBetEncoutered: 0
    };

    function getFibo(n) {
        if (n <= 0) return 1;
        if (n === 1) return 1;
        let a = 1, b = 1;
        for (let i = 2; i <= n; i++) {
            let temp = a + b;
            a = b;
            b = temp;
        }
        return b;
    }

    function toggleInputs() {
        const mode = document.getElementById('mode').value;
        document.getElementById('manual-controls').style.display = (mode === 'm') ? 'block' : 'none';
        document.getElementById('auto-data-input').style.display = (mode === 'a') ? 'block' : 'none';
        document.getElementById('start-btn').style.display = (mode === 'm') ? 'none' : 'block';
        if(mode === 'm') initSession();
    }

    function addLog(msg, className = "") {
        const log = document.getElementById('log-container');
        const div = document.createElement('div');
        div.className = className;
        div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
        log.prepend(div);
    }

    function updateUI(currentBet = 0) {
        document.getElementById('stat-br').innerText = session.bankroll.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('stat-profit').innerText = (session.bankroll - 20).toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('stat-bet').innerText = currentBet.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('stat-maxbet').innerText = session.maxBetEncoutered.toLocaleString(undefined, {minimumFractionDigits: 2});
    }

    function initSession() {
        config = {
            unitSize: parseFloat(document.getElementById('unit_size').value),
            sidePref: document.getElementById('side_pref').value,
            vLossTrigger: parseInt(document.getElementById('v_loss').value),
            rebateRate: 0.01,
            martyMult: 2,
            fiboMult: 1000000000 // Example
        };
        
        session.bankroll = 20;
        session.initialBankroll = 20;
        session.targetProfit = 0.01;
        session.isVirtual = session.consecutiveVirtualLosses < config.vLossTrigger;
        calculateNextBet();
    }

    function calculateNextBet() {
        let drawDown = session.peakBankroll - session.bankroll;
        let bet = 0;

        if (session.state === "FLAT") {
            bet = config.unitSize;
        } else if (session.state === "MARTY") {
            bet = config.unitSize * Math.pow(config.martyMult, session.martyStep);
        } else if (session.state === "FIBO") {
            bet = getFibo(session.fiboIdx) * config.fiboMult;
        }

        // Recovery Logic
        let needed = drawDown + config.unitSize;
        if (session.state !== "FLAT") bet = Math.min(bet, needed);
        
        if (bet > session.maxBetEncoutered) session.maxBetEncoutered = bet;
        updateUI(bet);
        return bet;
    }

    function processManual(result) {
        if (result === 'T') {
            addLog("TIE - Skip");
            return;
        }

        let currentBet = calculateNextBet();
        let isWin = (result === config.sidePref);
        let payout = (config.sidePref === "BANKER") ? 0.95 : 1.0;
        
        // Rebate
        session.bankroll += (currentBet * config.rebateRate);

        if (isWin) {
            session.bankroll += (currentBet * payout);
            addLog(`‚úÖ WIN: +${(currentBet * payout).toFixed(2)} | Bet: ${currentBet.toFixed(2)}`, "log-win");
            
            if (session.state === "FIBO") {
                session.fiboIdx = Math.max(-1, session.fiboIdx - 2);
                if (session.fiboIdx < 0) { session.state = "FLAT"; session.fiboIdx = 0; }
            } else {
                session.state = "FLAT";
                session.martyStep = 0;
            }
        } else {
            session.bankroll -= currentBet;
            addLog(`‚ùå LOSS: -${currentBet.toFixed(2)} | Bet: ${currentBet.toFixed(2)}`, "log-loss");
            
            if (session.state === "FLAT") {
                session.state = "MARTY";
                session.martyStep = 1;
            } else if (session.state === "MARTY") {
                session.martyStep++;
                if (session.martyStep > 12) { session.state = "FIBO"; session.fiboIdx = 0; }
            } else {
                session.fiboIdx++;
            }
        }

        if (session.bankroll > session.peakBankroll) session.peakBankroll = session.bankroll;

        // Session Status Check
        let currentProfit = session.bankroll - session.initialBankroll;
        if (currentProfit >= session.targetProfit) {
            addLog("üèÅ TARGET REACHED! Resetting...", "log-info");
            handleSessionEnd("WIN");
        } else if (session.bankroll <= 0) {
            addLog("üíÄ BUSTED!", "log-loss");
            handleSessionEnd("BUST");
        }
        
        calculateNextBet();
    }

    function handleSessionEnd(status) {
        if (session.isVirtual) {
            if (status === "BUST") session.consecutiveVirtualLosses++;
            else session.consecutiveVirtualLosses = 0;
        } else {
            // Real session logic
            if (status === "WIN") {
                session.totalLossAccumulated = 0;
                session.initialBankroll = 20;
                session.targetProfit = 0.01;
                session.consecutiveVirtualLosses = 0;
            } else {
                session.totalLossAccumulated += Math.abs(session.bankroll - session.initialBankroll);
                session.targetProfit = session.totalLossAccumulated + 0.01;
                session.initialBankroll = session.targetProfit * 1.5;
            }
        }
        
        session.bankroll = session.initialBankroll;
        session.peakBankroll = session.bankroll;
        session.state = "FLAT";
        session.martyStep = 0;
        session.fiboIdx = 0;
        session.isVirtual = session.consecutiveVirtualLosses < config.vLossTrigger;
        
        addLog(`--- Next Session: ${session.isVirtual ? 'VIRTUAL' : 'REAL'} ---`, "log-info");
    }

    async function startApp() {
        initSession();
        const mode = document.getElementById('mode').value;
        if (mode === 'r') {
            addLog("Starting Random Simulation 100 rounds...");
            for(let i=0; i<100; i++) {
                let res = (Math.random() <= 0.5068) ? "B" : "P";
                processManual(res);
                await new Promise(r => setTimeout(r, 50)); // Animation delay
            }
        } else if (mode === 'a') {
            const data = document.getElementById('raw_data').value.split(',');
            for(let res of data) {
                processManual(res.trim().toUpperCase());
            }
        }
    }
</script>

</body>
</html>
