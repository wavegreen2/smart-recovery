<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Baccarat Recovery Simulation</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .controls label { display: block; margin-top: 10px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
        button { cursor: pointer; padding: 10px 20px; border: none; border-radius: 5px; color: white; margin-top: 10px; }
        .btn-run { background: #28a745; width: 100%; font-size: 1.1em; }
        .btn-manual { background: #007bff; margin-right: 5px; width: 60px; }
        .btn-reset { background: #dc3545; }
        #log { background: #1e1e1e; color: #adff2f; padding: 15px; height: 300px; overflow-y: scroll; font-family: monospace; border-radius: 5px; margin-top: 10px; }
        .summary-box { background: #e9ecef; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .status-win { color: #28a745; font-weight: bold; }
        .status-loss { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>üìä Baccarat Strategy Simulator</h2>
    
    <div class="grid">
        <div class="card">
            <h3>‚öôÔ∏è Configuration</h3>
            <label>Mode</label>
            <select id="mode">
                <option value="r">Random Simulation (Auto)</option>
                <option value="m">Manual Input (Hand-by-Hand)</option>
            </select>

            <label>Side Preference</label>
            <select id="side_preference">
                <option value="PLAYER">PLAYER</option>
                <option value="BANKER">BANKER</option>
            </select>

            <label>Unit Size</label>
            <input type="number" id="unit_size" value="10">

            <label>Virtual Loss Trigger (Wait X times)</label>
            <input type="number" id="virtual_loss_trigger" value="2">

            <label>Max Real Sessions</label>
            <input type="number" id="max_sessions" value="10">
        </div>

        <div class="card">
            <h3>üìà Strategy Parameters</h3>
            <label>Marty Multiplier (default 2)</label>
            <input type="number" id="marty_mult" value="2">

            <label>Stop Loss Threshold</label>
            <input type="number" id="stop_loss" value="5000">

            <label>Initial Bankroll (Base)</label>
            <input type="number" id="base_bankroll" value="20">

            <label>Rebate Rate (%)</label>
            <input type="number" id="rebate_rate" value="1" step="0.1">
        </div>
    </div>

    <button class="btn-run" onclick="startSimulation()">üöÄ Start / Reset Simulation</button>

    <div id="manual_controls" class="card" style="display:none; margin-top:20px; text-align:center;">
        <h3>üÉè Input Result for Hand <span id="current_hand_num">1</span></h3>
        <button class="btn-manual" onclick="processManual('P')">P</button>
        <button class="btn-manual" onclick="processManual('B')">B</button>
        <button class="btn-manual" onclick="processManual('T')">T</button>
    </div>

    <div class="summary-box">
        <div class="grid">
            <div>
                <strong>Current State:</strong> <span id="stat_state">-</span><br>
                <strong>Current Bet:</strong> <span id="stat_bet">0</span><br>
                <strong>Bankroll:</strong> <span id="stat_br">0</span>
            </div>
            <div>
                <strong>Session:</strong> <span id="stat_session">0</span><br>
                <strong>Max Bet Encountered:</strong> <span id="stat_max_bet">0</span><br>
                <strong>Total Profit:</strong> <span id="stat_profit">0</span>
            </div>
        </div>
    </div>

    <div id="log">--- Logs will appear here ---</div>
</div>

<script>
    // Global Variables
    let config = {};
    let session_data = {
        bankroll: 0, peak_bankroll: 0, state: "FLAT", marty_step: 0, fibo_idx: 0,
        current_idx: 0, total_real_sessions: 0, total_loss_accumulated: 0,
        current_target: 0, is_virtual: true, consecutive_virtual_losses: 0,
        overall_max_bet: 0, overall_max_drawdown: 0, initial_br_of_session: 0,
        has_lost_since_peak: false
    };

    function getFibo(n) {
        if (n <= 0) return 1;
        if (n === 1) return 1;
        let a = 1, b = 1;
        for (let i = 2; i <= n; i++) {
            let temp = a + b;
            a = b;
            b = temp;
        }
        return b;
    }

    function addLog(msg, color = "#adff2f") {
        const logDiv = document.getElementById('log');
        logDiv.innerHTML += `<div style="color:${color}">${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateUI() {
        document.getElementById('stat_state').innerText = session_data.state;
        document.getElementById('stat_br').innerText = session_data.bankroll.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('stat_session').innerText = session_data.total_real_sessions;
        document.getElementById('stat_max_bet').innerText = session_data.overall_max_bet.toLocaleString();
        document.getElementById('stat_profit').innerText = (session_data.bankroll - config.base_bankroll).toFixed(2);
        document.getElementById('current_hand_num').innerText = session_data.current_idx + 1;
    }

    function startSimulation() {
        // Init Settings
        config = {
            mode: document.getElementById('mode').value,
            side_preference: document.getElementById('side_preference').value,
            unit_size: parseFloat(document.getElementById('unit_size').value),
            virtual_loss_trigger: parseInt(document.getElementById('virtual_loss_trigger').value),
            max_sessions: parseInt(document.getElementById('max_sessions').value),
            marty_mult: parseFloat(document.getElementById('marty_mult').value),
            stop_loss: parseFloat(document.getElementById('stop_loss').value),
            base_bankroll: parseFloat(document.getElementById('base_bankroll').value),
            rebate_rate: parseFloat(document.getElementById('rebate_rate').value) / 100,
            base_target: 0.01
        };

        // Reset Data
        session_data = {
            bankroll: config.base_bankroll, peak_bankroll: config.base_bankroll,
            state: "FLAT", marty_step: 0, fibo_idx: 0, current_idx: 0,
            total_real_sessions: 0, total_loss_accumulated: 0,
            current_target: config.base_target, is_virtual: config.virtual_loss_trigger > 0,
            consecutive_virtual_losses: 0, overall_max_bet: 0, overall_max_drawdown: 0,
            initial_br_of_session: config.base_bankroll, has_lost_since_peak: false
        };

        document.getElementById('log').innerHTML = "--- Simulation Started ---";
        document.getElementById('manual_controls').style.display = config.mode === 'm' ? 'block' : 'none';
        
        if (config.mode === 'r') {
            runAutoRandom();
        } else {
            addLog("Waiting for manual input...", "#007bff");
            updateUI();
        }
    }

    function calculateBet() {
        let drawDown = session_data.peak_bankroll - session_data.bankroll;
        let rawBet = config.unit_size;

        if (session_data.state === "FLAT") {
            if (drawDown > 0 && session_data.has_lost_since_peak) {
                rawBet = Math.max(Math.ceil(drawDown / 4), config.unit_size);
            }
        } else if (session_data.state === "MARTY") {
            rawBet = config.unit_size * Math.pow(config.marty_mult, session_data.marty_step);
        } else if (session_data.state === "FIBO") {
            rawBet = getFibo(session_data.fibo_idx) * config.unit_size; // ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì Fibo ‡πÉ‡∏´‡πâ‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö Unit
        }

        // Limit Bet
        let neededToRecover = drawDown + config.unit_size;
        let bet = (session_data.state !== "FLAT") ? Math.min(rawBet, neededToRecover) : rawBet;

        if (bet >= config.stop_loss) {
            bet = config.stop_loss;
        }

        // Target Control
        let current_session_profit = session_data.bankroll - session_data.initial_br_of_session;
        let remaining = session_data.current_target - current_session_profit;
        if (bet > remaining && remaining > 0) {
            bet = Math.max(config.unit_size, remaining);
        }

        return bet;
    }

    function processResult(actualResult) {
        if (actualResult === 'T') {
            addLog(`Hand ${session_data.current_idx + 1}: TIE - Skip`);
            session_data.current_idx++;
            return;
        }

        let bet = calculateBet();
        if (bet > session_data.overall_max_bet) session_data.overall_max_bet = bet;

        let isWin = (actualResult === 'P' && config.side_preference === 'PLAYER') ||
                    (actualResult === 'B' && config.side_preference === 'BANKER');

        let payout = (config.side_preference === 'BANKER') ? 0.95 : 1.0;
        let rebate = bet * config.rebate_rate;
        session_data.bankroll += rebate;

        if (isWin) {
            session_data.bankroll += (bet * payout);
            addLog(`[H:${session_data.current_idx + 1}] Bet: ${bet.toFixed(2)} (${actualResult}) | ‚úÖ WIN | BR: ${session_data.bankroll.toFixed(2)}`, "#28a745");
            
            if (session_data.state === "FIBO") {
                session_data.fibo_idx = Math.max(-1, session_data.fibo_idx - 2);
                if (session_data.fibo_idx < 0) {
                    session_data.state = "FLAT";
                    session_data.fibo_idx = 0;
                }
            } else {
                if (session_data.bankroll >= session_data.peak_bankroll) session_data.has_lost_since_peak = false;
                session_data.state = "FLAT";
                session_data.marty_step = 0;
            }
        } else {
            session_data.bankroll -= bet;
            session_data.has_lost_since_peak = true;
            addLog(`[H:${session_data.current_idx + 1}] Bet: ${bet.toFixed(2)} (${actualResult}) | ‚ùå LOSS | BR: ${session_data.bankroll.toFixed(2)}`, "#dc3545");

            if (bet >= config.stop_loss) {
                session_data.state = "FLAT";
                session_data.marty_step = 0;
            } else {
                if (session_data.state === "FLAT") {
                    session_data.state = "MARTY";
                    session_data.marty_step = 1;
                } else if (session_data.state === "MARTY") {
                    session_data.marty_step++;
                    if (session_data.marty_step > 12) {
                        session_data.state = "FIBO";
                        session_data.fibo_idx = 0;
                    }
                } else if (session_data.state === "FIBO") {
                    session_data.fibo_idx++;
                }
            }
        }

        if (session_data.bankroll > session_data.peak_bankroll) session_data.peak_bankroll = session_data.bankroll;
        session_data.current_idx++;

        // Session Status Check
        let sessionProfit = session_data.bankroll - session_data.initial_br_of_session;
        
        if (session_data.bankroll <= 0 || sessionProfit >= session_data.current_target) {
            finalizeSession(sessionProfit >= session_data.current_target ? "WIN" : "BUST");
        }
    }

    function finalizeSession(status) {
        if (session_data.is_virtual) {
            if (status === "BUST") {
                session_data.consecutive_virtual_losses++;
                addLog(`üìâ VIRTUAL BUST (${session_data.consecutive_virtual_losses}/${config.virtual_loss_trigger})`, "#ffc107");
            } else {
                session_data.consecutive_virtual_losses = 0;
                addLog(`üîÑ VIRTUAL WIN (Resetting)`, "#ffc107");
            }

            if (session_data.consecutive_virtual_losses >= config.virtual_loss_trigger) {
                session_data.is_virtual = false;
                addLog(`üí∞ ENTERING REAL SESSION ${session_data.total_real_sessions + 1}`, "#ffffff");
            }
        } else {
            session_data.total_real_sessions++;
            if (status === "WIN") {
                addLog(`‚úÖ REAL SESSION WIN! Profit Reset.`, "#00ff00");
                session_data.total_loss_accumulated = 0;
                session_data.current_target = config.base_target;
                session_data.initial_br_of_session = config.base_bankroll;
                session_data.bankroll = config.base_bankroll;
                session_data.is_virtual = config.virtual_loss_trigger > 0;
                session_data.consecutive_virtual_losses = 0;
            } else {
                let lost = Math.abs(session_data.bankroll - session_data.initial_br_of_session);
                session_data.total_loss_accumulated += lost;
                addLog(`‚ùå REAL SESSION BUST! Accumulated Loss: ${session_data.total_loss_accumulated.toFixed(2)}`, "#ff4d4d");
                
                session_data.current_target = session_data.total_loss_accumulated + config.base_target;
                session_data.bankroll = session_data.current_target * 1.5;
                session_data.initial_br_of_session = session_data.bankroll;
            }
        }

        // Stop Condition
        if (session_data.total_real_sessions >= config.max_sessions) {
            addLog("üèÅ MAX SESSIONS REACHED.", "cyan");
            document.getElementById('manual_controls').style.display = 'none';
        }
    }

    function processManual(res) {
        processResult(res);
        updateUI();
    }

    async function runAutoRandom() {
        for (let i = 0; i < 10000; i++) {
            if (session_data.total_real_sessions >= config.max_sessions) break;
            
            let res = Math.random() < 0.5068 ? "B" : "P";
            processResult(res);
            updateUI();
            
            if (i % 50 === 0) await new Promise(r => setTimeout(r, 1)); // Non-blocking UI
        }
    }
</script>

</body>
</html>
