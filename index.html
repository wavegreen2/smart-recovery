<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baccarat Recovery System Sim</title>
    <style>
        :root { --primary: #2c3e50; --secondary: #34495e; --accent: #e74c3c; --success: #27ae60; --text: #ecf0f1; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: var(--secondary); padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: var(--primary); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 0.9em; color: #bdc3c7; }
        input, select { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: none; background: #455a64; color: white; }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-run { background: var(--success); color: white; }
        .btn-input { background: #3498db; color: white; }
        .btn-stop { background: var(--accent); color: white; }
        #log-area { height: 300px; overflow-y: auto; background: #000; padding: 10px; font-family: monospace; font-size: 12px; border-radius: 5px; border: 1px solid #444; }
        .status-win { color: #2ecc71; }
        .status-loss { color: #e74c3c; }
        .status-tie { color: #f1c40f; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; text-align: center; }
        .summary-item { background: #16a085; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üé∞ Baccarat Strategy Simulator</h2>
    
    <div class="grid">
        <div class="card">
            <h3>‚öôÔ∏è Settings</h3>
            <div class="grid" style="grid-template-columns: 1fr 1fr;">
                <div>
                    <label>Base Bankroll</label>
                    <input type="number" id="base_bankroll" value="2000">
                    <label>Unit Size</label>
                    <input type="number" id="unit_size" value="10">
                    <label>Side</label>
                    <select id="side_preference">
                        <option value="PLAYER">PLAYER</option>
                        <option value="BANKER">BANKER</option>
                    </select>
                </div>
                <div>
                    <label>Virtual Loss Trigger</label>
                    <input type="number" id="v_trigger" value="2">
                    <label>Marty Multiplier</label>
                    <input type="number" id="marty_mult" value="2">
                    <label>Stop Loss (Total)</label>
                    <input type="number" id="stop_loss" value="50000">
                </div>
            </div>
            <label>Mode</label>
            <select id="sim_mode" onchange="toggleManualInput()">
                <option value="r">Random Simulation (10M rounds)</option>
                <option value="m">Manual Input (Hand by Hand)</option>
            </select>
        </div>

        <div class="card">
            <h3>üìä Live Summary</h3>
            <div class="summary-grid">
                <div class="summary-item">Sessions<br><span id="stat_sessions">0</span></div>
                <div class="summary-item">Max Bet<br><span id="stat_max_bet">0</span></div>
                <div class="summary-item">Max DD<br><span id="stat_max_mdd">0</span></div>
                <div class="summary-item">Max Busts<br><span id="stat_max_busts">0</span></div>
            </div>
            <div id="manual_controls" style="display:none; margin-top:20px;">
                <label>Input Result:</label>
                <div class="btn-group">
                    <button class="btn-input" onclick="processManual('P')">Player (P)</button>
                    <button class="btn-input" onclick="processManual('B')">Banker (B)</button>
                    <button class="btn-input" onclick="processManual('T')">Tie (T)</button>
                </div>
            </div>
            <div class="btn-group">
                <button id="start_btn" class="btn-run" onclick="startSim()">Start Simulation</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>üìù Execution Logs</h3>
        <div id="log-area"></div>
    </div>
</div>

<script>
    // --- Global State ---
    let config = {};
    let sessionState = {
        totalRealSessions: 0,
        maxConsecutiveBusts: 0,
        currentConsecutiveBusts: 0,
        overallMaxBet: 0,
        overallMaxDrawdown: 0,
        totalLossAccumulated: 0,
        consecutiveVirtualLosses: 0,
        currentDataIdx: 0,
        currentBankroll: 0,
        currentTarget: 0
    };

    // --- Utility Functions ---
    const getFibo = (n) => {
        if (n <= 0) return 1;
        let a = 1, b = 1;
        for (let i = 2; i <= n; i++) {
            [a, b] = [b, a + b];
        }
        return b;
    };

    const addLog = (msg, className = "") => {
        const log = document.getElementById('log-area');
        const div = document.createElement('div');
        div.className = className;
        div.innerText = msg;
        log.prepend(div);
    };

    function toggleManualInput() {
        const mode = document.getElementById('sim_mode').value;
        document.getElementById('manual_controls').style.display = (mode === 'm') ? 'block' : 'none';
        document.getElementById('start_btn').style.display = (mode === 'm') ? 'none' : 'block';
    }

    // --- Core Logic ---
    let activeSession = null;

    async function startSim() {
        // Reset Stats
        sessionState = { ...sessionState, totalRealSessions: 0, totalLossAccumulated: 0, currentConsecutiveBusts: 0 };
        updateStats();
        
        config = {
            baseBankroll: parseFloat(document.getElementById('base_bankroll').value),
            unitSize: parseFloat(document.getElementById('unit_size').value),
            side: document.getElementById('side_preference').value,
            vTrigger: parseInt(document.getElementById('v_trigger').value),
            martyMult: parseFloat(document.getElementById('marty_mult').value),
            stopLoss: parseFloat(document.getElementById('stop_loss').value),
            mode: document.getElementById('sim_mode').value
        };

        if(config.mode === 'r') {
            addLog("üöÄ Starting Random Simulation (Max 10 Real Sessions)...", "status-win");
            runAutoLoop();
        }
    }

    async function runAutoLoop() {
        while(sessionState.totalRealSessions < 10) {
            const isVirtual = sessionState.consecutiveVirtualLosses < config.vTrigger;
            const result = await runSingleSession(isVirtual);
            
            if(result.status === "OUT_OF_DATA") break;
            
            if(!isVirtual) {
                sessionState.totalRealSessions++;
                handleSessionResult(result);
            } else {
                if(result.status === "BUST") sessionState.consecutiveVirtualLosses++;
                else if(result.status === "WIN") sessionState.consecutiveVirtualLosses = 0;
            }
            updateStats();
            await new Promise(r => setTimeout(r, 100)); // Delay to prevent browser freeze
        }
        addLog("üèÅ Simulation Finished.");
    }

    async function runSingleSession(isVirtual) {
        let bankroll = isVirtual ? config.baseBankroll : (sessionState.totalLossAccumulated + config.unitSize) * 1.5;
        let initialBr = bankroll;
        let target = isVirtual ? 0.01 : (sessionState.totalLossAccumulated + config.unitSize);
        let peakBr = bankroll;
        let state = "FLAT";
        let martyStep = 0;
        let fiboIdx = 0;
        let handCount = 0;

        addLog(`--- ${isVirtual ? 'üß™ VIRTUAL' : 'üí∞ REAL'} SESSION START (Target: ${target.toFixed(2)}) ---`);

        while (handCount < 10000000) {
            let currentDD = peakBr - bankroll;
            let rawBet = 0;

            // Strategy Selector
            if (state === "FLAT") {
                rawBet = (currentDD > 0) ? Math.max(Math.ceil(currentDD / 4), config.unitSize) : config.unitSize;
            } else if (state === "MARTY") {
                rawBet = config.unitSize * Math.pow(config.martyMult, martyStep);
            } else if (state === "FIBO") {
                rawBet = getFibo(fiboIdx) * (config.unitSize * 10); // Scale Fibo
            }

            let bet = (state !== "FLAT") ? Math.min(rawBet, currentDD + config.unitSize) : rawBet;
            if (bet >= config.stopLoss) bet = config.stopLoss;

            // Get Result (Random or Manual)
            let actualResult = (Math.random() * 100 <= 50.68) ? "B" : "P";
            handCount++;

            if (actualResult === "T") continue;

            let isWin = (actualResult === config.side);
            let payout = (actualResult === "B" && config.side === "BANKER") ? 0.95 : 1.0;
            
            bankroll += (bet * 0.01); // Rebate

            if (isWin) {
                bankroll += (bet * payout);
                if (state === "FIBO") {
                    fiboIdx = Math.max(-1, fiboIdx - 2);
                    if (fiboIdx < 0) { state = "FLAT"; fiboIdx = 0; }
                } else {
                    state = "FLAT"; martyStep = 0;
                }
            } else {
                bankroll -= bet;
                if (bet >= config.stopLoss) {
                    state = "FLAT";
                } else {
                    if (state === "FLAT") { state = "MARTY"; martyStep = 1; }
                    else if (state === "MARTY") { 
                        martyStep++; 
                        if (martyStep > 12) { state = "FIBO"; fiboIdx = 0; }
                    }
                    else if (state === "FIBO") { fiboIdx++; }
                }
            }

            if (bankroll > peakBr) peakBr = bankroll;
            let dd = peakBr - bankroll;
            if (dd > sessionState.overallMaxDrawdown) sessionState.overallMaxDrawdown = dd;
            if (bet > sessionState.overallMaxBet) sessionState.overallMaxBet = bet;

            if (bankroll <= 0) return { status: "BUST", profit: bankroll - initialBr };
            if (bankroll - initialBr >= target) return { status: "WIN", profit: bankroll - initialBr };
        }
    }

    function handleSessionResult(res) {
        if (res.status === "WIN") {
            addLog(`‚úÖ REAL WIN: +${res.profit.toFixed(2)}`, "status-win");
            sessionState.totalLossAccumulated = 0;
            sessionState.currentConsecutiveBusts = 0;
            sessionState.consecutiveVirtualLosses = 0;
        } else {
            addLog(`‚ùå REAL BUST: ${res.profit.toFixed(2)}`, "status-loss");
            sessionState.totalLossAccumulated += Math.abs(res.profit);
            sessionState.currentConsecutiveBusts++;
            if (sessionState.currentConsecutiveBusts > sessionState.maxConsecutiveBusts) {
                sessionState.maxConsecutiveBusts = sessionState.currentConsecutiveBusts;
            }
        }
    }

    function updateStats() {
        document.getElementById('stat_sessions').innerText = sessionState.totalRealSessions;
        document.getElementById('stat_max_bet').innerText = sessionState.overallMaxBet.toLocaleString();
        document.getElementById('stat_max_mdd').innerText = sessionState.overallMaxDrawdown.toLocaleString();
        document.getElementById('stat_max_busts').innerText = sessionState.maxConsecutiveBusts;
    }

    // --- Manual Input Logic ---
    let manualSessionActive = false;
    function processManual(result) {
        addLog(`Manual Input: ${result} received. (Logic to be integrated with state)`);
        // ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Manual ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏•‡∏≠‡∏à‡∏¥‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö runSingleSession 
        // ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Loop ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö Event ‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ó‡∏ô
    }

</script>
</body>
</html>
