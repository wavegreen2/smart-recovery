<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baccarat Recovery System - Pro</title>
    <style>
        body { font-family: 'Inter', sans-serif; background: #1a1a1a; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; }
        
        /* Dashboard สั่งการ */
        .next-bet-panel { 
            background: linear-gradient(135deg, #2c3e50, #000000);
            padding: 25px; border-radius: 15px; text-align: center;
            border: 2px solid #3498db; margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.3);
        }
        .bet-label { font-size: 1.2rem; color: #bdc3c7; margin-bottom: 10px; }
        .bet-info { font-size: 3.5rem; font-weight: 800; margin: 10px 0; letter-spacing: 2px; }
        .mode-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; text-transform: uppercase; }
        .mode-virtual { background: #f1c40f; color: #000; }
        .mode-real { background: #e74c3c; color: #fff; animation: pulse 2s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: #252525; padding: 20px; border-radius: 10px; border: 1px solid #333; }
        h3 { margin-top: 0; color: #3498db; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        label { display: block; margin: 10px 0 5px; font-size: 0.85rem; color: #aaa; }
        input, select { width: 100%; padding: 10px; background: #111; border: 1px solid #444; color: #fff; border-radius: 5px; box-sizing: border-box; }
        
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; padding: 10px; background: #1e1e1e; border-radius: 5px; }
        .stat-val { font-weight: bold; color: #2ecc71; }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .btn-p { background: #2980b9; color: white; }
        .btn-b { background: #c0392b; color: white; }
        .btn-t { background: #27ae60; color: white; }
        .btn-reset { background: #555; color: white; flex: 0.5; }
        button:hover { transform: translateY(-2px); filter: brightness(1.2); }

        #log-area { margin-top: 20px; background: #000; color: #0f0; padding: 15px; height: 250px; overflow-y: auto; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 0.8rem; border: 1px solid #333; }
        .log-win { color: #2ecc71; }
        .log-loss { color: #e74c3c; }
        .log-v { color: #f1c40f; }
    </style>
</head>
<body>

<div class="container">
    <div class="next-bet-panel">
        <div id="mode-badge" class="mode-badge mode-virtual">VIRTUAL MODE</div>
        <div class="bet-label">NEXT HAND PREDICTION</div>
        <div id="next-bet-display" class="bet-info">WAITING...</div>
        <div style="color: #888;">Session Hand: <span id="hand-count">0</span> | Target: <span id="session-target">0.01</span></div>
    </div>
    
    <div class="grid">
        <div class="card">
            <h3>Strategy Settings</h3>
            <label>Side Preference:</label>
            <select id="sidePreference" onchange="updateNextBet()">
                <option value="PLAYER">PLAYER</option>
                <option value="BANKER">BANKER</option>
            </select>
            <label>Unit Size (เงินตั้งต้น):</label>
            <input type="number" id="unitSize" value="10.0" onchange="updateNextBet()">
            <label>Martingale Multiplier:</label>
            <input type="number" id="martyMult" value="2.0" onchange="updateNextBet()">
            <label>Fibonacci Multiplier:</label>
            <input type="number" id="fiboMult" value="1000000.0" onchange="updateNextBet()">
        </div>

        <div class="card">
            <h3>Account Stats</h3>
            <div class="stat-row">
                <span>Total Accumulated Profit:</span>
                <span id="stat-profit" class="stat-val">0.0000</span>
            </div>
            <div class="stat-row">
                <span>Current Bankroll:</span>
                <span id="stat-br" class="stat-val">0.00</span>
            </div>
            <div class="stat-row">
                <span>Max Bet Encountered:</span>
                <span id="stat-maxbet" class="stat-val">0.00</span>
            </div>
            <label>Virtual Loss Trigger (รอแตกกี่รอบ):</label>
            <input type="number" id="vLossTrigger" value="1" onchange="updateNextBet()">
        </div>
    </div>

    <div class="btn-group">
        <button class="btn-p" onclick="processResult('P')">P (PLAYER)</button>
        <button class="btn-b" onclick="processResult('B')">B (BANKER)</button>
        <button class="btn-t" onclick="processResult('T')">T (TIE)</button>
        <button class="btn-reset" onclick="resetAll()">RESET</button>
    </div>

    <div id="log-area">>> System Ready. Waiting for first input...</div>
</div>

<script>
// --- Logic Core ---
function getFibo(n) {
    if (n <= 0) return 1;
    if (n === 1) return 1;
    let a = 1, b = 1;
    for (let i = 2; i <= n; i++) {
        let temp = b; b = a + b; a = temp;
    }
    return b;
}

let state = {
    totalProfit: 0,
    currentSessionBR: 0,
    currentSessionTarget: 0,
    vLossCount: 0,
    // Session State
    br: 0,
    peak: 0,
    betState: "FLAT",
    martyStep: 0,
    fiboIdx: 0,
    handIdx: 0,
    hasLostSincePeak: false,
    initialBR: 0,
    isInitialized: false
};

function getConfig() {
    return {
        unit: parseFloat(document.getElementById('unitSize').value),
        marty: parseFloat(document.getElementById('martyMult').value),
        fibo: parseFloat(document.getElementById('fiboMult').value),
        vTrigger: parseInt(document.getElementById('vLossTrigger').value),
        side: document.getElementById('sidePreference').value,
        baseInc: 0.01,
        stopLoss: 1000000.0
    };
}

function calculateNextBet() {
    const cfg = getConfig();
    if (!state.isInitialized) {
        state.br = state.totalProfit + 20.0; // Starting default
        state.initialBR = state.br;
        state.peak = state.br;
        state.currentSessionTarget = cfg.baseInc;
        state.isInitialized = true;
    }

    let drawdown = state.peak - state.br;
    if (drawdown >= cfg.stopLoss) {
        state.betState = "FLAT"; state.martyStep = 0; state.fiboIdx = 0;
    }

    let bet = 0;
    if (state.betState === "FLAT") {
        bet = (drawdown > 0 && state.hasLostSincePeak) ? 
              Math.max(Math.ceil(drawdown / 4), cfg.unit) : cfg.unit;
    } else if (state.betState === "MARTY") {
        bet = cfg.unit * Math.pow(cfg.marty, state.martyStep);
    } else if (state.betState === "FIBO") {
        bet = getFibo(state.fiboIdx) * cfg.fibo;
    }

    // Limit by target
    let sessionProfit = state.br - state.initialBR;
    let remain = state.currentSessionTarget - sessionProfit;
    if (state.betState !== "FLAT") {
        bet = Math.min(bet, (drawdown + cfg.unit));
    }
    if (bet > remain && remain > 0) bet = Math.max(cfg.unit, remain);
    if (bet > cfg.stopLoss) bet = cfg.stopLoss;

    return bet;
}

function updateNextBet() {
    const cfg = getConfig();
    const nextAmount = calculateNextBet();
    const isVirtual = state.vLossCount < cfg.vTrigger;
    
    const display = document.getElementById('next-bet-display');
    const badge = document.getElementById('mode-badge');
    
    display.innerHTML = `${cfg.side} <span style="color:#2ecc71">${nextAmount.toLocaleString()}</span>`;
    
    if (isVirtual) {
        badge.innerText = `VIRTUAL MODE (Waiting for Bust: ${state.vLossCount}/${cfg.vTrigger})`;
        badge.className = "mode-badge mode-virtual";
    } else {
        badge.innerText = `REAL BETTING MODE`;
        badge.className = "mode-badge mode-real";
    }
    
    document.getElementById('hand-count').innerText = state.handIdx + 1;
    document.getElementById('session-target').innerText = state.currentSessionTarget.toFixed(2);
    document.getElementById('stat-profit').innerText = state.totalProfit.toFixed(4);
    document.getElementById('stat-br').innerText = state.br.toLocaleString();
}

function processResult(res) {
    if (res === 'T') {
        log(`[Hand ${state.handIdx+1}] TIE - Skip`, 'log-v');
        return;
    }

    const cfg = getConfig();
    const bet = calculateNextBet();
    const isVirtual = state.vLossCount < cfg.vTrigger;
    const isWin = (res === cfg.side[0]);
    const payout = (cfg.side === 'BANKER') ? 0.95 : 1.0;

    // Apply Result
    state.handIdx++;
    if (isWin) {
        state.br += (bet * payout);
        log(`Hand ${state.handIdx}: ✅ WIN | Bet: ${bet} | BR: ${state.br.toFixed(2)}`, 'log-win');
        if (state.betState === "FIBO") {
            state.fiboIdx = Math.max(-1, state.fiboIdx - 2);
            if (state.fiboIdx < 0) { state.betState = "FLAT"; state.fiboIdx = 0; }
        } else {
            if (state.br >= state.peak) state.hasLostSincePeak = false;
            state.betState = "FLAT"; state.martyStep = 0;
        }
    } else {
        state.br -= bet;
        state.hasLostSincePeak = true;
        log(`Hand ${state.handIdx}: ❌ LOSS | Bet: ${bet} | BR: ${state.br.toFixed(2)}`, 'log-loss');
        if (bet >= cfg.stopLoss) {
            state.betState = "FLAT"; state.martyStep = 0;
        } else {
            if (state.betState === "FLAT") { state.betState = "MARTY"; state.martyStep = 1; }
            else if (state.betState === "MARTY") {
                state.martyStep++;
                if (state.martyStep > 12) { state.betState = "FIBO"; state.fiboIdx = 0; }
            } else if (state.betState === "FIBO") { state.fiboIdx++; }
        }
    }

    if (state.br > state.peak) state.peak = state.br;

    // Check Session End
    let sessionProfit = state.br - state.initialBR;
    if (state.br <= 0 || sessionProfit >= state.currentSessionTarget) {
        const status = state.br <= 0 ? "BUST" : "WIN";
        if (isVirtual) {
            if (status === "BUST") state.vLossCount++;
            else state.vLossCount = 0;
            log(`--- Virtual Session End: ${status} ---`, 'log-v');
        } else {
            state.totalProfit += sessionProfit;
            if (status === "WIN") {
                state.currentSessionTarget = cfg.baseInc;
                state.br = state.totalProfit + 20.0;
            } else {
                state.currentSessionTarget = Math.abs(state.totalProfit) + cfg.baseInc;
                state.br = state.currentSessionTarget * 1.5;
            }
            state.vLossCount = 0;
            log(`--- REAL Session End: ${status} | Total: ${state.totalProfit.toFixed(4)} ---`, 'log-win');
        }
        // Reset Session
        state.handIdx = 0;
        state.initialBR = state.br;
        state.peak = state.br;
        state.betState = "FLAT";
        state.martyStep = 0;
        state.fiboIdx = 0;
    }

    updateNextBet();
}

function log(msg, cls) {
    const l = document.getElementById('log-area');
    l.innerHTML = `<div class="${cls}">${msg}</div>` + l.innerHTML;
}

function resetAll() {
    if(!confirm("Reset?")) return;
    location.reload();
}

// Start Init
window.onload = updateNextBet;
</script>
</body>
</html>
