// --- UI & Utility Functions ---

    let undoStack = [];
    function saveState() {
        // à¸šà¸±à¸™à¸—à¸¶à¸ Snapshot à¸‚à¸­à¸‡ state à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸à¹ˆà¸­à¸™à¸ˆà¸°à¸¡à¸µà¸à¸²à¸£à¸à¸”à¸›à¸¸à¹ˆà¸¡
        undoStack.push(JSON.stringify(state)); 
        if (undoStack.length > 20) undoStack.shift(); // à¹€à¸à¹‡à¸šà¸¢à¹‰à¸­à¸™à¸«à¸¥à¸±à¸‡à¹„à¸”à¹‰ 20 à¸•à¸²
    }

    function undo() {
        if (undoStack.length > 0) {
            // à¸”à¸¶à¸‡à¸ªà¸–à¸²à¸™à¸°à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸ˆà¸²à¸ Stack à¸à¸¥à¸±à¸šà¸¡à¸²à¹€à¸›à¹‡à¸™ state à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™
            const prevState = JSON.parse(undoStack.pop());
            state = prevState; 
            
            // à¸­à¸±à¸›à¹€à¸”à¸•à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸—à¸±à¸™à¸—à¸µ
            updateUI();
        } else {
            alert("No more history to undo");
        }
    }

    function processResult(res) {
        const cfg = getSettings();
        
        // 1. à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸–à¸²à¸™à¸° "à¸à¹ˆà¸­à¸™à¸à¸”" à¸¥à¸‡à¹ƒà¸™ Stack
        saveState();

        // 2. Handle Tie (à¹€à¸ªà¸¡à¸­à¹„à¸¡à¹ˆà¸¡à¸µà¸œà¸¥à¸•à¹ˆà¸­à¹€à¸‡à¸´à¸™à¹à¸¥à¸°à¸£à¸­à¸šà¹„à¸¡à¹‰)
        if (res === 'T') {
            state.history.push('T');
            updateUI();
            return;
        }

        // 3. à¸„à¸³à¸™à¸§à¸“à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ
        let betSide = document.getElementById('rec_side').innerText.charAt(0);
        let isWin = (res === betSide);
        let betAmount = state.currentBet;

        if (state.mode === 'VIRTUAL') {
            if (res === SIDE_PREF) {
                state.vWins++;
            } else {
                state.vWins = 0;
            }

            if (state.vWins >= cfg.trigger) {
                state.mode = 'REAL';
                state.realStep = 0;
                state.sessionStartNet = state.net;
            }
        } 
        else if (state.mode === 'REAL') {
            if (isWin) {
                state.net += betAmount * (betSide === 'B' ? 0.95 : 1.0);
                
                if (state.net >= cfg.unit || state.net >= (state.sessionStartNet + cfg.unit)) {
                    state.mode = 'VIRTUAL';
                    state.vWins = 0;
                    alert(`ðŸŽ‰ SESSION WIN! Net: ${state.net.toFixed(0)}`);
                } else {
                    state.realStep = 0; 
                }
            } else {
                state.net -= betAmount;
                state.realStep++;

                if (state.realStep >= cfg.stopLossSteps) {
                    state.mode = 'VIRTUAL';
                    state.vWins = 0;
                    alert(`ðŸ›‘ STOP LOSS TRIGGERED! Net: ${state.net.toFixed(0)}`);
                }
            }
        }

        // à¹€à¸žà¸´à¹ˆà¸¡à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¸¥à¸‡à¹ƒà¸™à¸›à¸£à¸°à¸§à¸±à¸•à¸´
        state.history.push(res);
        updateUI();
    }
