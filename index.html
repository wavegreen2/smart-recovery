<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Recovery Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; font-family: 'Kanit', sans-serif; }
        .main-card { border: none; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .bet-next { font-size: 2.5rem; font-weight: bold; color: #2d3436; }
        .side-indicator { width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: white; margin: 0 auto; margin-bottom: 10px; }
        .side-p { background-color: #0984e3; } /* Blue */
        .side-b { background-color: #d63031; } /* Red */
        .side-n { background-color: #636e72; } /* Grey */
        .table-log { font-size: 0.9rem; }
        .stat-box { background: white; padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #eee; }
    </style>
</head>
<body>

<div class="container py-4">
    <h3 class="text-center mb-4">üìà Smart Recovery Controller</h3>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="card main-card p-4 mb-4">
                <div class="text-center">
                    <h5>‡∏ï‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏ó‡∏µ‡πà:</h5>
                    <div id="next_side_color" class="side-indicator side-n">?</div>
                    <div class="bet-next" id="next_bet_display">0.00</div>
                    <p class="text-muted" id="current_state_display">State: FLAT | Step: 0</p>
                </div>

                <hr>

                <div class="row g-2">
                    <div class="col-6">
                        <button onclick="submitResult('PLAYER')" class="btn btn-primary w-100 py-3 fw-bold">PLAYER ‡∏≠‡∏≠‡∏Å</button>
                    </div>
                    <div class="col-6">
                        <button onclick="submitResult('BANKER')" class="btn btn-danger w-100 py-3 fw-bold">BANKER ‡∏≠‡∏≠‡∏Å</button>
                    </div>
                </div>
                <button onclick="resetSystem()" class="btn btn-link btn-sm text-secondary mt-3">Reset ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>

            <div class="card main-card p-4">
                <h6>Settings</h6>
                <div class="row g-2">
                    <div class="col-6">
                        <label class="small">Unit Size</label>
                        <input type="number" id="unit_size" class="form-control" value="10" onchange="updateUI()">
                    </div>
                    <div class="col-6">
                        <label class="small">Target Profit</label>
                        <input type="number" id="target_profit" class="form-control" value="100">
                    </div>
                    <div class="col-12 mt-2">
                        <label class="small">Side Preference</label>
                        <select id="side_pref" class="form-select" onchange="updateUI()">
                            <option value="PLAYER">‡∏ï‡∏≤‡∏° PLAYER ‡∏ï‡∏•‡∏≠‡∏î</option>
                            <option value="BANKER">‡∏ï‡∏≤‡∏° BANKER ‡∏ï‡∏•‡∏≠‡∏î</option>
                            <option value="RANDOM">‡∏™‡∏•‡∏±‡∏ö‡∏ù‡∏±‡πà‡∏á (Random)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="row g-3 mb-4">
                <div class="col-4">
                    <div class="stat-box">
                        <small class="text-muted">‡∏Å‡∏≥‡πÑ‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</small>
                        <h4 id="stat_profit" class="text-success">0.00</h4>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-box">
                        <small class="text-muted">Max Drawdown</small>
                        <h4 id="stat_mdd" class="text-danger">0.00</h4>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-box">
                        <small class="text-muted">‡∏ó‡∏∏‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</small>
                        <h4 id="stat_br">0.00</h4>
                    </div>
                </div>
            </div>

            <div class="card main-card overflow-hidden">
                <div class="card-header bg-white fw-bold">History Log</div>
                <div class="table-responsive" style="max-height: 450px;">
                    <table class="table table-hover table-log mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Side</th>
                                <th>Bet</th>
                                <th>Result</th>
                                <th>Profit</th>
                                <th>State</th>
                            </tr>
                        </thead>
                        <tbody id="history_body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// --- Core Logic State ---
let state = {
    bankroll: 0,
    peak_bankroll: 0,
    current_profit: 0,
    max_drawdown: 0,
    
    current_state: "FLAT", // FLAT, MARTY, FIBO
    marty_step: 0,
    fibo_idx: 0,
    has_lost_since_peak: false,
    
    history: []
};

function getFibo(n) {
    if (n <= 0) return 1;
    if (n === 1) return 1;
    let a = 1, b = 1;
    for (let i = 2; i <= n; i++) {
        let temp = a + b;
        a = b; b = temp;
    }
    return b;
}

function calculateNextBet() {
    const unit_size = parseFloat(document.getElementById('unit_size').value);
    const marty_mult = 2;
    const fibo_mult = unit_size * 2; // ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì Fibo ‡∏ï‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°

    let raw_bet = unit_size;
    let current_drawdown = state.peak_bankroll - state.bankroll;

    if (state.current_state === "FLAT") {
        if (current_drawdown > 0 && state.has_lost_since_peak) {
            raw_bet = Math.max(Math.ceil(current_drawdown / 4), unit_size);
        } else {
            raw_bet = unit_size;
        }
    } else if (state.current_state === "MARTY") {
        raw_bet = unit_size * Math.pow(marty_mult, state.marty_step);
    } else if (state.current_state === "FIBO") {
        raw_bet = getFibo(state.fibo_idx) * fibo_mult;
    }

    // Recovery Limit
    if (state.current_state !== "FLAT") {
        let needed = current_drawdown + unit_size;
        raw_bet = Math.min(raw_bet, needed);
    }

    return raw_bet;
}

function submitResult(resultSide) {
    const unit_size = parseFloat(document.getElementById('unit_size').value);
    const side_pref = document.getElementById('side_pref').value;
    
    // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ù‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡πÑ‡∏õ (‡∏ï‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏à‡∏ö)
    let bet_side = side_pref;
    if (side_pref === "RANDOM") {
        // ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡∏ß‡πà‡∏≤‡∏ï‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏á‡∏≠‡∏∞‡πÑ‡∏£ (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏î‡∏π‡∏à‡∏≤‡∏Å History ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
        bet_side = Math.random() < 0.5 ? "PLAYER" : "BANKER";
    }

    const bet_amount = calculateNextBet();
    const is_win = (bet_side === resultSide);
    
    // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô
    let profit_loss = 0;
    if (is_win) {
        let payout = (bet_side === "BANKER") ? 0.95 : 1.0;
        profit_loss = bet_amount * payout;
        state.bankroll += profit_loss;
    } else {
        profit_loss = -bet_amount;
        state.bankroll += profit_loss;
        state.has_lost_since_peak = true;
    }

    // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Python)
    if (is_win) {
        if (state.current_state === "FIBO") {
            state.fibo_idx = Math.max(-1, state.fibo_idx - 2);
            if (state.fibo_idx < 0) { state.current_state = "FLAT"; state.fibo_idx = 0; }
        } else {
            state.current_state = "FLAT";
            state.marty_step = 0;
            if (state.bankroll >= state.peak_bankroll) state.has_lost_since_peak = false;
        }
    } else {
        if (state.current_state === "FLAT") {
            state.current_state = "MARTY";
            state.marty_step = 1;
        } else if (state.current_state === "MARTY") {
            state.marty_step++;
            if (state.marty_step > 12) { state.current_state = "FIBO"; state.fibo_idx = 0; }
        } else if (state.current_state === "FIBO") {
            state.fibo_idx++;
        }
    }

    // Peak & Drawdown
    state.peak_bankroll = Math.max(state.peak_bankroll, state.bankroll);
    state.max_drawdown = Math.max(state.max_drawdown, state.peak_bankroll - state.bankroll);

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
    state.history.unshift({
        round: state.history.length + 1,
        side: bet_side,
        bet: bet_amount,
        result: is_win ? "WIN" : "LOSS",
        pl: profit_loss,
        state: state.current_state
    });

    updateUI();
}

function updateUI() {
    const next_bet = calculateNextBet();
    const side_pref = document.getElementById('side_pref').value;
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    document.getElementById('next_bet_display').innerText = next_bet.toLocaleString(undefined, {minimumFractionDigits: 2});
    document.getElementById('stat_profit').innerText = state.bankroll.toLocaleString(undefined, {minimumFractionDigits: 2});
    document.getElementById('stat_mdd').innerText = state.max_drawdown.toLocaleString(undefined, {minimumFractionDigits: 2});
    document.getElementById('stat_br').innerText = (state.max_drawdown + parseFloat(document.getElementById('unit_size').value)).toLocaleString();
    
    document.getElementById('current_state_display').innerText = `State: ${state.current_state} | Step/Idx: ${state.current_state === 'MARTY' ? state.marty_step : state.fibo_idx}`;

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ù‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏ó‡∏á
    const indicator = document.getElementById('next_side_color');
    indicator.innerText = side_pref === "RANDOM" ? "?" : side_pref[0];
    indicator.className = "side-indicator " + (side_pref === "PLAYER" ? "side-p" : (side_pref === "BANKER" ? "side-b" : "side-n"));

    // ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    const tbody = document.getElementById('history_body');
    tbody.innerHTML = state.history.map(h => `
        <tr>
            <td>${h.round}</td>
            <td><span class="badge ${h.side === 'PLAYER' ? 'bg-primary' : 'bg-danger'}">${h.side}</span></td>
            <td>${h.bet.toFixed(2)}</td>
            <td class="${h.result === 'WIN' ? 'text-success' : 'text-danger'} fw-bold">${h.result}</td>
            <td class="${h.pl >= 0 ? 'text-success' : 'text-danger'}">${h.pl >= 0 ? '+' : ''}${h.pl.toFixed(2)}</td>
            <td><small class="text-muted">${h.state}</small></td>
        </tr>
    `).join('');
}

function resetSystem() {
    if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
        state = { bankroll: 0, peak_bankroll: 0, current_profit: 0, max_drawdown: 0, current_state: "FLAT", marty_step: 0, fibo_idx: 0, has_lost_since_peak: false, history: [] };
        updateUI();
    }
}

// Initial Call
updateUI();
</script>

</body>
</html>
