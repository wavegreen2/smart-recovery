<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baccarat Strategy Simulator</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; padding: 20px; line-height: 1.6; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        label { font-weight: bold; display: block; margin-top: 10px; }
        input, textarea, select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 20px; }
        button:hover { background: #218838; }
        #manual-controls { display: none; background: #e9ecef; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center; }
        .btn-p { background: #007bff; }
        .btn-b { background: #dc3545; }
        .btn-t { background: #6c757d; }
        #log { margin-top: 20px; max-height: 400px; overflow-y: auto; background: #222; color: #0f0; padding: 15px; font-family: monospace; font-size: 12px; border-radius: 5px; }
        .summary { margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 5px; }
        .status-virtual { color: #ffc107; font-weight: bold; }
        .status-real { color: #28a745; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>üìä Baccarat Recovery Strategy</h2>
    
    <div class="grid">
        <div>
            <label>Mode</label>
            <select id="mode" onchange="toggleMode()">
                <option value="a">Auto (Data List)</option>
                <option value="m">Manual Input (Hand-by-Hand)</option>
            </select>

            <label>Initial Bankroll (Base)</label>
            <input type="number" id="base_bankroll" value="20.0" step="0.1">

            <label>Unit Size</label>
            <input type="number" id="unit_size" value="10.0">

            <label>Marty Multiplier</label>
            <input type="number" id="marty_mult" value="2.0" step="0.1">

            <label>Fibo Multiplier</label>
            <input type="number" id="fibo_mult" value="100000.0">
        </div>
        <div>
            <label>Side Preference</label>
            <select id="side_preference">
                <option value="PLAYER">PLAYER</option>
                <option value="BANKER">BANKER</option>
            </select>

            <label>Virtual Loss Trigger</label>
            <input type="number" id="virtual_loss_trigger" value="2">

            <label>Stop Loss Threshold</label>
            <input type="number" id="stop_loss_threshold" value="1000000.0">

            <label>Rebate Rate (%)</label>
            <input type="number" id="rebate_rate" value="1" step="0.1">
        </div>
    </div>

    <div id="auto-input-section">
        <label>Raw Shoe Data (CSV format: ShoeNo, Result, Result...)</label>
        <textarea id="raw_data" rows="5">1,B,T,P,B,B,B,P,P,P,T,P,P,P,P,T,B,P,P,B,P,P,B,B,P,P,B,P,B,P,T,B,T,B,P,P,T,B,P,P,B,P,P,T,P,P,P,P,P,B,P,B,B,P,B,B,P,B,B,P,B,B,B,B,P,B,P,B,P,T,P,B,B,B,P,B,B,P,P,P
2,T,P,B,P,B,B,P,P,B,B,T,P,B,B,T,P,P,B,B,B,B,P,T,B,T,B,B,B,P,P,B,P,P,P,B,P,B,P,T,B,P,B,P,B,B,B,B,P,B,B,B,P,P,P,B,T,B,P,B,B,P,B,B,P,B,P,P,B,B,P,P,P,B,B,P,B,P,P,P,P,T</textarea>
    </div>

    <button id="startBtn" onclick="startSimulation()">Start Simulation</button>

    <div id="manual-controls">
        <h3 id="current-session-info">Waiting...</h3>
        <p>Current Bet: <strong id="next-bet-display">0.00</strong></p>
        <button class="btn-p" onclick="handleManual('P')">P</button>
        <button class="btn-b" onclick="handleManual('B')">B</button>
        <button class="btn-t" onclick="handleManual('T')">T</button>
        <button style="background:#333" onclick="resetSim()">Stop/Reset</button>
    </div>

    <div class="summary" id="summary">
        <strong>Summary:</strong> Total Real Sessions: 0 | Max Bet: 0 | Max Drawdown: 0
    </div>

    <div id="log"></div>
</div>

<script>
    // --- Global State ---
    let simState = {
        full_results: [],
        current_data_idx: 0,
        total_loss_accumulated: 0,
        base_target: 0.01,
        current_target: 0.01,
        current_bankroll: 20.0,
        overall_max_bet: 0,
        overall_max_drawdown: 0,
        max_consecutive_busts: 0,
        current_consecutive_busts: 0,
        consecutive_virtual_losses: 0,
        total_real_sessions: 0,
        is_running: false,
        
        // Single Session Variables
        s_bankroll: 0,
        s_peak: 0,
        s_state: "FLAT",
        s_marty_step: 0,
        s_fibo_idx: 0,
        s_max_drawdown: 0,
        s_max_bet: 0,
        s_has_lost: false,
        is_virtual: true
    };

    function getFibo(n) {
        if (n <= 0) return 1;
        if (n === 1) return 1;
        let a = 1, b = 1;
        for (let i = 2; i <= n; i++) {
            [a, b] = [b, a + b];
        }
        return b;
    }

    function toggleMode() {
        const mode = document.getElementById('mode').value;
        document.getElementById('auto-input-section').style.display = (mode === 'a') ? 'block' : 'none';
    }

    function log(msg) {
        const logDiv = document.getElementById('log');
        logDiv.innerHTML += msg + "<br>";
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function startSimulation() {
        const mode = document.getElementById('mode').value;
        simState.is_running = true;
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('log').innerHTML = "";
        
        // Reset Stats
        simState.total_real_sessions = 0;
        simState.total_loss_accumulated = 0;
        simState.current_data_idx = 0;
        simState.current_target = simState.base_target;
        simState.current_bankroll = parseFloat(document.getElementById('base_bankroll').value);
        simState.consecutive_virtual_losses = 0;

        if (mode === 'a') {
            const raw = document.getElementById('raw_data').value.trim();
            simState.full_results = [];
            raw.split('\n').forEach(line => {
                const parts = line.split(',').map(s => s.trim());
                simState.full_results.push(...parts.slice(1));
            });
            log(`--- Loaded ${simState.full_results.length} hands ---`);
            runAutoLoop();
        } else {
            document.getElementById('manual-controls').style.display = 'block';
            initNewSession();
        }
    }

    function initNewSession() {
        const vTrigger = parseInt(document.getElementById('virtual_loss_trigger').value);
        simState.is_virtual = simState.consecutive_virtual_losses < vTrigger;
        
        simState.s_bankroll = simState.current_bankroll;
        simState.s_peak = simState.s_bankroll;
        simState.s_state = "FLAT";
        simState.s_marty_step = 0;
        simState.s_fibo_idx = 0;
        simState.s_max_drawdown = 0;
        simState.s_max_bet = 0;
        simState.s_has_lost = false;

        const sessionLabel = simState.is_virtual ? 
            `<span class="status-virtual">üß™ VIRTUAL (${simState.consecutive_virtual_losses}/${vTrigger})</span>` : 
            `<span class="status-real">üí∞ REAL SESSION ${simState.total_real_sessions + 1}</span>`;
        
        document.getElementById('current-session-info').innerHTML = sessionLabel;
        log(`<br>--- ${sessionLabel} START ---`);
        
        calculateNextBet();
    }

    function calculateNextBet() {
        const unit = parseFloat(document.getElementById('unit_size').value);
        const mMult = parseFloat(document.getElementById('marty_mult').value);
        const fMult = parseFloat(document.getElementById('fibo_mult').value);
        const stopLoss = parseFloat(document.getElementById('stop_loss_threshold').value);

        let currentDrawdown = simState.s_peak - simState.s_bankroll;
        if (currentDrawdown >= stopLoss) {
            simState.s_state = "FLAT"; simState.s_marty_step = 0; simState.s_fibo_idx = 0;
        }

        let rawBet = 0;
        if (simState.s_state === "FLAT") {
            if (currentDrawdown > 0 && simState.s_has_lost) {
                rawBet = Math.max(Math.ceil(currentDrawdown / 4), unit);
            } else {
                rawBet = unit;
            }
        } else if (simState.s_state === "MARTY") {
            rawBet = unit * Math.pow(mMult, simState.s_marty_step);
        } else if (simState.s_state === "FIBO") {
            rawBet = getFibo(simState.s_fibo_idx) * fMult;
        }

        let needed = currentDrawdown + unit;
        let bet = (simState.s_state !== "FLAT") ? Math.min(rawBet, needed) : rawBet;

        let isMaxBetActive = false;
        if (bet >= stopLoss) {
            bet = stopLoss;
            isMaxBetActive = true;
        }

        let currentProfit = simState.s_bankroll - simState.current_bankroll;
        let remaining = simState.current_target - currentProfit;
        if (bet > remaining && remaining > 0) {
            bet = Math.max(unit, remaining);
        }

        simState.current_bet = bet;
        simState.is_max_bet_active = isMaxBetActive;
        document.getElementById('next-bet-display').innerText = bet.toLocaleString(undefined, {minimumFractionDigits: 2});
        return bet;
    }

    function processResult(actualResult) {
        if (actualResult === 'T') {
            log(`&nbsp;&nbsp;&nbsp;[Hand ${simState.current_data_idx}] TIE - Skip`);
            return "CONTINUE";
        }

        const pref = document.getElementById('side_preference').value;
        const rebateRate = parseFloat(document.getElementById('rebate_rate').value) / 100;
        const isWin = (actualResult === 'P' && pref === 'PLAYER') || (actualResult === 'B' && pref === 'BANKER');
        const payout = (pref === 'BANKER') ? 0.95 : 1.0;
        
        const bet = simState.current_bet;
        if (bet > simState.s_max_bet) simState.s_max_bet = bet;

        // Apply Rebate
        simState.s_bankroll += (bet * rebateRate);

        if (isWin) {
            simState.s_bankroll += (bet * payout);
            log(`&nbsp;&nbsp;&nbsp;‚úÖ WIN | Bet: ${bet.toFixed(2)} | BR: ${simState.s_bankroll.toFixed(2)}`);
            if (simState.s_state === "FIBO") {
                simState.s_fibo_idx = Math.max(-1, simState.s_fibo_idx - 2);
                if (simState.s_fibo_idx < 0) { simState.s_state = "FLAT"; simState.s_fibo_idx = 0; }
            } else {
                if (simState.s_bankroll >= simState.s_peak) simState.s_has_lost = false;
                simState.s_state = "FLAT"; simState.s_marty_step = 0;
            }
        } else {
            simState.s_bankroll -= bet;
            simState.s_has_lost = true;
            log(`&nbsp;&nbsp;&nbsp;‚ùå LOSS | Bet: ${bet.toFixed(2)} | BR: ${simState.s_bankroll.toFixed(2)}`);
            if (simState.is_max_bet_active) {
                simState.s_state = "FLAT"; simState.s_marty_step = 0; simState.s_fibo_idx = 0;
            } else {
                if (simState.s_state === "FLAT") {
                    simState.s_state = "MARTY"; simState.s_marty_step = 1;
                } else if (simState.s_state === "MARTY") {
                    simState.s_marty_step++;
                    if (simState.s_marty_step > 12) { simState.s_state = "FIBO"; simState.s_fibo_idx = 0; }
                } else if (simState.s_state === "FIBO") {
                    simState.s_fibo_idx++;
                }
            }
        }

        if (simState.s_bankroll > simState.s_peak) simState.s_peak = simState.s_bankroll;
        let dd = simState.s_peak - simState.s_bankroll;
        if (dd > simState.s_max_drawdown) simState.s_max_drawdown = dd;

        // Check Session End
        if (simState.s_bankroll <= 0) return "BUST";
        if ((simState.s_bankroll - simState.current_bankroll) >= simState.current_target) return "WIN";
        
        return "CONTINUE";
    }

    function endSession(status) {
        const profit = simState.s_bankroll - simState.current_bankroll;
        
        if (simState.is_virtual) {
            if (status === "BUST") {
                simState.consecutive_virtual_losses++;
                log(`üìâ Virtual Result: BUST (${simState.consecutive_virtual_losses})`);
            } else {
                simState.consecutive_virtual_losses = 0;
                log(`üîÑ Virtual Result: WIN (Resetting)`);
            }
        } else {
            simState.total_real_sessions++;
            if (simState.s_max_bet > simState.overall_max_bet) simState.overall_max_bet = simState.s_max_bet;
            if (simState.s_max_drawdown > simState.overall_max_drawdown) simState.overall_max_drawdown = simState.s_max_drawdown;

            if (status === "WIN") {
                log(`‚úÖ <strong>REAL WIN: Profit +${profit.toFixed(2)}</strong>`);
                simState.total_loss_accumulated = 0;
                simState.current_target = simState.base_target;
                simState.current_bankroll = parseFloat(document.getElementById('base_bankroll').value);
                simState.current_consecutive_busts = 0;
                simState.consecutive_virtual_losses = 0;
            } else {
                log(`‚ùå <strong>REAL BUST: Loss ${profit.toFixed(2)}</strong>`);
                simState.total_loss_accumulated += Math.abs(profit);
                simState.current_target = simState.total_loss_accumulated + simState.base_target;
                simState.current_bankroll = simState.current_target * 1.5;
                simState.current_consecutive_busts++;
                if (simState.current_consecutive_busts > simState.max_consecutive_busts) simState.max_consecutive_busts = simState.current_consecutive_busts;
                log(`‚ö†Ô∏è RECOVERY | Accumulated Loss: ${simState.total_loss_accumulated.toFixed(2)}`);
            }
        }
        updateSummary();
    }

    function runAutoLoop() {
        while (simState.current_data_idx < simState.full_results.length) {
            initNewSession();
            let status = "CONTINUE";
            while (status === "CONTINUE" && simState.current_data_idx < simState.full_results.length) {
                calculateNextBet();
                const res = simState.full_results[simState.current_data_idx++];
                status = processResult(res);
            }
            if (status === "CONTINUE") break; // Out of data
            endSession(status);
        }
        log("<br>üèÅ <strong>SIMULATION COMPLETE</strong>");
        resetSim();
    }

    function handleManual(res) {
        const status = processResult(res);
        if (status === "CONTINUE") {
            calculateNextBet();
        } else {
            endSession(status);
            initNewSession();
        }
    }

    function updateSummary() {
        document.getElementById('summary').innerHTML = `
            <strong>üìä SUMMARY REPORT:</strong><br>
            üéØ Total Real Sessions: ${simState.total_real_sessions} | 
            üî• Max Consecutive Busts: ${simState.max_consecutive_busts}<br>
            üí∏ Overall Max Bet: ${simState.overall_max_bet.toLocaleString()} | 
            üìâ Overall Max Drawdown: ${simState.overall_max_drawdown.toLocaleString()}
        `;
    }

    function resetSim() {
        simState.is_running = false;
        document.getElementById('startBtn').style.display = 'inline-block';
        document.getElementById('manual-controls').style.display = 'none';
    }
</script>

</body>
</html>
