<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baccarat Strategy Simulator (Fixed)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; margin: 20px; color: #333; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .config-box, .manual-box { border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #fafafa; }
        label { display: block; margin: 10px 0 5px; font-weight: bold; font-size: 0.9em; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-start { background: #27ae60; color: white; }
        .btn-start:hover { background: #219150; }
        .btn-manual { background: #3498db; color: white; margin-top: 5px; flex: 1; }
        .results { margin-top: 20px; background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 8px; font-family: 'Courier New', Courier, monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .status-win { color: #2ecc71; }
        .status-loss { color: #e74c3c; }
        .status-virtual { color: #f1c40f; }
    </style>
</head>
<body>

<div class="container">
    <h2>üìä Baccarat Strategy Simulator</h2>
    
    <div class="grid">
        <div class="config-box">
            <h3>‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Configuration)</h3>
            <label>Mode:</label>
            <select id="mode" onchange="toggleManualBox()">
                <option value="r">Random Simulation</option>
                <option value="m">Manual Input (‡∏ó‡∏µ‡∏•‡∏∞‡∏ï‡∏≤)</option>
                <option value="a">Auto Data (‡∏à‡∏≤‡∏Å‡∏î‡∏¥‡∏ö‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á)</option>
            </select>

            <label>Side Preference:</label>
            <select id="side_preference">
                <option value="PLAYER">PLAYER</option>
                <option value="BANKER">BANKER</option>
            </select>

            <label>Unit Size:</label>
            <input type="number" id="unit_size" value="10">
            
            <label>Virtual Loss Trigger:</label>
            <input type="number" id="virtual_loss_trigger" value="2">

            <label>Marty Mult:</label>
            <input type="number" id="marty_mult" value="2">
            
            <label>Stop Loss Threshold:</label>
            <input type="number" id="stop_loss_threshold" value="10000">
        </div>

        <div class="config-box">
            <h3>üìà ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î</h3>
            <label>Max Real Sessions:</label>
            <input type="number" id="max_sessions" value="10">
            
            <label>Raw Data (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î Auto):</label>
            <textarea id="raw_data" style="width:100%; height:80px; font-size: 10px;">P,B,T,P,B,B,B,P,P,P,T,P,B,P</textarea>

            <button class="btn-start" onclick="startSimulation()">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà / Reset</button>
        </div>
    </div>

    <div id="manual_input_box" class="manual-box" style="display:none;">
        <h3>üéÆ Manual Control</h3>
        <p>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á:</p>
        <div style="display:flex; gap:10px;">
            <button class="btn-manual" style="background:#2980b9" onclick="handleManual('P')">PLAYER (P)</button>
            <button class="btn-manual" style="background:#c0392b" onclick="handleManual('B')">BANKER (B)</button>
            <button class="btn-manual" style="background:#27ae60" onclick="handleManual('T')">TIE (T)</button>
        </div>
    </div>

    <div class="results" id="log_output">Log ‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...</div>
</div>

<script>
    let simState = {
        running: false,
        full_results: [],
        current_data_idx: 0,
        total_real_sessions: 0,
        consecutive_virtual_losses: 0,
        total_loss_accumulated: 0,
        current_target: 1, 
        current_bankroll: 20.0,
        max_bet_encountered: 0,
        max_drawdown: 0,
        max_consecutive_busts: 0,
        current_consecutive_busts: 0,
        session_active: false,
        s_bankroll: 0,
        s_peak: 0,
        s_state: "FLAT",
        s_marty_step: 0,
        s_has_lost: false,
        s_initial_br: 0
    };

    function toggleManualBox() {
        const mode = document.getElementById('mode').value;
        document.getElementById('manual_input_box').style.display = (mode === 'm') ? 'block' : 'none';
    }

    function log(msg, className = "") {
        const div = document.getElementById('log_output');
        div.innerHTML += `<div class="${className}">${msg}</div>`;
        div.scrollTop = div.scrollHeight;
    }

    function startSimulation() {
        const mode = document.getElementById('mode').value;
        document.getElementById('log_output').innerHTML = "<b>--- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà ---</b><br>";
        
        simState.running = true;
        simState.total_real_sessions = 0;
        simState.total_loss_accumulated = 0;
        simState.current_data_idx = 0;
        simState.consecutive_virtual_losses = 0;
        simState.current_target = parseFloat(document.getElementById('unit_size').value);
        simState.current_bankroll = simState.current_target * 5; 
        simState.max_bet_encountered = 0;
        simState.max_drawdown = 0;
        simState.max_consecutive_busts = 0;
        simState.current_consecutive_busts = 0;

        if (mode === 'a') {
            const raw = document.getElementById('raw_data').value;
            simState.full_results = raw.split(',').map(x => x.trim().toUpperCase()).filter(x => ['P','B','T'].includes(x));
        }

        runNextSession();
    }

    function runNextSession() {
        const mode = document.getElementById('mode').value;
        const max_sessions = parseInt(document.getElementById('max_sessions').value);
        const virtual_trigger = parseInt(document.getElementById('virtual_loss_trigger').value);

        if (mode !== 'm' && simState.total_real_sessions >= max_sessions) {
            finishReport();
            return;
        }

        const isVirtual = simState.consecutive_virtual_losses < virtual_trigger;
        if (isVirtual) {
            log(`--- üß™ VIRTUAL SESSION (Wait: ${simState.consecutive_virtual_losses}/${virtual_trigger}) ---`, "status-virtual");
        } else {
            log(`--- üí∞ REAL SESSION ${simState.total_real_sessions + 1} ---`, "status-win");
        }

        setupSession(isVirtual);

        if (mode === 'r' || mode === 'a') {
            autoProcess();
        }
    }

    function setupSession(isVirtual) {
        simState.session_active = true;
        simState.s_initial_br = simState.current_bankroll;
        simState.s_bankroll = simState.current_bankroll;
        simState.s_peak = simState.current_bankroll;
        simState.s_state = "FLAT";
        simState.s_marty_step = 0;
        simState.s_has_lost = false;
    }

    function calculateBet() {
        const unit = parseFloat(document.getElementById('unit_size').value);
        const marty_mult = parseFloat(document.getElementById('marty_mult').value);
        const stop_loss = parseFloat(document.getElementById('stop_loss_threshold').value);
        
        let bet = unit;
        if (simState.s_state === "MARTY") {
            bet = unit * Math.pow(marty_mult, simState.s_marty_step);
        }

        // ‡∏Å‡∏±‡∏ô Bet ‡πÄ‡∏Å‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô Session ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô Stop loss
        bet = Math.min(bet, simState.s_bankroll, stop_loss);
        return bet;
    }

    function handleManual(res) {
        if (!simState.session_active || !simState.running) return;
        processHand(res);
    }

    function processHand(actual_result) {
        if (actual_result === 'T') {
            log(`üëâ Hand ${simState.current_data_idx + 1}: TIE - Skip`);
            return;
        }

        const side = document.getElementById('side_preference').value;
        const bet = calculateBet();
        if (bet > simState.max_bet_encountered) simState.max_bet_encountered = bet;

        const isWin = (actual_result === side[0]); // P or B
        const payout = (side === 'BANKER') ? 0.95 : 1.0;

        if (isWin) {
            simState.s_bankroll += (bet * payout);
            log(`   Bet: ${bet.toFixed(2)} | ‚úÖ WIN | BR: ${simState.s_bankroll.toFixed(2)}`, "status-win");
            simState.s_state = "FLAT";
            simState.s_marty_step = 0;
        } else {
            simState.s_bankroll -= bet;
            log(`   Bet: ${bet.toFixed(2)} | ‚ùå LOSS | BR: ${simState.s_bankroll.toFixed(2)}`, "status-loss");
            simState.s_state = "MARTY";
            simState.s_marty_step++;
        }

        if (simState.s_bankroll > simState.s_peak) simState.s_peak = simState.s_bankroll;
        let dd = simState.s_peak - simState.s_bankroll;
        if (dd > simState.max_drawdown) simState.max_drawdown = dd;

        simState.current_data_idx++;

        // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏ö Session
        let profit = simState.s_bankroll - simState.s_initial_br;
        if (simState.s_bankroll < parseFloat(document.getElementById('unit_size').value) || profit >= simState.current_target) {
            finalizeSession(simState.s_bankroll <= 1 ? "BUST" : "WIN", profit);
        }
    }

    function finalizeSession(status, profit) {
        simState.session_active = false;
        const virtual_trigger = parseInt(document.getElementById('virtual_loss_trigger').value);
        const isVirtual = simState.consecutive_virtual_losses < virtual_trigger;

        if (isVirtual) {
            if (status === "BUST") simState.consecutive_virtual_losses++;
            else simState.consecutive_virtual_losses = 0;
            log(`üìä Virtual Result: ${status}`);
        } else {
            simState.total_real_sessions++;
            if (status === "WIN") {
                log(`üí∞ REAL WIN: +${profit.toFixed(2)}`, "status-win");
                simState.total_loss_accumulated = 0;
                simState.current_target = parseFloat(document.getElementById('unit_size').value);
                simState.current_bankroll = simState.current_target * 5;
                simState.consecutive_virtual_losses = 0;
            } else {
                log(`üíÄ REAL BUST: ${profit.toFixed(2)}`, "status-loss");
                simState.total_loss_accumulated += Math.abs(profit);
                simState.current_target = simState.total_loss_accumulated + 1;
                simState.current_bankroll = simState.current_target * 2;
                log(`‚ö†Ô∏è RECOVERY: Target Next ${simState.current_target.toFixed(2)}`);
            }
        }
        
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î Manual ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡πÉ‡∏´‡πâ‡∏£‡∏≠ user ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÄ‡∏≠‡∏á
        if (simState.running) {
            setTimeout(runNextSession, 100);
        }
    }

    function autoProcess() {
        const mode = document.getElementById('mode').value;
        while (simState.session_active && simState.running) {
            let res = "";
            if (mode === 'r') {
                res = (Math.random() > 0.5) ? "B" : "P";
            } else if (mode === 'a') {
                if (simState.current_data_idx >= simState.full_results.length) {
                    simState.running = false;
                    break;
                }
                res = simState.full_results[simState.current_data_idx];
            } else {
                break; // Manual stop loop
            }
            processHand(res);
        }
    }

    function finishReport() {
        simState.running = false;
        log("<br><b>" + "=".repeat(20) + " SUMMARY " + "=".repeat(20) + "</b>");
        log(`Sessions: ${simState.total_real_sessions} | Max Bet: ${simState.max_bet_encountered.toFixed(2)} | Max DD: ${simState.max_drawdown.toFixed(2)}`);
    }
</script>

</body>
</html>
