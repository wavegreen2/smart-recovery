<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Recovery Baccarat Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-container::-webkit-scrollbar { width: 6px; }
        .log-container::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        .status-win { color: #10b981; font-weight: bold; }
        .status-loss { color: #ef4444; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="mb-8 border-b border-gray-700 pb-4">
            <h1 class="text-3xl font-bold text-blue-400">üöÄ Smart Recovery Simulator</h1>
            <p class="text-gray-400">Hybrid Strategy: Marty + Fibonacci + Virtual Wait</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-xl font-semibold mb-4 flex items-center">‚öôÔ∏è Configuration</h2>
                <div class="space-y-4 text-sm">
                    <div>
                        <label class="block text-gray-400">Initial Bankroll</label>
                        <input type="number" id="initial_bankroll" value="1000000" class="w-full bg-gray-700 p-2 rounded border border-gray-600 outline-none focus:border-blue-500">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-400">Unit Size</label>
                            <input type="number" id="unit_size" value="5" class="w-full bg-gray-700 p-2 rounded border border-gray-600">
                        </div>
                        <div>
                            <label class="block text-gray-400">Chip Size</label>
                            <input type="number" id="chip_size" value="5" class="w-full bg-gray-700 p-2 rounded border border-gray-600">
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-400">Side Preference</label>
                        <select id="side_preference" class="w-full bg-gray-700 p-2 rounded border border-gray-600">
                            <option value="PLAYER">PLAYER</option>
                            <option value="BANKER">BANKER</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-400">Virtual Win Trigger</label>
                            <input type="number" id="v_trigger" value="5" class="w-full bg-gray-700 p-2 rounded border border-gray-600">
                        </div>
                        <div>
                            <label class="block text-gray-400">Stop Cons. Loss</label>
                            <input type="number" id="stop_loss_limit" value="4" class="w-full bg-gray-700 p-2 rounded border border-gray-600">
                        </div>
                    </div>
                    <hr class="border-gray-700">
                    <div>
                        <label class="block text-gray-400">Simulation Mode</label>
                        <select id="sim_mode" class="w-full bg-gray-700 p-2 rounded border border-gray-600" onchange="toggleRandomInput()">
                            <option value="DATA">Use Data String</option>
                            <option value="RANDOM">Random Probability</option>
                        </select>
                    </div>
                    <div id="random_count_box" class="hidden">
                        <label class="block text-gray-400">Number of Hands</label>
                        <input type="number" id="random_hands" value="1000" class="w-full bg-gray-700 p-2 rounded border border-gray-600">
                    </div>
                </div>
                <button onclick="startSimulation()" class="w-full mt-6 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition">
                    ‚ñ∂ RUN SIMULATION
                </button>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gray-800 p-4 rounded-xl border-l-4 border-green-500">
                        <p class="text-gray-400 text-xs uppercase">Net Profit</p>
                        <p id="stat_profit" class="text-2xl font-mono text-green-400">0.00</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-xl border-l-4 border-red-500">
                        <p class="text-gray-400 text-xs uppercase">Max Drawdown</p>
                        <p id="stat_mdd" class="text-2xl font-mono text-red-400">0.00</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-xl border-l-4 border-yellow-500">
                        <p class="text-gray-400 text-xs uppercase">Max Bet</p>
                        <p id="stat_maxbet" class="text-2xl font-mono text-yellow-400">0.00</p>
                    </div>
                </div>

                <div class="bg-black rounded-xl p-4 shadow-inner border border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-mono text-gray-500 uppercase italic">Session Execution Log</span>
                        <span id="session_count" class="text-xs text-blue-400 font-bold">Total Sessions: 0</span>
                    </div>
                    <div id="log" class="log-container h-96 overflow-y-auto font-mono text-sm space-y-1">
                        <p class="text-gray-600">Waiting for simulation...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-8 bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h2 class="text-gray-400 text-sm mb-2">Source Data (Format: ID,Result,Result,...)</h2>
            <textarea id="raw_data" rows="3" class="w-full bg-gray-900 p-3 rounded border border-gray-700 font-mono text-xs text-gray-400">
1,B,P,B,P,P,T,P,P,P,P,B,P,B,T,B,B,P,T,P,T,B,B,B,B,B,B,P,B,P,T,P,B,T,P,T,B,P,B,B,T,B,P,B,P,P,P,B,T,B,T,P,B,P,T,B,T,B,P,B,B,B,P,B,P,B,P,B,B,B,B,T,B,T,B,P,P,P,B,P,B,B
2,B,T,B,P,B,B,B,P,P,P,B,P,B,B,B,B,B,P,B,B,P,B,P,B,P,P,P,P,P,T,B,P,B,T,B,P,B,B,P,P,B,B,T,P,B,P,B,B,B,B,T,P,P,B,P,B,P,P,B,P,P,T,B,P,P,P,B,T,P,B,P,B,P,P,B,B,B,P,P
3,B,T,B,P,P,B,B,B,B,P,P,P,B,B,P,P,P,P,T,P,B,P,T,P,B,T,P,B,P,B,B,P,B,T,P,B,P,P,B,B,T,B,P,P,B,B,P,B,P,T,P,B,P,B,B,T,P,P,B,B,B,P,P,P,P,P,B,P,B,B,T,P,P,P,B,B,B,B,B,P,P,B,P</textarea>
        </div>
    </div>

    <script>
        // --- üß¨ CORE LOGIC ---
        
        function getFibo(n) {
            if (n <= 0) return 1;
            if (n === 1) return 1;
            let a = 1, b = 1;
            for (let i = 2; i <= n; i++) {
                let temp = b;
                b = a + b;
                a = temp;
            }
            return b;
        }

        function toggleRandomInput() {
            const mode = document.getElementById('sim_mode').value;
            document.getElementById('random_count_box').classList.toggle('hidden', mode !== 'RANDOM');
        }

        function appendLog(msg, type = '') {
            const logBox = document.getElementById('log');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = msg;
            logBox.appendChild(div);
            logBox.scrollTop = logBox.scrollHeight;
        }

        async function runSingleSession(results, startIdx, targetProfit, unitSize, config, isVirtual) {
            let bankroll = config.current_br;
            let initialBR = config.current_br;
            let peakBR = initialBR;
            let maxBet = 0;
            let maxDD = 0;
            let state = "FLAT";
            let martStep = 0;
            let fiboIdx = 0;
            let consecutiveLoss = 0;
            let currentIdx = startIdx;
            let hasLostSincePeak = false;

            while (true) {
                let currentDD = peakBR - bankroll;
                
                // 1. Determine Bet
                let rawBet = 0;
                if (state === "FLAT") {
                    rawBet = (currentDD > 0 && hasLostSincePeak) ? Math.ceil(currentDD / 4) : unitSize;
                } else if (state === "MARTY") {
                    rawBet = unitSize * Math.pow(config.marty_mult, martStep);
                } else if (state === "FIBO") {
                    rawBet = getFibo(fiboIdx) * config.fibo_mult;
                }

                let bet = (state !== "FLAT") ? Math.min(rawBet, currentDD + unitSize) : rawBet;
                bet = Math.ceil(bet / config.chip_size) * config.chip_size;

                // Adjust for Target
                let currentProfit = bankroll - initialBR;
                let remaining = targetProfit - currentProfit;
                if (remaining > 0 && bet > remaining) bet = Math.max(unitSize, Math.ceil(remaining / config.chip_size) * config.chip_size);
                
                if (bet > maxBet) maxBet = bet;

                // 2. Get Result
                let result = "";
                if (config.is_random) {
                    result = Math.random() < 0.5068 ? "B" : "P";
                    currentIdx++;
                } else {
                    if (currentIdx >= results.length) return { status: "OUT_OF_DATA", profit: bankroll - initialBR, mdd: maxDD, mbet: maxBet, nextIdx: currentIdx };
                    result = results[currentIdx++];
                }

                if (result === "T") continue;

                let isWin = (result === config.side_pref[0]);
                if (isVirtual) return { status: isWin ? "WIN" : "LOSS", nextIdx: currentIdx };

                // 3. Update
                if (isWin) {
                    let payout = config.side_pref === "BANKER" ? 0.95 : 1.0;
                    bankroll += (bet * payout);
                    consecutiveLoss = 0;
                    if (state === "FIBO") {
                        fiboIdx = Math.max(-1, fiboIdx - 2);
                        if (fiboIdx < 0) { state = "FLAT"; fiboIdx = 0; }
                    } else {
                        if (bankroll >= peakBR) hasLostSincePeak = false;
                        state = "FLAT"; martStep = 0;
                    }
                } else {
                    bankroll -= bet;
                    consecutiveLoss++;
                    hasLostSincePeak = true;
                    if (state === "FLAT") { state = "MARTY"; martStep = 1; }
                    else if (state === "MARTY") {
                        martStep++;
                        if (martStep > config.marty_limit) { state = "FIBO"; fiboIdx = 0; }
                    } else if (state === "FIBO") {
                        fiboIdx++;
                    }
                }

                if (bankroll > peakBR) peakBR = bankroll;
                let dd = peakBR - bankroll;
                if (dd > maxDD) maxDD = dd;

                if (consecutiveLoss >= config.stop_loss_limit) return { status: "STOP_LOSS", profit: bankroll - initialBR, mdd: maxDD, mbet: maxBet, nextIdx: currentIdx };
                if ((bankroll - initialBR) >= targetProfit) return { status: "WIN", profit: bankroll - initialBR, mdd: maxDD, mbet: maxBet, nextIdx: currentIdx };
            }
        }

        async function startSimulation() {
            // UI Reset
            document.getElementById('log').innerHTML = "";
            let totalNetProfit = 0;
            let globalMaxBet = 0;
            let globalMaxDD = 0;
            let peakNet = 0;
            let currentIdx = 0;
            let vWins = 0;
            let sessionNo = 0;

            const config = {
                initial_br: parseFloat(document.getElementById('initial_bankroll').value),
                unit_size: parseFloat(document.getElementById('unit_size').value),
                chip_size: parseFloat(document.getElementById('chip_size').value),
                side_pref: document.getElementById('side_preference').value,
                v_trigger: parseInt(document.getElementById('v_trigger').value),
                stop_loss_limit: parseInt(document.getElementById('stop_loss_limit').value),
                mode: document.getElementById('sim_mode').value,
                marty_mult: 2.0,
                marty_limit: 12,
                fibo_mult: 1.0,
                recovery_ratio: 5
            };
            config.is_random = config.mode === "RANDOM";

            let fullResults = [];
            if (!config.is_random) {
                const lines = document.getElementById('raw_data').value.trim().split('\n');
                lines.forEach(line => {
                    const parts = line.split(',').slice(1).map(s => s.trim());
                    fullResults.push(...parts);
                });
            }
            const limit = config.is_random ? parseInt(document.getElementById('random_hands').value) : fullResults.length;

            while (currentIdx < limit) {
                // Virtual Wait
                if (vWins < config.v_trigger) {
                    config.current_br = 100000;
                    let vRes = await runSingleSession(fullResults, currentIdx, 999999, config.unit_size, config, true);
                    currentIdx = vRes.nextIdx;
                    vWins = (vRes.status === "WIN") ? vWins + 1 : 0;
                    continue;
                }

                // Real Session
                sessionNo++;
                config.current_br = config.initial_br + totalNetProfit;
                let target = totalNetProfit >= 0 ? config.unit_size : Math.abs(totalNetProfit) + config.unit_size;
                
                let activeUnit = config.unit_size;
                if (totalNetProfit < 0) {
                    activeUnit = Math.max(config.unit_size, target / config.recovery_ratio);
                }

                let res = await runSingleSession(fullResults, currentIdx, target, activeUnit, config, false);
                currentIdx = res.nextIdx;
                totalNetProfit += res.profit;
                vWins = 0;

                if (res.mbet > globalMaxBet) globalMaxBet = res.mbet;
                if (totalNetProfit > peakNet) peakNet = totalNetProfit;
                let currentGlobalDD = peakNet - totalNetProfit;
                if (currentGlobalDD > globalMaxDD) globalMaxDD = currentGlobalDD;

                appendLog(`[Sess ${sessionNo}] <span class="status-${res.status.toLowerCase()}">${res.status}</span> | Net: ${totalNetProfit.toFixed(2)}`);
                
                // Update Stats
                document.getElementById('stat_profit').innerText = totalNetProfit.toLocaleString();
                document.getElementById('stat_mdd').innerText = globalMaxDD.toLocaleString();
                document.getElementById('stat_maxbet').innerText = globalMaxBet.toLocaleString();
                document.getElementById('session_count').innerText = `Total Sessions: ${sessionNo}`;

                if (res.status === "OUT_OF_DATA") break;
                
                // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ UI ‡πÑ‡∏°‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ô‡∏≤‡∏ô‡πÜ
                if (sessionNo % 10 === 0) await new Promise(r => setTimeout(r, 1));
            }
            appendLog("<hr class='border-gray-700 my-2'>üèÅ FINISHED");
        }
    </script>
</body>
</html>
