<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Recovery - Banker Only (Decimal Fixed)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 10px; font-size: 13px; margin: 0; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { margin: 0 0 10px 0; font-size: 1.2em; text-align: center; color: #2c3e50; }
        .config-area { background: #34495e; color: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; align-items: end; }
        .config-group { display: flex; flex-direction: column; gap: 3px; }
        .config-group label { font-size: 0.8em; opacity: 0.9; }
        .config-group input { padding: 5px 8px; border-radius: 4px; border: none; font-size: 1em; }
        .btn-start { background: #27ae60; color: white; padding: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; height: 32px; }
        .manual-section { background: #ebedef; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px dashed #7f8c8d; }
        .manual-input { width: 100%; height: 60px; padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; box-sizing: border-box; resize: vertical; }
        .btn-process { background: #8e44ad; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-top: 5px; font-weight: bold; }
        .stats-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 10px; }
        .stat-card { background: #eee; padding: 5px; border-radius: 4px; text-align: center; border-bottom: 2px solid #ccc; }
        .stat-card span { display: block; font-size: 1.1em; font-weight: bold; color: #2c3e50; }
        .main-layout { display: grid; grid-template-columns: 1fr 300px; gap: 10px; margin-bottom: 10px; }
        .road-container { width: 100%; overflow-x: auto; background: #fff; border: 1px solid #ccc; border-radius: 6px; }
        .big-road td { width: 25px; height: 25px; border: 1px solid #eee; text-align: center; }
        .circle { width: 20px; height: 20px; line-height: 20px; border-radius: 50%; color: white; margin: auto; font-weight: bold; font-size: 10px; }
        .circle-P { background: #3498db; }
        .circle-B { background: #e74c3c; }
        .bet-display { text-align: center; padding: 10px; background: #fdf2f2; border-radius: 8px; border: 2px solid #e74c3c; }
        .bet-display .amount { font-size: 2em; color: #e74c3c; font-weight: bold; }
        .controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; padding: 10px; background: #ecf0f1; border-radius: 8px; }
        .btn-res { padding: 15px 25px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; font-size: 1.1em; }
        .btn-res-p { background: #3498db; color: white; }
        .btn-res-b { background: #e74c3c; color: white; }
        .btn-undo { background: #95a5a6; color: white; }
        .table-container { max-height: 350px; overflow-y: auto; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        th { background: #34495e; color: white; padding: 8px; position: sticky; top: 0; }
        td { padding: 6px; border: 1px solid #ddd; text-align: center; }
        .target-reached { background: #f1c40f !important; }
    </style>
</head>
<body>

<div class="container">
    <h2>Smart Recovery (BANKER ONLY - อัตราจ่าย 0.95)</h2>

    <div class="config-area">
        <div class="config-group"><label>ทุน (Bankroll)</label><input type="number" id="input-bankroll" value="100000"></div>
        <div class="config-group"><label>ขั้นต่ำ (Unit)</label><input type="number" id="input-unit" value="1"></div>
        <div class="config-group"><label>เป้ากำไร (Target)</label><input type="number" id="input-target" value="0.01"></div>
        <button class="btn-start" onclick="initSystem()">เริ่ม/รีเซ็ตระบบ</button>
    </div>

    <div class="manual-section">
        <label><b>ใส่ข้อมูลผลลัพธ์ (Bulk Input):</b></label>
        <textarea id="bulk-input" class="manual-input" placeholder="ตัวอย่าง: B,P,B,B..."></textarea>
        <button class="btn-process" onclick="processBulk()">ประมวลผลข้อมูลชุดนี้</button>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card">Bankroll <span id="stat-bankroll">0.00</span></div>
        <div class="stat-card">Total Profit <span id="stat-profit">0.00</span></div>
        <div class="stat-card">Rebate <span id="stat-total-rebate">0.00</span></div>
        <div class="stat-card" style="background: #fff3cd;">ATH Profit <span id="stat-ath">0.00</span></div>
        <div class="stat-card" style="background: #fde8e8;">Max Bet <span id="stat-max-bet">0</span></div> 
        <div class="stat-card">Target <span id="stat-target-val">0</span></div>
        <div class="stat-card">State <span id="stat-state">FLAT</span></div>
    </div>

    <div class="main-layout">
        <div class="road-container">
            <table class="big-road"><tbody id="road-body"></tbody></table>
        </div>
        <div class="bet-display" id="bet-card">
            <h2 id="bet-title">แทง <span style="color:#e74c3c">BANKER</span>:</h2>
            <div class="amount" id="next-bet-display">0</div>
            <p style="margin:0; font-size:0.8em;">Status: <span id="current-state-text">WAITING</span></p>
        </div>
    </div>

    <div class="controls">
        <button class="btn-res btn-res-p" id="btn-res-p" onclick="processResult('P')" disabled>PLAYER</button>
        <button class="btn-res btn-res-b" id="btn-res-b" onclick="processResult('B')" disabled>BANKER</button>
        <button class="btn-undo" id="btn-undo" onclick="undo()" disabled>Undo</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ไม้ที่</th>
                    <th>ผลออก</th>
                    <th>สถานะ</th>
                    <th>เดิมพัน</th>
                    <th>กำไร/ขาดทุนรอบนี้</th>
                    <th>กำไรสะสม (+Rebate)</th>
                </tr>
            </thead>
            <tbody id="log-body"></tbody>
        </table>
    </div>
</div>

<script>
    let initialBankroll, unitSize, profitTarget;
    let bankroll, peakBankroll, totalRebate, maxBetEver, currentTotalProfit;
    let state, martyStep, hasLostSincePeak, isTargetReached, isStarted = false;
    let history = [];

    function initSystem() {
        initialBankroll = parseFloat(document.getElementById('input-bankroll').value);
        unitSize = parseFloat(document.getElementById('input-unit').value);
        profitTarget = parseFloat(document.getElementById('input-target').value);
        
        bankroll = initialBankroll;
        peakBankroll = initialBankroll;
        totalRebate = 0;
        currentTotalProfit = 0;
        maxBetEver = 0;
        state = "FLAT";
        martyStep = 0;
        hasLostSincePeak = false;
        isTargetReached = false;
        isStarted = true;
        history = [];

        enableControls(true);
        updateUI();
    }

    function calculateBet() {
        if(!isStarted || isTargetReached) return 0;
        let currentDrawdown = peakBankroll - bankroll;
        let rawBet = unitSize;

        if (state === "FLAT") {
            if (currentDrawdown > 0 && hasLostSincePeak) {
                rawBet = Math.ceil(currentDrawdown / 4); 
                rawBet = Math.max(rawBet, unitSize);
            }
        } else if (state === "MARTY") {
            rawBet = unitSize * Math.pow(0, martyStep);
        }
        return Math.ceil(rawBet);
    }

    function processResult(tableWinner) {
        if(!isStarted || isTargetReached) return;

        const betAmount = calculateBet();
        if (betAmount > maxBetEver) maxBetEver = betAmount;

        const isWin = (tableWinner === 'B');
        const rebate = betAmount * 0.01; 
        
        // คำนวณ Net: ชนะได้ 0.95 + Rebate | แพ้เสีย 1.00 - Rebate
        const winLossThisRound = isWin ? (betAmount * 0.95) + rebate : -(betAmount - rebate);
        
        bankroll += winLossThisRound;
        totalRebate += rebate;
        currentTotalProfit = bankroll - initialBankroll;

        history.push({
            winner: tableWinner,
            bet: betAmount,
            isWin: isWin,
            thisRoundNet: winLossThisRound,
            cumulativeProfit: currentTotalProfit, 
            stateBefore: state,
            martyStepBefore: martyStep
        });

        if (isWin) {
            state = "FLAT";
            martyStep = 0;
            if (bankroll >= peakBankroll) hasLostSincePeak = false;
        } else {
            state = "MARTY";
            martyStep++;
            hasLostSincePeak = true;
        }

        if (bankroll > peakBankroll) peakBankroll = bankroll;

        updateUI();

        if (currentTotalProfit >= profitTarget) {
            triggerTargetReached();
        }
    }

    function updateUI() {
        // อัปเดต Stats เป็นทศนิยม 2 ตำแหน่ง
        document.getElementById('stat-bankroll').innerText = bankroll.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('stat-profit').innerText = currentTotalProfit.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('stat-total-rebate').innerText = totalRebate.toFixed(2);
        document.getElementById('stat-ath').innerText = (peakBankroll - initialBankroll).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('stat-max-bet').innerText = Math.ceil(maxBetEver).toLocaleString();
        document.getElementById('stat-target-val').innerText = profitTarget.toLocaleString();
        document.getElementById('stat-state').innerText = state;
        
        let next = calculateBet();
        document.getElementById('next-bet-display').innerText = isTargetReached ? "DONE!" : next.toLocaleString();
        document.getElementById('current-state-text').innerText = state + (state === "MARTY" ? ` (Step ${martyStep + 1})` : "");

        const tbody = document.getElementById('log-body');
        tbody.innerHTML = "";
        
        history.slice().reverse().forEach((h, idx) => {
            let row = tbody.insertRow();
            let realIdx = history.length - idx;
            row.innerHTML = `
                <td>${realIdx}</td>
                <td style="color:${h.winner==='P'?'blue':'red'}"><b>${h.winner}</b></td>
                <td>${h.stateBefore}</td>
                <td>${h.bet.toLocaleString()}</td>
                <td style="color:${h.isWin?'green':'red'}">${h.thisRoundNet > 0 ? '+' : ''}${h.thisRoundNet.toFixed(2)}</td>
                <td style="background:#f9f9f9; font-weight:bold;">${h.cumulativeProfit.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            `;
        });
        renderBigRoad();
    }

    function processBulk() {
        if(!isStarted) return;
        const inputStr = document.getElementById('bulk-input').value;
        if(!inputStr) return;
        const results = inputStr.split(',').map(s => s.trim().toUpperCase());
        results.forEach(res => {
            if ((res === 'B' || res === 'P') && !isTargetReached) processResult(res);
        });
        document.getElementById('bulk-input').value = "";
    }

    function undo() {
        if (history.length === 0) return;
        history.pop();
        
        // Recalculate
        bankroll = initialBankroll;
        totalRebate = 0;
        peakBankroll = initialBankroll;
        state = "FLAT";
        martyStep = 0;
        hasLostSincePeak = false;
        maxBetEver = 0;
        
        let oldHistory = [...history];
        history = [];
        oldHistory.forEach(h => {
            processResult(h.winner);
        });
        
        isTargetReached = false;
        document.getElementById('bet-card').classList.remove('target-reached');
        enableControls(true);
        updateUI();
    }

    function triggerTargetReached() {
        isTargetReached = true;
        document.getElementById('bet-card').classList.add('target-reached');
        enableControls(false);
    }

    function enableControls(s) {
        document.getElementById('btn-res-p').disabled = !s;
        document.getElementById('btn-res-b').disabled = !s;
        document.getElementById('btn-undo').disabled = !s;
    }

    function renderBigRoad() {
        const roadBody = document.getElementById('road-body');
        roadBody.innerHTML = "";
        let matrix = Array.from({ length: 6 }, () => Array(60).fill(null));
        let col = 0, row = 0, lastWinner = null;

        history.forEach((h) => {
            let winner = h.winner;
            if (lastWinner === null) { matrix[row][col] = winner; }
            else if (winner === lastWinner) {
                if (row < 5 && !matrix[row + 1][col]) row++; else col++;
                matrix[row][col] = winner;
            } else {
                row = 0; col++;
                while (col < 60 && matrix[row][col]) col++;
                if(col < 60) matrix[row][col] = winner;
            }
            lastWinner = winner;
        });

        for (let r = 0; r < 6; r++) {
            const tr = document.createElement('tr');
            for (let c = 0; c < 60; c++) {
                const td = document.createElement('td');
                if (matrix[r][c]) {
                    const circle = document.createElement('div');
                    circle.className = `circle circle-${matrix[r][c]}`;
                    circle.innerText = matrix[r][c];
                    td.appendChild(circle);
                }
                tr.appendChild(td);
            }
            roadBody.appendChild(tr);
        }
    }
</script>
</body>
</html>
